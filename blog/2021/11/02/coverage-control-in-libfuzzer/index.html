
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://github.com/cyruscyliu/cyruscyliu.github.io/blog/2021/11/02/coverage-control-in-libfuzzer/">
      
      
        <link rel="prev" href="../../../10/27/introduction-to-bhyve/">
      
      
        <link rel="next" href="../../../12/13/a-brief-summary-of-cs-725/">
      
      
      <link rel="icon" href="../../../../../logo.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.18">
    
    
      
        <title>Coverage Control in libFuzzer - Qiang Liu - System Security | Problem Solver</title>
      
    
    
      <link rel="stylesheet" href="../../../../../assets/stylesheets/main.7e37652d.min.css">
      
        
        <link rel="stylesheet" href="../../../../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../../../../stylesheets/extra.css">
    
    <script>__md_scope=new URL("../../../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      
  


  
  

<script id="__analytics">function __md_analytics(){function e(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],e("js",new Date),e("config","G-KWJ9PWFFMZ"),document.addEventListener("DOMContentLoaded",(function(){document.forms.search&&document.forms.search.query.addEventListener("blur",(function(){this.value&&e("event","search",{search_term:this.value})}));document$.subscribe((function(){var t=document.forms.feedback;if(void 0!==t)for(var a of t.querySelectorAll("[type=submit]"))a.addEventListener("click",(function(a){a.preventDefault();var n=document.location.pathname,d=this.getAttribute("data-md-value");e("event","feedback",{page:n,data:d}),t.firstElementChild.disabled=!0;var r=t.querySelector(".md-feedback__note [data-md-value='"+d+"']");r&&(r.hidden=!1)})),t.hidden=!1})),location$.subscribe((function(t){e("config","G-KWJ9PWFFMZ",{page_path:t.pathname})}))}));var t=document.createElement("script");t.async=!0,t.src="https://www.googletagmanager.com/gtag/js?id=G-KWJ9PWFFMZ",document.getElementById("__analytics").insertAdjacentElement("afterEnd",t)}</script>
  
    <script>"undefined"!=typeof __md_analytics&&__md_analytics()</script>
  

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="white" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#coverage-control-in-libfuzzer" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../../../.." title="Qiang Liu - System Security | Problem Solver" class="md-header__button md-logo" aria-label="Qiang Liu - System Security | Problem Solver" data-md-component="logo">
      
  <img src="../../../../../logo.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Qiang Liu - System Security | Problem Solver
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Coverage Control in libFuzzer
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="white" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m17.75 4.09-2.53 1.94.91 3.06-2.63-1.81-2.63 1.81.91-3.06-2.53-1.94L12.44 4l1.06-3 1.06 3zm3.5 6.91-1.64 1.25.59 1.98-1.7-1.17-1.7 1.17.59-1.98L15.75 11l2.06-.05L18.5 9l.69 1.95zm-2.28 4.95c.83-.08 1.72 1.1 1.19 1.85-.32.45-.66.87-1.08 1.27C15.17 23 8.84 23 4.94 19.07c-3.91-3.9-3.91-10.24 0-14.14.4-.4.82-.76 1.27-1.08.75-.53 1.93.36 1.85 1.19-.27 2.86.69 5.83 2.89 8.02a9.96 9.96 0 0 0 8.02 2.89m-1.64 2.02a12.08 12.08 0 0 1-7.8-3.47c-2.17-2.19-3.33-5-3.49-7.82-2.81 3.14-2.7 7.96.31 10.98 3.02 3.01 7.84 3.12 10.98.31"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="black" data-md-color-accent="light-blue"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 7a5 5 0 0 1 5 5 5 5 0 0 1-5 5 5 5 0 0 1-5-5 5 5 0 0 1 5-5m0 2a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3m0-7 2.39 3.42C13.65 5.15 12.84 5 12 5s-1.65.15-2.39.42zM3.34 7l4.16-.35A7.2 7.2 0 0 0 5.94 8.5c-.44.74-.69 1.5-.83 2.29zm.02 10 1.76-3.77a7.131 7.131 0 0 0 2.38 4.14zM20.65 7l-1.77 3.79a7.02 7.02 0 0 0-2.38-4.15zm-.01 10-4.14.36c.59-.51 1.12-1.14 1.54-1.86.42-.73.69-1.5.83-2.29zM12 22l-2.41-3.44c.74.27 1.55.44 2.41.44.82 0 1.63-.17 2.37-.44z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
                
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" hidden>
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



  

<nav class="md-nav md-nav--primary md-nav--integrated" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../../../.." title="Qiang Liu - System Security | Problem Solver" class="md-nav__button md-logo" aria-label="Qiang Liu - System Security | Problem Solver" data-md-component="logo">
      
  <img src="../../../../../logo.png" alt="logo">

    </a>
    Qiang Liu - System Security | Problem Solver
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Home
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../projects/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Projects
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../services/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Services
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" checked>
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../../../" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    Blog
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_4" id="__nav_4_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            Blog
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../tags/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Tags
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_4_3" >
        
          
          <label class="md-nav__link" for="__nav_4_3" id="__nav_4_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Archive
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_3">
            <span class="md-nav__icon md-icon"></span>
            Archive
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../../archive/2025/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    2025
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../../archive/2024/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    2024
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../../archive/2023/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    2023
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../../archive/2022/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    2022
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../../archive/2021/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    2021
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../../archive/2020/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    2020
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../../archive/2019/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    2019
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../../archive/2018/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    2018
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_4_4" >
        
          
          <label class="md-nav__link" for="__nav_4_4" id="__nav_4_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Categories
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_4">
            <span class="md-nav__icon md-icon"></span>
            Categories
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../../category/diary/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    diary
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../../category/how-to-do-research-series/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    how-to-do-research-series
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../../category/tech-notes/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    tech-notes
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          
  <div class="md-content md-content--post" data-md-component="content">
    <div class="md-sidebar md-sidebar--post" data-md-component="sidebar" data-md-type="navigation">
      <div class="md-sidebar__scrollwrap">
        <div class="md-sidebar__inner md-post">
          <nav class="md-nav md-nav--primary">
            <div class="md-post__back">
              <div class="md-nav__title md-nav__container">
                <a href="../../../../" class="md-nav__link">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
                  <span class="md-ellipsis">
                    Back to index
                  </span>
                </a>
              </div>
            </div>
            
            <ul class="md-post__meta md-nav__list">
              <li class="md-nav__item md-nav__item--section">
                <div class="md-post__title">
                  <span class="md-ellipsis">
                    Metadata
                  </span>
                </div>
                <nav class="md-nav">
                  <ul class="md-nav__list">
                    <li class="md-nav__item">
                      <div class="md-nav__link">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 19H5V8h14m-3-7v2H8V1H6v2H5c-1.11 0-2 .89-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V5a2 2 0 0 0-2-2h-1V1m-1 11h-5v5h5z"/></svg>
                        <time datetime="2021-11-02 00:00:00+00:00" class="md-ellipsis">November 2, 2021</time>
                      </div>
                    </li>
                    
                    
                      <li class="md-nav__item">
                        <div class="md-nav__link">
                          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9 3v15h3V3zm3 2 4 13 3-1-4-13zM5 5v13h3V5zM3 19v2h18v-2z"/></svg>
                          <span class="md-ellipsis">
                            in
                            
                              <a href="../../../../category/tech-notes/">tech-notes</a></span>
                        </div>
                      </li>
                    
                    
                      
                      <li class="md-nav__item">
                        <div class="md-nav__link">
                          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 20a8 8 0 0 0 8-8 8 8 0 0 0-8-8 8 8 0 0 0-8 8 8 8 0 0 0 8 8m0-18a10 10 0 0 1 10 10 10 10 0 0 1-10 10C6.47 22 2 17.5 2 12A10 10 0 0 1 12 2m.5 5v5.25l4.5 2.67-.75 1.23L11 13V7z"/></svg>
                          <span class="md-ellipsis">
                            
                              13 min read
                            
                          </span>
                        </div>
                      </li>
                    
                  </ul>
                </nav>
              </li>
            </ul>
            
          </nav>
          
            

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#how-to-use-libfuzzer" class="md-nav__link">
    <span class="md-ellipsis">
      How to use libFuzzer?
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#how-to-compiler-llvm-project" class="md-nav__link">
    <span class="md-ellipsis">
      How to compiler LLVM project?
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#details-beneath-fsanitizefuzzer" class="md-nav__link">
    <span class="md-ellipsis">
      Details beneath -fsanitize=fuzzer
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#flow-of-instrumentations" class="md-nav__link">
    <span class="md-ellipsis">
      Flow of instrumentations
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#details-of-stubs" class="md-nav__link">
    <span class="md-ellipsis">
      Details of stubs
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Details of stubs">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#__sanitizer_cov_indir_call" class="md-nav__link">
    <span class="md-ellipsis">
      __sanitizer_cov_indir_call
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#__sanitizer_cov_trace_const_cmp1248" class="md-nav__link">
    <span class="md-ellipsis">
      __sanitizer_cov_trace_[const_]cmp[1|2|4|8]
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#__sanitizer_cov_trace_pc" class="md-nav__link">
    <span class="md-ellipsis">
      __sanitizer_cov_trace_pc
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#__sanitizer_cov_trace_pc_guard_init" class="md-nav__link">
    <span class="md-ellipsis">
      __sanitizer_cov_trace_pc_guard[_init]
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#__sanitizer_cov_8bipctableentryidxpc_guard" class="md-nav__link">
    <span class="md-ellipsis">
      __sanitizer_cov_8biPCTableEntryIdxpc_guard`.
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#__sanitizer_cov_bool_flag_init" class="md-nav__link">
    <span class="md-ellipsis">
      __sanitizer_cov_bool_flag_init
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#__sanitizer_cov_pcs_init" class="md-nav__link">
    <span class="md-ellipsis">
      __sanitizer_cov_pcs_init
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#a-brief-list-of-flag-stubs-and-information-sink-in-libfuzzer" class="md-nav__link">
    <span class="md-ellipsis">
      A brief list of (flag, stubs, and information sink in libFuzzer)
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#details-of-coverage-collection-algorithm-and-implementation" class="md-nav__link">
    <span class="md-ellipsis">
      Details of coverage collection algorithm and implementation
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Details of coverage collection algorithm and implementation">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#resetmaps" class="md-nav__link">
    <span class="md-ellipsis">
      ResetMaps
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#collectfeatures" class="md-nav__link">
    <span class="md-ellipsis">
      CollectFeatures
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#updateobservedpcs" class="md-nav__link">
    <span class="md-ellipsis">
      UpdateObservedPCs
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#libfuzzer-intercepts" class="md-nav__link">
    <span class="md-ellipsis">
      libFuzzer intercepts
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#conclusion" class="md-nav__link">
    <span class="md-ellipsis">
      Conclusion
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
          
        </div>
      </div>
    </div>
    <article class="md-content__inner md-typeset">
      
        
  




<h1 id="coverage-control-in-libfuzzer">Coverage Control in libFuzzer<a class="headerlink" href="#coverage-control-in-libfuzzer" title="Do what you think is right">#</a></h1>
<p>This article reveals how to control the coverage collection in libFuzzer.</p>
<!-- more -->

<h2 id="how-to-use-libfuzzer">How to use libFuzzer?<a class="headerlink" href="#how-to-use-libfuzzer" title="Do what you think is right">#</a></h2>
<p>To use libFuzzer, it is necessary to develop a fuzz target. Please refer to
<a href="https://llvm.org/docs/LibFuzzer.html#id14">this</a> and
<a href="https://llvm.org/docs/LibFuzzer.html#id23">this</a> to check how to develop a fuzz
target and how to compile it with Clang.</p>
<h2 id="how-to-compiler-llvm-project">How to compiler LLVM project?<a class="headerlink" href="#how-to-compiler-llvm-project" title="Do what you think is right">#</a></h2>
<p>Download llvm-project and compile like below. Please also refer to
<a href="https://llvm.org/docs/GettingStarted.html">this</a> and
<a href="https://clang.llvm.org/get_started.html">this</a>.</p>
<div class="highlight"><pre><span></span><code>git<span class="w"> </span>clone<span class="w"> </span>https://github.com/llvm/llvm-project.git<span class="w"> </span>--depth<span class="o">=</span><span class="m">1</span>
mkdir<span class="w"> </span>build<span class="p">;</span><span class="w"> </span><span class="nb">cd</span><span class="w"> </span>build
cmake<span class="w"> </span>-G<span class="w"> </span>Ninja<span class="w"> </span>-DLLVM_USE_LINKER<span class="o">=</span>gold<span class="w"> </span>-DLLVM_ENABLE_PROJECTS<span class="o">=</span><span class="s2">&quot;clang;compiler-rt&quot;</span><span class="w"> </span>-DLLVM_TARGETS_TO_BUILD<span class="o">=</span>X86<span class="w"> </span>-DLLVM_OPTIMIZED_TABLEGEN<span class="o">=</span>ON<span class="w"> </span>../llvm/
ninja<span class="w"> </span>clang<span class="w"> </span>compiler-rt
<span class="nb">export</span><span class="w"> </span><span class="nv">PATH</span><span class="o">=</span><span class="nv">$PWD</span>/bin:<span class="nv">$PATH</span>
</code></pre></div>
<h2 id="details-beneath-fsanitizefuzzer">Details beneath <code>-fsanitize=fuzzer</code><a class="headerlink" href="#details-beneath-fsanitizefuzzer" title="Do what you think is right">#</a></h2>
<p>As we all know, when compiling a program, a compiler will automatically expand
its compiler flags. If <code>-v</code> is enable, the compiler will show all flags.
Considering a very simple example: <code>clang -o foo -fsanitize=fuzzer foo.c</code>, the
full flags related to <code>-fsanitize</code> are in the following.</p>
<div class="highlight"><pre><span></span><code># SIMPLIFIED
&quot;$LLVM/bin/clang-13&quot; -cc1 \
   -triple x86_64-unknown-linux-gnu \
   -emit-obj \
   -target-cpu x86-64 -v \
   -fsanitize-coverage-type=1 -fsanitize-coverage-type=3 \
   -fsanitize-coverage-indirect-calls \
   -fsanitize-coverage-trace-cmp \
   -fsanitize-coverage-inline-8bit-counters \
   -fsanitize-coverage-pc-table \
   -fsanitize-coverage-stack-depth \
   -fsanitize-coverage-trace-state \
   -fsanitize=fuzzer,fuzzer-no-link \
   -o /tmp/main-d501e8.o -x c main.c
# SIMPLIFIED
&quot;/usr/local/bin/ld&quot; -z relro \
   --hash-style=gnu --eh-frame-hdr \
    -m elf_x86_64 \
    -dynamic-linker /lib64/ld-linux-x86-64.so.2 \
    -o main \
    $LLVM/lib/clang/13.0.0/lib/linux/libclang_rt.fuzzer-x86_64.a \
    $LLVM/lib/clang/13.0.0/lib/linux/libclang_rt.fuzzer_interceptors-x86_64.a \
    $LLVM/lib/clang/13.0.0/lib/linux/libclang_rt.ubsan_standalone-x86_64.a \
    --dynamic-list=$LLVM/lib/clang/13.0.0/lib/linux/libclang_rt.ubsan_standalone-x86_64.a.syms \
    /tmp/main-d501e8.o
</code></pre></div>
<p>It's <code>SanitizerArgs()</code> that parses SanCov and sanitizers flags. The path to it
is in the following.</p>
<div class="highlight"><pre><span></span><code> [#0] clang::driver::SanitizerArgs::SanitizerArgs()
 [#1] clang::driver::ToolChain::getSanitizerArgs() const()
 [#2] clang::driver::toolchains::Linux::isPIEDefault() const()
 [#3] clang::driver::tools::ParsePICArgs()
 [#4] clang::driver::tools::Clang::ConstructJob()
 [#5] clang::driver::Driver::BuildJobsForActionNoCache()
 [#6] clang::driver::Driver::BuildJobsForAction()
 [#7] clang::driver::Driver::BuildJobsForActionNoCache()
 [#8] clang::driver::Driver::BuildJobsForAction()
 [#9] clang::driver::Driver::BuildJobs()
[#10] clang::driver::Driver::BuildCompilation()
[#11] main()
</code></pre></div>
<p>In <code>SanitizerArgs()</code>, <code>parseArgValues</code> will parse six sanitizer related flags.
<code>parseArgValues</code> will invoke <code>parseSanitizerValue</code> defined in
<code>clang/lib/Basic/Sanitizers.cpp</code> to parse sanitizers defined
<code>clang/include/clang/Basic/Sanitizers.def</code>.</p>
<div class="highlight"><pre><span></span><code><span class="c1">// clang/include/clang/Basic/Sanitizers.def</span>
<span class="c1">// libFuzzer</span>
<span class="n">SANITIZER</span><span class="p">(</span><span class="s">&quot;fuzzer&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">Fuzzer</span><span class="p">)</span>

<span class="c1">// libFuzzer-required instrumentation, no linking.</span>
<span class="n">SANITIZER</span><span class="p">(</span><span class="s">&quot;fuzzer-no-link&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">FuzzerNoLink</span><span class="p">)</span>
</code></pre></div>
<p>In <code>SanitizerArgs()</code>, <code>parseCoverageFeatures</code> will parse two flags:
<code>-fsanitize-coverage=&lt;value&gt;</code> and <code>-fno-sanitize-coverage=&lt;value&gt;</code> to control
what kind of coverage information for sanitizers. Try <code>clang --help | grep
coverage</code> to see more related flags.</p>
<div class="highlight"><pre><span></span><code><span class="kt">int</span><span class="w"> </span><span class="nf">parseCoverageFeatures</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">Driver</span><span class="w"> </span><span class="o">&amp;</span><span class="n">D</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">llvm</span><span class="o">::</span><span class="n">opt</span><span class="o">::</span><span class="n">Arg</span><span class="w"> </span><span class="o">*</span><span class="n">A</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">assert</span><span class="p">(</span><span class="n">A</span><span class="o">-&gt;</span><span class="n">getOption</span><span class="p">().</span><span class="n">matches</span><span class="p">(</span><span class="n">options</span><span class="o">::</span><span class="n">OPT_fsanitize_coverage</span><span class="p">)</span><span class="w"> </span><span class="o">||</span>
<span class="w">         </span><span class="n">A</span><span class="o">-&gt;</span><span class="n">getOption</span><span class="p">().</span><span class="n">matches</span><span class="p">(</span><span class="n">options</span><span class="o">::</span><span class="n">OPT_fno_sanitize_coverage</span><span class="p">));</span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">Features</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">A</span><span class="o">-&gt;</span><span class="n">getNumValues</span><span class="p">();</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">n</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">Value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">A</span><span class="o">-&gt;</span><span class="n">getValue</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">F</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">llvm</span><span class="o">::</span><span class="n">StringSwitch</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">(</span><span class="n">Value</span><span class="p">)</span>
<span class="w">                </span><span class="p">.</span><span class="n">Case</span><span class="p">(</span><span class="s">&quot;func&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">CoverageFunc</span><span class="p">)</span>
<span class="w">                </span><span class="p">.</span><span class="n">Case</span><span class="p">(</span><span class="s">&quot;bb&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">CoverageBB</span><span class="p">)</span>
<span class="w">                </span><span class="p">.</span><span class="n">Case</span><span class="p">(</span><span class="s">&quot;edge&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">CoverageEdge</span><span class="p">)</span>
<span class="w">                </span><span class="p">.</span><span class="n">Case</span><span class="p">(</span><span class="s">&quot;indirect-calls&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">CoverageIndirCall</span><span class="p">)</span>
<span class="w">                </span><span class="p">.</span><span class="n">Case</span><span class="p">(</span><span class="s">&quot;trace-bb&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">CoverageTraceBB</span><span class="p">)</span>
<span class="w">                </span><span class="p">.</span><span class="n">Case</span><span class="p">(</span><span class="s">&quot;trace-cmp&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">CoverageTraceCmp</span><span class="p">)</span>
<span class="w">                </span><span class="p">.</span><span class="n">Case</span><span class="p">(</span><span class="s">&quot;trace-div&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">CoverageTraceDiv</span><span class="p">)</span>
<span class="w">                </span><span class="p">.</span><span class="n">Case</span><span class="p">(</span><span class="s">&quot;trace-gep&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">CoverageTraceGep</span><span class="p">)</span>
<span class="w">                </span><span class="p">.</span><span class="n">Case</span><span class="p">(</span><span class="s">&quot;8bit-counters&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">Coverage8bitCounters</span><span class="p">)</span>
<span class="w">                </span><span class="p">.</span><span class="n">Case</span><span class="p">(</span><span class="s">&quot;trace-pc&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">CoverageTracePC</span><span class="p">)</span>
<span class="w">                </span><span class="p">.</span><span class="n">Case</span><span class="p">(</span><span class="s">&quot;trace-pc-guard&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">CoverageTracePCGuard</span><span class="p">)</span>
<span class="w">                </span><span class="p">.</span><span class="n">Case</span><span class="p">(</span><span class="s">&quot;no-prune&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">CoverageNoPrune</span><span class="p">)</span>
<span class="w">                </span><span class="p">.</span><span class="n">Case</span><span class="p">(</span><span class="s">&quot;inline-8bit-counters&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">CoverageInline8bitCounters</span><span class="p">)</span>
<span class="w">                </span><span class="p">.</span><span class="n">Case</span><span class="p">(</span><span class="s">&quot;inline-bool-flag&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">CoverageInlineBoolFlag</span><span class="p">)</span>
<span class="w">                </span><span class="p">.</span><span class="n">Case</span><span class="p">(</span><span class="s">&quot;pc-table&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">CoveragePCTable</span><span class="p">)</span>
<span class="w">                </span><span class="p">.</span><span class="n">Case</span><span class="p">(</span><span class="s">&quot;stack-depth&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">CoverageStackDepth</span><span class="p">)</span>
<span class="w">                </span><span class="p">.</span><span class="n">Default</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">F</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">      </span><span class="n">D</span><span class="p">.</span><span class="n">Diag</span><span class="p">(</span><span class="n">clang</span><span class="o">::</span><span class="n">diag</span><span class="o">::</span><span class="n">err_drv_unsupported_option_argument</span><span class="p">)</span>
<span class="w">          </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">A</span><span class="o">-&gt;</span><span class="n">getOption</span><span class="p">().</span><span class="n">getName</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">Value</span><span class="p">;</span>
<span class="w">    </span><span class="n">Features</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="n">F</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">Features</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p><code>parseCoverageFeatures</code> clearly show what kind of coverage we can control. In
the following are several tips to enable and disable these coverage flags.
+ <code>func</code>, <code>bb</code>, and <code>edge</code> are mutually exclusive
+ <code>trace-bb</code> is deprecated, use <code>trace-pc-guard</code> instead
+ <code>8bit-counter</code> is deprecated, use <code>trace-pc-guard</code> instead
+ if use one of <code>func</code>, <code>bb</code>, and <code>edge</code>, <code>trace-pc-guard</code> or <code>trace-pc</code> must be enabled
+ if one of <code>trace-pc</code>, <code>trace-pc-guard</code>, <code>inline-8bit-counter</code>, and <code>inline-bool-flag</code>
is enabled without any <code>func</code>, <code>bb</code>, or <code>edge</code>, then <code>edge</code> is added by default
+ <code>stack-depth</code> needs <code>func</code></p>
<p>Returning from <code>SanitizerArgs()</code>,  <code>ConstructJob</code> will invoke <code>addArgs</code> to
append flags to the command line <code>clang -o foo -fsanitize=fuzzer foo.c</code>.</p>
<p><div class="highlight"><pre><span></span><code>[#0] 0x55555a470fa2 → clang::driver::SanitizerArgs::addArgs()
[#1] 0x55555a3c6572 → clang::driver::tools::Clang::ConstructJob()
[#2] 0x55555a345a9a → clang::driver::Driver::BuildJobsForActionNoCache()
[#3] 0x55555a343f99 → clang::driver::Driver::BuildJobsForAction()
[#4] 0x55555a344bad → clang::driver::Driver::BuildJobsForActionNoCache()
[#5] 0x55555a343f99 → clang::driver::Driver::BuildJobsForAction()
[#6] 0x55555a34280e → clang::driver::Driver::BuildJobs()
[#7] 0x55555a3345c4 → clang::driver::Driver::BuildCompilation()
</code></pre></div>
<code>addArgs</code> will add corresponding flags according to the table below.</p>
<div class="highlight"><pre><span></span><code><span class="n">std</span><span class="o">::</span><span class="n">pair</span><span class="o">&lt;</span><span class="kt">int</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*&gt;</span><span class="w"> </span><span class="n">CoverageFlags</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">make_pair</span><span class="p">(</span><span class="n">CoverageFunc</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;-fsanitize-coverage-type=1&quot;</span><span class="p">),</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">make_pair</span><span class="p">(</span><span class="n">CoverageBB</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;-fsanitize-coverage-type=2&quot;</span><span class="p">),</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">make_pair</span><span class="p">(</span><span class="n">CoverageEdge</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;-fsanitize-coverage-type=3&quot;</span><span class="p">),</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">make_pair</span><span class="p">(</span><span class="n">CoverageIndirCall</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;-fsanitize-coverage-indirect-calls&quot;</span><span class="p">),</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">make_pair</span><span class="p">(</span><span class="n">CoverageTraceBB</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;-fsanitize-coverage-trace-bb&quot;</span><span class="p">),</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">make_pair</span><span class="p">(</span><span class="n">CoverageTraceCmp</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;-fsanitize-coverage-trace-cmp&quot;</span><span class="p">),</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">make_pair</span><span class="p">(</span><span class="n">CoverageTraceDiv</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;-fsanitize-coverage-trace-div&quot;</span><span class="p">),</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">make_pair</span><span class="p">(</span><span class="n">CoverageTraceGep</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;-fsanitize-coverage-trace-gep&quot;</span><span class="p">),</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">make_pair</span><span class="p">(</span><span class="n">Coverage8bitCounters</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;-fsanitize-coverage-8bit-counters&quot;</span><span class="p">),</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">make_pair</span><span class="p">(</span><span class="n">CoverageTracePC</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;-fsanitize-coverage-trace-pc&quot;</span><span class="p">),</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">make_pair</span><span class="p">(</span><span class="n">CoverageTracePCGuard</span><span class="p">,</span>
<span class="w">                    </span><span class="s">&quot;-fsanitize-coverage-trace-pc-guard&quot;</span><span class="p">),</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">make_pair</span><span class="p">(</span><span class="n">CoverageInline8bitCounters</span><span class="p">,</span>
<span class="w">                    </span><span class="s">&quot;-fsanitize-coverage-inline-8bit-counters&quot;</span><span class="p">),</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">make_pair</span><span class="p">(</span><span class="n">CoverageInlineBoolFlag</span><span class="p">,</span>
<span class="w">                    </span><span class="s">&quot;-fsanitize-coverage-inline-bool-flag&quot;</span><span class="p">),</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">make_pair</span><span class="p">(</span><span class="n">CoveragePCTable</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;-fsanitize-coverage-pc-table&quot;</span><span class="p">),</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">make_pair</span><span class="p">(</span><span class="n">CoverageNoPrune</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;-fsanitize-coverage-no-prune&quot;</span><span class="p">),</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">make_pair</span><span class="p">(</span><span class="n">CoverageStackDepth</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;-fsanitize-coverage-stack-depth&quot;</span><span class="p">),</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">make_pair</span><span class="p">(</span><span class="n">CoverageTraceState</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;-fsanitize-coverage-trace-state&quot;</span><span class="p">)};</span>
</code></pre></div>
<p>Returning from <code>Clang::contructJob</code>, <code>addSanitizerRuntimes</code> will expand linker
flags.</p>
<div class="highlight"><pre><span></span><code>[#0] 0x55555a3dcbe2 → clang::driver::tools::addSanitizerRuntimes()
[#1] 0x55555a40cac0 → clang::driver::tools::gnutools::Linker::ConstructJob()
[#2] 0x55555a345a9a → clang::driver::Driver::BuildJobsForActionNoCache()
[#3] 0x55555a343f99 → clang::driver::Driver::BuildJobsForAction()
[#4] 0x55555a34280e → clang::driver::Driver::BuildJobs()
[#5] 0x55555a3345c4 → clang::driver::Driver::BuildCompilation()
[#6] 0x555557ddf8f7 → main()
</code></pre></div>
<p>In <code>addSanitizerRuntimes</code>, <code>collectSanitizerRuntimes</code> will collect libraries for
sanitizers.
+ Use <code>-shared-libsan</code> (by default) or <code>-static-libsan</code> to collect dynamic or static libraries
+ use <code>-fsanitize-link-runtime"</code> (by default) or <code>-fno-sanitize-link-runtime</code> to switch on or off linking</p>
<p>To use ASAN, assign <code>-fsanitize=address</code>. If only <code>-fsanitize=fuzzer</code>, then
UBSAN will be enabled.</p>
<div class="highlight"><pre><span></span><code><span class="kt">bool</span><span class="w"> </span><span class="nf">SanitizerArgs::needsUbsanRt</span><span class="p">()</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// All of these include ubsan.</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">needsAsanRt</span><span class="p">()</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">needsMsanRt</span><span class="p">()</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">needsHwasanRt</span><span class="p">()</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">needsTsanRt</span><span class="p">()</span><span class="w"> </span><span class="o">||</span>
<span class="w">      </span><span class="n">needsDfsanRt</span><span class="p">()</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">needsLsanRt</span><span class="p">()</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">needsCfiDiagRt</span><span class="p">()</span><span class="w"> </span><span class="o">||</span>
<span class="w">      </span><span class="p">(</span><span class="n">needsScudoRt</span><span class="p">()</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">requiresMinimalRuntime</span><span class="p">()))</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="n">Sanitizers</span><span class="p">.</span><span class="n">Mask</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">NeedsUbsanRt</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="o">~</span><span class="n">TrapSanitizers</span><span class="p">.</span><span class="n">Mask</span><span class="p">)</span><span class="w"> </span><span class="o">||</span>
<span class="w">         </span><span class="n">CoverageFeatures</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p>Shortly, if no other sanitizers is enabled, and if any coverage is enabled,
UBSAN will be enabled.</p>
<p>After <code>collectSanitizerRuntimes</code>, <code>addSanitizerRuntimes</code> will update runtimes regarding to <code>-fsanitizer=fuzzer</code>.</p>
<div class="highlight"><pre><span></span><code><span class="kt">bool</span><span class="w"> </span><span class="nf">SanitizerArgs::needsFuzzerInterceptors</span><span class="p">()</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">needsFuzzer</span><span class="p">()</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">needsAsanRt</span><span class="p">()</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">needsTsanRt</span><span class="p">()</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">needsMsanRt</span><span class="p">();</span>
<span class="p">}</span>

<span class="kt">bool</span><span class="w"> </span><span class="nf">tools::addSanitizerRuntimes</span><span class="p">(...)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="p">...</span>
<span class="w">    </span><span class="n">addSanitizerRuntime</span><span class="p">(</span><span class="n">TC</span><span class="p">,</span><span class="w"> </span><span class="n">Args</span><span class="p">,</span><span class="w"> </span><span class="n">CmdArgs</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;fuzzer&quot;</span><span class="p">,</span><span class="w"> </span><span class="nb">false</span><span class="p">,</span><span class="w"> </span><span class="nb">true</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">SanArgs</span><span class="p">.</span><span class="n">needsFuzzerInterceptors</span><span class="p">())</span>
<span class="w">        </span><span class="n">addSanitizerRuntime</span><span class="p">(</span><span class="n">TC</span><span class="p">,</span><span class="w"> </span><span class="n">Args</span><span class="p">,</span><span class="w"> </span><span class="n">CmdArgs</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;fuzzer_interceptors&quot;</span><span class="p">,</span><span class="w"> </span><span class="nb">false</span><span class="p">,</span><span class="w"> </span><span class="nb">true</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<p>BTW, <code>fuzz_interceptors</code> will be appended if no ASAN, TSAN, MSAN runtime is
enabled.</p>
<p>Finally, to narrow down the coverage collection, we can construct a command in
the following.</p>
<div class="highlight"><pre><span></span><code>clang<span class="w"> </span>-o<span class="w"> </span>foo<span class="w"> </span>-fsanitize<span class="o">=</span>fuzzer<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-fno-sanitize-coverage<span class="o">=</span>indirect-calls,trace-cmp,stack-depth,pc-table<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>foo.c
</code></pre></div>
<p>In this way, only <code>edge</code> and <code>inline-8bit-counters</code> are enabled.</p>
<h2 id="flow-of-instrumentations">Flow of instrumentations<a class="headerlink" href="#flow-of-instrumentations" title="Do what you think is right">#</a></h2>
<p>The module pass <code>SanitizerCoverage</code>
(llvm/lib/Transforms/Instrumentation/SanitizerCoverage.cpp) will instrument
coverage flag to each module.</p>
<p>In the first state, <code>SanitizerCoverage</code> will construct the IR of stubs to be
instrumented. A classic pattern is in the following.</p>
<div class="highlight"><pre><span></span><code><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="n">SanCovTracePCIndirName</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;__sanitizer_cov_trace_pc_indir&quot;</span><span class="p">;</span>
<span class="n">SanCovTracePCIndir</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">M</span><span class="p">.</span><span class="n">getOrInsertFunction</span><span class="p">(</span><span class="n">SanCovTracePCIndirName</span><span class="p">,</span><span class="w"> </span><span class="n">VoidTy</span><span class="p">,</span><span class="w"> </span><span class="n">IntptrTy</span><span class="p">);</span>
</code></pre></div>
<p>In the second state, <code>SanitizerCoverage</code> will traverse all IR code and do
instrumentation at the proper position.</p>
<div class="highlight"><pre><span></span><code><span class="n">IRB</span><span class="p">.</span><span class="n">CreateCall</span><span class="p">(</span><span class="n">SanCovTracePCIndir</span><span class="p">,</span><span class="w"> </span><span class="n">IRB</span><span class="p">.</span><span class="n">CreatePointerCast</span><span class="p">(</span><span class="n">Callee</span><span class="p">,</span><span class="w"> </span><span class="n">IntptrTy</span><span class="p">));</span>
</code></pre></div>
<p>The overall flow of <code>SanitizerCoverage</code> is in the following.</p>
<div class="highlight"><pre><span></span><code>instrumentModule
    - stage 1
    - for (auto &amp;F : M) { instrumentFunction(F); }
instrumentFunction
    - split edges if edge coverage[^1]
    - for (auto &amp;BB : F) {
        BlocksToInstrument.push_back(&amp;BB);
        for (auto &amp;Inst: BB) { /* simplified */
          if (IndirectCalls &amp;&amp; xxx) IndirCalls.push_back(&amp;Inst)
          if (TraceCmp &amp;&amp; xxx) CmpTraceTargets.push_back(&amp;Inst)
          if (TraceCmp &amp;&amp; xxx) SwitchTraceTargets.push_back(&amp;Inst)
          if (TraceDiv &amp;&amp; xxx) DivTraceTargets.push_back(BO)
          if (TraceGep &amp;&amp; xxx) GepTraceTargets.push_back(BO)
          if (TraceStackDepth &amp;&amp; xxx) IsLeafFunc = false;
        }
      }
    - stage 2
        InjectCoverage(F, BlocksToInstrument, IsLeafFunc);
        InjectCoverageForIndirectCalls(F, IndirCalls);
        InjectTraceForCmp(F, CmpTraceTargets);
        InjectTraceForSwitch(F, SwitchTraceTargets);
        InjectTraceForDiv(F, DivTraceTargets);
        InjectTraceForGep(F, GepTraceTargets);
</code></pre></div>
<p>The key function in stage 2 is <code>InjectCoverage</code>.</p>
<p><code>InjectCoverage</code> first create FunctionGuardArray, Function8bitCounterArray,
FunctionBoolArray, or FunctionPCsArray in <code>CreateFunctionLocalArrays</code>, then
invoke <code>InjectCoverageAtBlock</code> to handle each basic blocks.
<code>InjectCoverageAtBlock</code> will instrument <code>SanCovTracePC</code>, <code>SanCovTracePCGuard</code>,
<code>Inline8BitCounters</code>, or <code>InlineBoolFlag</code>, or update the lowest stack frame, for
each basic block.</p>
<h2 id="details-of-stubs">Details of stubs<a class="headerlink" href="#details-of-stubs" title="Do what you think is right">#</a></h2>
<p>Please also refer to <a href="https://clang.llvm.org/docs/SanitizerCoverage.html">this</a>.</p>
<h3 id="__sanitizer_cov_indir_call">__sanitizer_cov_indir_call<a class="headerlink" href="#__sanitizer_cov_indir_call" title="Do what you think is right">#</a></h3>
<p>This will be in front of an indirect call. It requires at least one of
<code>trace-pc</code>, <code>trace-pc-guard</code>, <code>inline-8bit-counters</code>, and <code>inline-bool-flag</code>.
It accepts one parameter, the callee address. The address of the caller is
passed implicitly via caller PC. Importantly, if the callee is inline assembly,
the indirect call will not be instrumented. Its implementation in libFuzzer is
in the following. In the end, new information will be updated into the value
profile.</p>
<div class="highlight"><pre><span></span><code><span class="cp">#define GET_CALLER_PC() __builtin_return_address(0)</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">TracePC::HandleCallerCallee</span><span class="p">(</span><span class="kt">uintptr_t</span><span class="w"> </span><span class="n">Caller</span><span class="p">,</span><span class="w"> </span><span class="kt">uintptr_t</span><span class="w"> </span><span class="n">Callee</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="kt">uintptr_t</span><span class="w"> </span><span class="n">kBits</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">12</span><span class="p">;</span>
<span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="kt">uintptr_t</span><span class="w"> </span><span class="n">kMask</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">kBits</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">  </span><span class="kt">uintptr_t</span><span class="w"> </span><span class="n">Idx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">Caller</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">kMask</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="p">((</span><span class="n">Callee</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">kMask</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">kBits</span><span class="p">);</span>
<span class="w">  </span><span class="n">ValueProfileMap</span><span class="p">.</span><span class="n">AddValueModPrime</span><span class="p">(</span><span class="n">Idx</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">__sanitizer_cov_trace_pc_indir</span><span class="p">(</span><span class="kt">uintptr_t</span><span class="w"> </span><span class="n">Callee</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kt">uintptr_t</span><span class="w"> </span><span class="n">PC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="kt">uintptr_t</span><span class="o">&gt;</span><span class="p">(</span><span class="n">GET_CALLER_PC</span><span class="p">());</span>
<span class="w">  </span><span class="n">fuzzer</span><span class="o">::</span><span class="n">TPC</span><span class="p">.</span><span class="n">HandleCallerCallee</span><span class="p">(</span><span class="n">PC</span><span class="p">,</span><span class="w"> </span><span class="n">Callee</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="__sanitizer_cov_trace_const_cmp1248">__sanitizer_cov_trace_[const_]cmp[1|2|4|8]<a class="headerlink" href="#__sanitizer_cov_trace_const_cmp1248" title="Do what you think is right">#</a></h3>
<p>These will be in front of a cmp instruction with const operand or not. They
accept both operands to be compared. The address of the caller is passed
implicitly via caller PC. One of its implementation in libFuzzer is in the
following. In the end, new information will be updated into the value profile.</p>
<div class="highlight"><pre><span></span><code><span class="cp">#define GET_CALLER_PC() __builtin_return_address(0)</span>

<span class="k">template</span><span class="w"> </span><span class="o">&lt;</span><span class="k">class</span><span class="w"> </span><span class="nc">T</span><span class="o">&gt;</span>
<span class="kt">void</span><span class="w"> </span><span class="n">TracePC</span><span class="o">::</span><span class="n">HandleCmp</span><span class="p">(</span><span class="kt">uintptr_t</span><span class="w"> </span><span class="n">PC</span><span class="p">,</span><span class="w"> </span><span class="n">T</span><span class="w"> </span><span class="n">Arg1</span><span class="p">,</span><span class="w"> </span><span class="n">T</span><span class="w"> </span><span class="n">Arg2</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kt">uint64_t</span><span class="w"> </span><span class="n">ArgXor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Arg1</span><span class="w"> </span><span class="o">^</span><span class="w"> </span><span class="n">Arg2</span><span class="p">;</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">T</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">4</span><span class="p">)</span>
<span class="w">      </span><span class="n">TORC4</span><span class="p">.</span><span class="n">Insert</span><span class="p">(</span><span class="n">ArgXor</span><span class="p">,</span><span class="w"> </span><span class="n">Arg1</span><span class="p">,</span><span class="w"> </span><span class="n">Arg2</span><span class="p">);</span>
<span class="w">  </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">T</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">8</span><span class="p">)</span>
<span class="w">      </span><span class="n">TORC8</span><span class="p">.</span><span class="n">Insert</span><span class="p">(</span><span class="n">ArgXor</span><span class="p">,</span><span class="w"> </span><span class="n">Arg1</span><span class="p">,</span><span class="w"> </span><span class="n">Arg2</span><span class="p">);</span>
<span class="w">  </span><span class="kt">uint64_t</span><span class="w"> </span><span class="n">HammingDistance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Popcountll</span><span class="p">(</span><span class="n">ArgXor</span><span class="p">);</span><span class="w">  </span><span class="c1">// [0,64]</span>
<span class="w">  </span><span class="kt">uint64_t</span><span class="w"> </span><span class="n">AbsoluteDistance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">Arg1</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">Arg2</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">Clzll</span><span class="p">(</span><span class="n">Arg1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Arg2</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="w">  </span><span class="n">ValueProfileMap</span><span class="p">.</span><span class="n">AddValue</span><span class="p">(</span><span class="n">PC</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">128</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">HammingDistance</span><span class="p">);</span>
<span class="w">  </span><span class="n">ValueProfileMap</span><span class="p">.</span><span class="n">AddValue</span><span class="p">(</span><span class="n">PC</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">128</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">64</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">AbsoluteDistance</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="n">__sanitizer_cov_trace_cmp1</span><span class="p">(</span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">Arg1</span><span class="p">,</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">Arg2</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kt">uintptr_t</span><span class="w"> </span><span class="n">PC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="kt">uintptr_t</span><span class="o">&gt;</span><span class="p">(</span><span class="n">GET_CALLER_PC</span><span class="p">());</span>
<span class="w">  </span><span class="n">fuzzer</span><span class="o">::</span><span class="n">TPC</span><span class="p">.</span><span class="n">HandleCmp</span><span class="p">(</span><span class="n">PC</span><span class="p">,</span><span class="w"> </span><span class="n">Arg1</span><span class="p">,</span><span class="w"> </span><span class="n">Arg2</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<p>Similarly stubs are <code>__sanitizer_cov_trace_switch</code>,
<code>__sanitizer_cov_trace_div[4|8]</code>, and <code>__sanitizer_cov_trace_gep</code>.  They all
invoke HandleCmp at the end to update new information into the value profile.</p>
<h3 id="__sanitizer_cov_trace_pc">__sanitizer_cov_trace_pc<a class="headerlink" href="#__sanitizer_cov_trace_pc" title="Do what you think is right">#</a></h3>
<p>This will be at the entry of each basic block. The address of the caller is
passed implicitly via caller PC. This is deprecated.</p>
<h3 id="__sanitizer_cov_trace_pc_guard_init">__sanitizer_cov_trace_pc_guard[_init]<a class="headerlink" href="#__sanitizer_cov_trace_pc_guard_init" title="Do what you think is right">#</a></h3>
<p><code>__sanitizer_cov_trace_pc_guard</code> will be at the entry of each basic block after
<code>__sanitier_cov_trace_pc</code>. The address of the caller is passed implicitly via
caller PC. They are deprecated.</p>
<p>Each function would have a function guard array <code>int32_t FunctionGuardArray[]</code>
whose size is the number of the basic blocks. This array is associated with
<code>sancov_guards</code> section. <code>__sanitizer_cov_trace_pc_guard</code> accepts
<code>FunctionGuardArray[IdxofBB]</code> as the guard.</p>
<p>If any function guard array, SanCov will create a section named
<code>sancov.module_ctor_trace_pc_guard</code> to invoke
<code>__sanitizer_cov_trace_pc_guard_init</code> to initialize <code>sancov_guards</code> for each
module.</p>
<p>[NOT SURE] In the end, after linking, there will be one <code>sancov_guards</code> and one
<code>sancov.module_ctor_trace_pc_guard</code>.</p>
<h3 id="__sanitizer_cov_8bipctableentryidxpc_guard">__sanitizer_cov_8biPCTableEntryIdxpc_guard`.<a class="headerlink" href="#__sanitizer_cov_8bipctableentryidxpc_guard" title="Do what you think is right">#</a></h3>
<p>Each function would have a function 8bit counter array <code>int8_t
Function8BitArray[]</code> whose size is the number of the basic blocks. This array is
associated with <code>sancov_cntrs</code> section. If a basic block is visited, then the
corresponding byte in the array will be increased by 1.</p>
<p>If any function 8bit array, SanCov will create a section named
<code>sancov.module_ctor_8bit_counters</code> to invoke
<code>__sanitizer_cov_8bit_counters_init</code> to initialize <code>sancov_cntrs</code> for each
module.</p>
<p>[NOT SURE] In the end, after linking, there will be one <code>sancov_cntrs</code> and one
<code>sancov.module_ctor_8bit_counters</code>.</p>
<p><code>__sanitizer_cov_8bit_counters_init</code> is defined in the following. It shows the
counter information flows to <code>Modules</code> in the libFuzzer. In short, <code>Modules</code>
records the start and the stop address of the <code>sancov_cntrs</code> divided by page
(<code>Region</code>).</p>
<div class="highlight"><pre><span></span><code><span class="kt">void</span><span class="w"> </span><span class="nf">TracePC::HandleInline8bitCountersInit</span><span class="p">(</span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="n">Start</span><span class="p">,</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="n">Stop</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Start</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">Stop</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="p">;</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">NumModules</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<span class="w">      </span><span class="n">Modules</span><span class="p">[</span><span class="n">NumModules</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">].</span><span class="n">Start</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">Start</span><span class="p">)</span>
<span class="w">    </span><span class="k">return</span><span class="p">;</span>
<span class="w">  </span><span class="n">assert</span><span class="p">(</span><span class="n">NumModules</span><span class="w"> </span><span class="o">&lt;</span>
<span class="w">         </span><span class="k">sizeof</span><span class="p">(</span><span class="n">Modules</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">Modules</span><span class="p">[</span><span class="mi">0</span><span class="p">]));</span>
<span class="w">  </span><span class="k">auto</span><span class="w"> </span><span class="o">&amp;</span><span class="n">M</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Modules</span><span class="p">[</span><span class="n">NumModules</span><span class="o">++</span><span class="p">];</span>
<span class="w">  </span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="n">AlignedStart</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">RoundUpByPage</span><span class="p">(</span><span class="n">Start</span><span class="p">);</span>
<span class="w">  </span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="n">AlignedStop</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">RoundDownByPage</span><span class="p">(</span><span class="n">Stop</span><span class="p">);</span>
<span class="w">  </span><span class="kt">size_t</span><span class="w"> </span><span class="n">NumFullPages</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">AlignedStop</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">AlignedStart</span><span class="w"> </span><span class="o">?</span>
<span class="w">                        </span><span class="p">(</span><span class="n">AlignedStop</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">AlignedStart</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">PageSize</span><span class="p">()</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">  </span><span class="kt">bool</span><span class="w"> </span><span class="n">NeedFirst</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Start</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">AlignedStart</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="o">!</span><span class="n">NumFullPages</span><span class="p">;</span>
<span class="w">  </span><span class="kt">bool</span><span class="w"> </span><span class="n">NeedLast</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">Stop</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">AlignedStop</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">AlignedStop</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">AlignedStart</span><span class="p">;</span>
<span class="w">  </span><span class="n">M</span><span class="p">.</span><span class="n">NumRegions</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NumFullPages</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">NeedFirst</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">NeedLast</span><span class="p">;;</span>
<span class="w">  </span><span class="n">assert</span><span class="p">(</span><span class="n">M</span><span class="p">.</span><span class="n">NumRegions</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<span class="w">  </span><span class="n">M</span><span class="p">.</span><span class="n">Regions</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Module</span><span class="o">::</span><span class="n">Region</span><span class="p">[</span><span class="n">M</span><span class="p">.</span><span class="n">NumRegions</span><span class="p">];</span>
<span class="w">  </span><span class="n">assert</span><span class="p">(</span><span class="n">M</span><span class="p">.</span><span class="n">Regions</span><span class="p">);</span>
<span class="w">  </span><span class="kt">size_t</span><span class="w"> </span><span class="n">R</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">NeedFirst</span><span class="p">)</span>
<span class="w">    </span><span class="n">M</span><span class="p">.</span><span class="n">Regions</span><span class="p">[</span><span class="n">R</span><span class="o">++</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">Start</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">min</span><span class="p">(</span><span class="n">Stop</span><span class="p">,</span><span class="w"> </span><span class="n">AlignedStart</span><span class="p">),</span><span class="w"> </span><span class="nb">true</span><span class="p">,</span><span class="w"> </span><span class="nb">false</span><span class="p">};</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="n">P</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">AlignedStart</span><span class="p">;</span><span class="w"> </span><span class="n">P</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">AlignedStop</span><span class="p">;</span><span class="w"> </span><span class="n">P</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">PageSize</span><span class="p">())</span>
<span class="w">    </span><span class="n">M</span><span class="p">.</span><span class="n">Regions</span><span class="p">[</span><span class="n">R</span><span class="o">++</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">P</span><span class="p">,</span><span class="w"> </span><span class="n">P</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">PageSize</span><span class="p">(),</span><span class="w"> </span><span class="nb">true</span><span class="p">,</span><span class="w"> </span><span class="nb">true</span><span class="p">};</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">NeedLast</span><span class="p">)</span>
<span class="w">    </span><span class="n">M</span><span class="p">.</span><span class="n">Regions</span><span class="p">[</span><span class="n">R</span><span class="o">++</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">AlignedStop</span><span class="p">,</span><span class="w"> </span><span class="n">Stop</span><span class="p">,</span><span class="w"> </span><span class="nb">true</span><span class="p">,</span><span class="w"> </span><span class="nb">false</span><span class="p">};</span>
<span class="w">  </span><span class="n">assert</span><span class="p">(</span><span class="n">R</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">M</span><span class="p">.</span><span class="n">NumRegions</span><span class="p">);</span>
<span class="w">  </span><span class="n">assert</span><span class="p">(</span><span class="n">M</span><span class="p">.</span><span class="n">Size</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="p">(</span><span class="kt">size_t</span><span class="p">)(</span><span class="n">Stop</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Start</span><span class="p">));</span>
<span class="w">  </span><span class="n">assert</span><span class="p">(</span><span class="n">M</span><span class="p">.</span><span class="n">Stop</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">Stop</span><span class="p">);</span>
<span class="w">  </span><span class="n">assert</span><span class="p">(</span><span class="n">M</span><span class="p">.</span><span class="n">Start</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">Start</span><span class="p">);</span>
<span class="w">  </span><span class="n">NumInline8bitCounters</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">M</span><span class="p">.</span><span class="n">Size</span><span class="p">();</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">__sanitizer_cov_8bit_counters_init</span><span class="p">(</span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="n">Start</span><span class="p">,</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="n">Stop</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">fuzzer</span><span class="o">::</span><span class="n">TPC</span><span class="p">.</span><span class="n">HandleInline8bitCountersInit</span><span class="p">(</span><span class="n">Start</span><span class="p">,</span><span class="w"> </span><span class="n">Stop</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="__sanitizer_cov_bool_flag_init">__sanitizer_cov_bool_flag_init<a class="headerlink" href="#__sanitizer_cov_bool_flag_init" title="Do what you think is right">#</a></h3>
<p>The inline bool flag will be at the entry of each basic block after the inline
8bit counters.</p>
<p>Each function would have a function 1 bit array <code>int1_t FunctionBoolArray[]</code>
whose size is the number of the basic blocks. This array is associated with
<code>sancov_bools</code> section. If a basic block is visited, then the corresponding bit
in the array will be true.</p>
<p>If any function bool array, SanCov will create a section named
<code>sancov.module_ctor_bool_flag</code> to invoke <code>__sanitizer_cov_bool_flag_init</code> to
initilize <code>sancov_bools</code> for each module.</p>
<p>[NOT SURE] In the end, after linking, there will be one <code>sancov_bools</code> and one
<code>sancov.module_ctor_bool_flag</code>.</p>
<p><code>__sanitizer_cov_bool_flag_init</code> is not defined in the libFuzzer.</p>
<h3 id="__sanitizer_cov_pcs_init">__sanitizer_cov_pcs_init<a class="headerlink" href="#__sanitizer_cov_pcs_init" title="Do what you think is right">#</a></h3>
<p>For each function, SanCov creates a PC array associated with <code>sancov_pcs</code> to
store <code>{PC, PCFlags}</code> pairs. PC is the address of the corresponding basic block,
and a PCFlags describes the basic block is the function entry block (1) or not
(0).</p>
<p>If one of the <code>trace-pc-guard</code>, <code>inline-8bit-counters</code>, and <code>inline-bool-flag</code>,
and any function PC array, SanCov will invoke <code>__sanitizer_cov_pcs_init</code> to
initilize <code>sancov_pcs</code> for each module in one of the section: <code>sancov.xxx</code>.</p>
<p>[NOT SURE] In the end, after linking, there will be one <code>sancov_pcs</code>.</p>
<p><code>__sanitizer_cov_pcs_init</code> is defined in the following. In short, the
information flows to <code>ModulePCTable</code> in libFuzzer.</p>
<div class="highlight"><pre><span></span><code><span class="kt">void</span><span class="w"> </span><span class="nf">TracePC::HandlePCsInit</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">uintptr_t</span><span class="w"> </span><span class="o">*</span><span class="n">Start</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">uintptr_t</span><span class="w"> </span><span class="o">*</span><span class="n">Stop</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="n">PCTableEntry</span><span class="w"> </span><span class="o">*</span><span class="n">B</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="k">const</span><span class="w"> </span><span class="n">PCTableEntry</span><span class="w"> </span><span class="o">*&gt;</span><span class="p">(</span><span class="n">Start</span><span class="p">);</span>
<span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="n">PCTableEntry</span><span class="w"> </span><span class="o">*</span><span class="n">E</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="k">const</span><span class="w"> </span><span class="n">PCTableEntry</span><span class="w"> </span><span class="o">*&gt;</span><span class="p">(</span><span class="n">Stop</span><span class="p">);</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">NumPCTables</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">ModulePCTable</span><span class="p">[</span><span class="n">NumPCTables</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">].</span><span class="n">Start</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">B</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="p">;</span>
<span class="w">  </span><span class="n">assert</span><span class="p">(</span><span class="n">NumPCTables</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">ModulePCTable</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">ModulePCTable</span><span class="p">[</span><span class="mi">0</span><span class="p">]));</span>
<span class="w">  </span><span class="n">ModulePCTable</span><span class="p">[</span><span class="n">NumPCTables</span><span class="o">++</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">B</span><span class="p">,</span><span class="w"> </span><span class="n">E</span><span class="p">};</span>
<span class="w">  </span><span class="n">NumPCsInPCTables</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">E</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">B</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">__sanitizer_cov_pcs_init</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">uintptr_t</span><span class="w"> </span><span class="o">*</span><span class="n">pcs_beg</span><span class="p">,</span>
<span class="w">                              </span><span class="k">const</span><span class="w"> </span><span class="kt">uintptr_t</span><span class="w"> </span><span class="o">*</span><span class="n">pcs_end</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">fuzzer</span><span class="o">::</span><span class="n">TPC</span><span class="p">.</span><span class="n">HandlePCsInit</span><span class="p">(</span><span class="n">pcs_beg</span><span class="p">,</span><span class="w"> </span><span class="n">pcs_end</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="a-brief-list-of-flag-stubs-and-information-sink-in-libfuzzer">A brief list of (flag, stubs, and information sink in libFuzzer)<a class="headerlink" href="#a-brief-list-of-flag-stubs-and-information-sink-in-libfuzzer" title="Do what you think is right">#</a></h3>
<table>
<thead>
<tr>
<th align="center">Flag</th>
<th align="center">Stubs</th>
<th align="center">Information Sink</th>
</tr>
</thead>
<tbody>
<tr>
<td align="center">trace-pc,indirect-calls</td>
<td align="center">__sanitizer_cov_trace_pc_indirect</td>
<td align="center">ValueProfileMap</td>
</tr>
<tr>
<td align="center">trace-pc-guard,indirect-calls</td>
<td align="center">__sanitizer_cov_trace_pc_indirect</td>
<td align="center">ValueProfileMap</td>
</tr>
<tr>
<td align="center">inline-8bit-counters,indirect-calls</td>
<td align="center">__sanitizer_cov_trace_pc_indirect</td>
<td align="center">ValueProfileMap</td>
</tr>
<tr>
<td align="center">inline-bool-flag,indirect-calls</td>
<td align="center">__sanitizer_cov_trace_pc_indirect</td>
<td align="center">ValueProfileMap</td>
</tr>
<tr>
<td align="center">trace-cmp</td>
<td align="center">__sanitizer_cov_trace_[const_]cmp[1|2|4|8]</td>
<td align="center">ValuleProfileMap</td>
</tr>
<tr>
<td align="center">trace-switch</td>
<td align="center">__sanitizer_cov_trace_switch</td>
<td align="center">ValuleProfileMap</td>
</tr>
<tr>
<td align="center">trace-div</td>
<td align="center">__sanitizer_cov_trace_div[4|8]</td>
<td align="center">ValuleProfileMap</td>
</tr>
<tr>
<td align="center">trace-gep</td>
<td align="center">__sanitizer_cov_trace_gep</td>
<td align="center">ValuleProfileMap</td>
</tr>
<tr>
<td align="center">trace-pc</td>
<td align="center">__sanitizer_cov_trace_pc</td>
<td align="center">deprecated</td>
</tr>
<tr>
<td align="center">trace-pc-guard</td>
<td align="center">__sanitizer_cov_trace_pc_guard[_init]</td>
<td align="center">deprecated</td>
</tr>
<tr>
<td align="center">inline-8bit-counters</td>
<td align="center">__sanitizer_cov_8bit_counters_init</td>
<td align="center">Modules</td>
</tr>
<tr>
<td align="center">inline-bool-flag</td>
<td align="center">__sanitizer_cov_bool_flag_init</td>
<td align="center">not supported</td>
</tr>
<tr>
<td align="center">trace-pc-guard,pc-table</td>
<td align="center">__sanitizer_cov_pcs_init</td>
<td align="center">ModulePCTable</td>
</tr>
<tr>
<td align="center">inline-8bit-guard,pc-table</td>
<td align="center">__sanitizer_cov_pcs_init</td>
<td align="center">ModulePCTable</td>
</tr>
<tr>
<td align="center">inline-bool-flag,pc-table</td>
<td align="center">__sanitizer_cov_pcs_init</td>
<td align="center">ModulePCTable</td>
</tr>
</tbody>
</table>
<h2 id="details-of-coverage-collection-algorithm-and-implementation">Details of coverage collection algorithm and implementation<a class="headerlink" href="#details-of-coverage-collection-algorithm-and-implementation" title="Do what you think is right">#</a></h2>
<p>Recalling that several stubs are instrumented to the target program. The implementation of these stubs are implemented in libFuzzer by default or can be replaced by developers. Most of them are defined in compiler-rt/lib/fuzzer/FuzzerTracePC.cpp. After testing an input, these stubs will update corresponding information. LibFuzzer will then calculate the coverage with the information. A detailed flow is in the following.</p>
<div class="highlight"><pre><span></span><code><span class="n">ExecuteCallback</span>
<span class="w">    </span><span class="o">-</span><span class="w"> </span><span class="n">TPC</span><span class="p">.</span><span class="n">ResetMaps</span><span class="p">();</span>
<span class="w">    </span><span class="o">-</span><span class="w"> </span><span class="n">CB</span><span class="p">(</span><span class="n">DataCopy</span><span class="p">,</span><span class="w"> </span><span class="n">Size</span><span class="p">);</span>
<span class="n">TPC</span><span class="p">.</span><span class="n">CollectFeatures</span><span class="p">();</span>
<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">NumNewFeatures</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">ForceAddToCorpus</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">TPC</span><span class="p">.</span><span class="n">UpdateObservedPCs</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="resetmaps">ResetMaps<a class="headerlink" href="#resetmaps" title="Do what you think is right">#</a></h3>
<div class="highlight"><pre><span></span><code><span class="k">template</span><span class="w"> </span><span class="o">&lt;</span><span class="k">class</span><span class="w"> </span><span class="nc">Callback</span><span class="o">&gt;</span>
<span class="kt">void</span><span class="w"> </span><span class="n">IterateCounterRegions</span><span class="p">(</span><span class="n">Callback</span><span class="w"> </span><span class="n">CB</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">NumModules</span><span class="p">;</span><span class="w"> </span><span class="n">m</span><span class="o">++</span><span class="p">)</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">Modules</span><span class="p">[</span><span class="n">m</span><span class="p">].</span><span class="n">NumRegions</span><span class="p">;</span><span class="w"> </span><span class="n">r</span><span class="o">++</span><span class="p">)</span>
<span class="w">      </span><span class="n">CB</span><span class="p">(</span><span class="n">Modules</span><span class="p">[</span><span class="n">m</span><span class="p">].</span><span class="n">Regions</span><span class="p">[</span><span class="n">r</span><span class="p">]);</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="n">TracePC</span><span class="o">::</span><span class="n">ClearInlineCounters</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">IterateCounterRegions</span><span class="p">([](</span><span class="k">const</span><span class="w"> </span><span class="n">Module</span><span class="o">::</span><span class="n">Region</span><span class="w"> </span><span class="o">&amp;</span><span class="n">R</span><span class="p">){</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">R</span><span class="p">.</span><span class="n">Enabled</span><span class="p">)</span>
<span class="w">      </span><span class="n">memset</span><span class="p">(</span><span class="n">R</span><span class="p">.</span><span class="n">Start</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">R</span><span class="p">.</span><span class="n">Stop</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">R</span><span class="p">.</span><span class="n">Start</span><span class="p">);</span>
<span class="w">  </span><span class="p">});</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="n">ResetMaps</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">ValueProfileMap</span><span class="p">.</span><span class="n">Reset</span><span class="p">();</span>
<span class="w">  </span><span class="n">ClearExtraCounters</span><span class="p">();</span>
<span class="w">  </span><span class="n">ClearInlineCounters</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div>
<p>TPC.ResetMaps reset 1) ValueProfileMap, a bit map for data flow value, 2)
ExtraCounters, 3) InlineCouters, the area for <code>inline-8bit-counters</code>.</p>
<h3 id="collectfeatures">CollectFeatures<a class="headerlink" href="#collectfeatures" title="Do what you think is right">#</a></h3>
<div class="highlight"><pre><span></span><code><span class="kt">size_t</span><span class="w"> </span><span class="n">NumUpdatesBefore</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Corpus</span><span class="p">.</span><span class="n">NumFeatureUpdates</span><span class="p">();</span>
<span class="n">TPC</span><span class="p">.</span><span class="n">CollectFeatures</span><span class="p">([</span><span class="o">&amp;</span><span class="p">](</span><span class="kt">size_t</span><span class="w"> </span><span class="n">Feature</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Corpus</span><span class="p">.</span><span class="n">AddFeature</span><span class="p">(</span><span class="n">Feature</span><span class="p">,</span><span class="w"> </span><span class="n">Size</span><span class="p">,</span><span class="w"> </span><span class="n">Options</span><span class="p">.</span><span class="n">Shrink</span><span class="p">))</span>
<span class="w">    </span><span class="c1">// *</span>
<span class="p">});</span>
</code></pre></div>
<p><code>TPC.CollectFeatures</code> accepts a HandleFeature function pointer. In the
HandleFeature, it accepts a Feature that is calculated from all the coverage
information (Information Sink), and then adds the feature to the corpus.</p>
<p>AddFeature is part of the HandleFeature function to log features. libFuzzer will
map a feature to the size of the corresponding input.  If the size is zero, the
feature is not visited.</p>
<div class="highlight"><pre><span></span><code><span class="kt">bool</span><span class="w"> </span><span class="nf">AddFeature</span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">Idx</span><span class="p">,</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">NewSize</span><span class="p">,</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">Shrink</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">Idx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Idx</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="n">kFeatureSetSize</span><span class="p">;</span>
<span class="w">  </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">OldSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GetFeature</span><span class="p">(</span><span class="n">Idx</span><span class="p">);</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">OldSize</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">(</span><span class="n">Shrink</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">OldSize</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">NewSize</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">OldSize</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="c1">// ...</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="n">NumAddedFeatures</span><span class="o">++</span><span class="p">;</span>
<span class="w">      </span><span class="c1">// ...</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">NumUpdatedFeatures</span><span class="o">++</span><span class="p">;</span>
<span class="w">    </span><span class="n">InputSizesPerFeature</span><span class="p">[</span><span class="n">Idx</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NewSize</span><span class="p">;</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p>In <code>TPC.CollectFeatures</code>, it maps the information sinks to features like below.</p>
<div class="highlight"><pre><span></span><code>// Modules (Inlint8BitCounters)
FirstFeature=0
                         feature
      0    8    w/o counters  w/ counters
      +----+
BB00  +d&#39;02+    +0            +(0*8 + log(2))
      +----+
BB01  +d&#39;80+    +1            +(1*8 + log(80))
      +----+
FirstFeature += NumOfBits(Modules)
// ExtracCounters
      0    8    w/o counters  w/ counters
      +----+
CNT0  +d&#39;02+    +0            +(0*8 + log(2))
      +----+
CNT1  +d&#39;80+    +1            +(1*8 + log(80))
      +----+
FirstFeature += NumOfBits(ExtraCounters)
// ValueProfileMap
      0    8
      +----+
VPM0  +d&#39;02+    +6 (b&#39;00000010)
      +----+
VPM8  +d&#39;82+    +8/+14 (b&#39;10000010)
      +----+
FirstFeature += NumOfBits(ValueProfileMap)
// StackDepth
                + StackDepthStepFunction(MaxStackOffset / 8)
</code></pre></div>
<p>In general, we map coverage information to a linear feature from zero. For the
<code>Modules</code>, libFuzzer checks each byte that records how many times a basic block is
visited. If without counters, the feature is the start feature plus the index of
the bytes. For BB01, if the index is 1, then the feature is 1. If with counter,
it will take d'80 into consideration. The feature is 0 plus log(80). The
logarithmic function guarantees the feature will not overflow 8 bits. In the
end, the start of the new features will be updated by adding the bit number of
modules. <code>ExtraCounters</code> works similarly. For the ValueProfileMap, each non-zero
bit is a new feature. For the stack depth, it leverages a hash function
StackDepthStepFunction.</p>
<h3 id="updateobservedpcs">UpdateObservedPCs<a class="headerlink" href="#updateobservedpcs" title="Do what you think is right">#</a></h3>
<p>If any new features, libFuzzer will update observed PCs.</p>
<div class="highlight"><pre><span></span><code><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">NumModules</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">auto</span><span class="w"> </span><span class="o">&amp;</span><span class="n">M</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Modules</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">M</span><span class="p">.</span><span class="n">NumRegions</span><span class="p">;</span><span class="w"> </span><span class="n">r</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="o">&amp;</span><span class="n">R</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">M</span><span class="p">.</span><span class="n">Regions</span><span class="p">[</span><span class="n">r</span><span class="p">];</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">R</span><span class="p">.</span><span class="n">Enabled</span><span class="p">)</span><span class="w"> </span><span class="k">continue</span><span class="p">;</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="n">P</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">R</span><span class="p">.</span><span class="n">Start</span><span class="p">;</span><span class="w"> </span><span class="n">P</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">R</span><span class="p">.</span><span class="n">Stop</span><span class="p">;</span><span class="w"> </span><span class="n">P</span><span class="o">++</span><span class="p">)</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">P</span><span class="p">)</span><span class="w"> </span><span class="c1">// if this basic block is visited</span>
<span class="w">        </span><span class="c1">// then get the PC of the visited the basic block</span>
<span class="w">        </span><span class="c1">// then invoke Observe</span>
<span class="w">        </span><span class="n">Observe</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ModulePCTable</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">Start</span><span class="p">[</span><span class="n">M</span><span class="p">.</span><span class="n">Idx</span><span class="p">(</span><span class="n">P</span><span class="p">)]);</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>First, if a basic block is visited, libFuzzer will get the PC of the visited the
basic in the PCTable, and invoke <code>Observe</code>.</p>
<div class="highlight"><pre><span></span><code><span class="n">Vector</span><span class="o">&lt;</span><span class="kt">uintptr_t</span><span class="o">&gt;</span><span class="w"> </span><span class="n">CoveredFuncs</span><span class="p">;</span>
<span class="k">auto</span><span class="w"> </span><span class="n">ObservePC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="o">&amp;</span><span class="p">](</span><span class="k">const</span><span class="w"> </span><span class="n">PCTableEntry</span><span class="w"> </span><span class="o">*</span><span class="n">TE</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ObservedPCs</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="n">TE</span><span class="p">).</span><span class="n">second</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">DoPrintNewPCs</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">PrintPC</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t</span><span class="s">NEW_PC: %p %F %L&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\t</span><span class="s">NEW_PC: %p&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="n">GetNextInstructionPc</span><span class="p">(</span><span class="n">TE</span><span class="o">-&gt;</span><span class="n">PC</span><span class="p">));</span>
<span class="w">    </span><span class="n">Printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">};</span>

<span class="k">auto</span><span class="w"> </span><span class="n">Observe</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="o">&amp;</span><span class="p">](</span><span class="k">const</span><span class="w"> </span><span class="n">PCTableEntry</span><span class="w"> </span><span class="o">*</span><span class="n">TE</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">PcIsFuncEntry</span><span class="p">(</span><span class="n">TE</span><span class="p">))</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">++</span><span class="n">ObservedFuncs</span><span class="p">[</span><span class="n">TE</span><span class="o">-&gt;</span><span class="n">PC</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">NumPrintNewFuncs</span><span class="p">)</span>
<span class="w">      </span><span class="n">CoveredFuncs</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">TE</span><span class="o">-&gt;</span><span class="n">PC</span><span class="p">);</span>
<span class="w">  </span><span class="n">ObservePC</span><span class="p">(</span><span class="n">TE</span><span class="p">);</span>
<span class="p">};</span>
</code></pre></div>
<p>If the basic block is the entry, then update <code>ObservedFunc</code>. Otherwise, invoke
<code>ObservePC</code> to update <code>ObservedPCs</code>.</p>
<h2 id="libfuzzer-intercepts">libFuzzer intercepts<a class="headerlink" href="#libfuzzer-intercepts" title="Do what you think is right">#</a></h2>
<p>LibFuzzer will intercepts <code>memcmp</code>, <code>strncmp</code>, <code>strcmp</code>, <code>strncasecmp</code>,
<code>strcasecmp</code>, <code>strstr</code>, <code>strcasestr</code>, and <code>memmem</code> functions if no ASAN, TSAN,
MSAN runtime is enabled. It is not easy to disable this behavior.</p>
<p>A typical flow for each above function is in the following.</p>
<div class="highlight"><pre><span></span><code><span class="w">    </span><span class="n">RunningUserCallback</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">Res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CB</span><span class="p">(</span><span class="n">DataCopy</span><span class="p">,</span><span class="w"> </span><span class="n">Size</span><span class="p">);</span>
<span class="w">    </span><span class="n">RunningUserCallback</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>

<span class="kt">int</span><span class="w"> </span><span class="nf">memcmp</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">s1</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">s2</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">FuzzerInited</span><span class="p">)</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">internal_memcmp</span><span class="p">(</span><span class="n">s1</span><span class="p">,</span><span class="w"> </span><span class="n">s2</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">);</span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">REAL</span><span class="p">(</span><span class="n">memcmp</span><span class="p">)(</span><span class="n">s1</span><span class="p">,</span><span class="w"> </span><span class="n">s2</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">);</span>
<span class="w">  </span><span class="n">__sanitizer_weak_hook_memcmp</span><span class="p">(</span><span class="n">GET_CALLER_PC</span><span class="p">(),</span><span class="w"> </span><span class="n">s1</span><span class="p">,</span><span class="w"> </span><span class="n">s2</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="n">result</span><span class="p">);</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">__sanitizer_weak_hook_memcmp</span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">caller_pc</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">s1</span><span class="p">,</span>
<span class="w">                                  </span><span class="k">const</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">s2</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">result</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">fuzzer</span><span class="o">::</span><span class="n">RunningUserCallback</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="p">;</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">result</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="p">;</span><span class="w">  </span><span class="c1">// No reason to mutate.</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">n</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="p">;</span><span class="w">  </span><span class="c1">// Not interesting.</span>
<span class="w">  </span><span class="n">fuzzer</span><span class="o">::</span><span class="n">TPC</span><span class="p">.</span><span class="n">AddValueForMemcmp</span><span class="p">(</span><span class="n">caller_pc</span><span class="p">,</span><span class="w"> </span><span class="n">s1</span><span class="p">,</span><span class="w"> </span><span class="n">s2</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="cm">/*StopAtZero*/</span><span class="nb">false</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<p>Here is a summary of where the collected information will flow.</p>
<table>
<thead>
<tr>
<th align="center">Function</th>
<th align="center"></th>
<th align="center">Information Sink</th>
</tr>
</thead>
<tbody>
<tr>
<td align="center">memcmp</td>
<td align="center">AddValueForMemcmp</td>
<td align="center">ValueProfileMap</td>
</tr>
<tr>
<td align="center">strnmp</td>
<td align="center">AddValueForMemcmp</td>
<td align="center">ValueProfileMap</td>
</tr>
<tr>
<td align="center">strcmp</td>
<td align="center">AddValueForMemcmp</td>
<td align="center">ValueProfileMap</td>
</tr>
<tr>
<td align="center">strncasecmp</td>
<td align="center">AddValueForMemcmp</td>
<td align="center">ValueProfileMap</td>
</tr>
<tr>
<td align="center">strcasecmp</td>
<td align="center"></td>
<td align="center">AddValueForMemcmp</td>
</tr>
<tr>
<td align="center">strstr</td>
<td align="center"></td>
<td align="center">MMT(Mutation Only)</td>
</tr>
<tr>
<td align="center">strcasestr</td>
<td align="center"></td>
<td align="center">MMT(Mutation Only)</td>
</tr>
<tr>
<td align="center">memmem</td>
<td align="center"></td>
<td align="center">MMT(Mutation Only)</td>
</tr>
</tbody>
</table>
<p>To disable them, we could 1) use <code>-use_value_profile=0</code> when fuzzing to avoid
update coverage information from ValueProfileMap, 2) comment these
<code>__sanitizer_weak_hook_xxx</code> to reduce the overhead. Luckily,
<code>-use_value_profile=0</code> is the default option of libFuzzer.</p>
<h2 id="conclusion">Conclusion<a class="headerlink" href="#conclusion" title="Do what you think is right">#</a></h2>
<ul>
<li>
<p>For the basic block coverage, SanCov maintains an array that records how many
times a basic block is visited, and the libFuzzer will collect that information
and calculate features.</p>
</li>
<li>
<p>To disable fancy features, just do as below.</p>
</li>
</ul>
<div class="highlight"><pre><span></span><code>clang<span class="w"> </span>-o<span class="w"> </span>foo<span class="w"> </span>-fsanitize<span class="o">=</span>fuzzer<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-fsanitize-coverage<span class="o">=</span>bb<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-fno-sanitize-coverage<span class="o">=</span>indirect-calls,trace-cmp,stack-depth,pc-table<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>foo.c
</code></pre></div>
<div class="footnote">
<hr />
<ol>
<li id="fn:1">
<p><a href="https://clang.llvm.org/docs/SanitizerCoverage.html#edge-coverage">Clangedge-coverage</a>&#160;<a class="footnote-backref" href="#fnref:1" title="Jump back to footnote 1 in the text">&#8617;</a></p>
</li>
</ol>
</div>







  
  



  


  



      
    </article>
  </div>

          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
    
      
        
      
      <nav class="md-footer__inner md-grid" aria-label="Footer" >
        
          
          <a href="../../../10/27/introduction-to-bhyve/" class="md-footer__link md-footer__link--prev" aria-label="Previous: Introduction to Bhyve">
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
            </div>
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Previous
              </span>
              <div class="md-ellipsis">
                Introduction to Bhyve
              </div>
            </div>
          </a>
        
        
          
          <a href="../../../12/13/a-brief-summary-of-cs-725/" class="md-footer__link md-footer__link--next" aria-label="Next: A brief summary of CS-725">
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Next
              </span>
              <div class="md-ellipsis">
                A brief summary of CS-725
              </div>
            </div>
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11z"/></svg>
            </div>
          </a>
        
      </nav>
    
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright &copy; 2018 - 2025, Qiang Liu. All rights reserved.
    </div>
  
  
</div>
      
        
<div class="md-social">
  
    
    
    
    
    <a href="/" target="_blank" rel="noopener" title="Home" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg>
    </a>
  
    
    
    
    
    <a href="mailto:cyruscyliu@gmail.com" target="_blank" rel="noopener" title="" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m20 8-8 5-8-5V6l8 5 8-5m0-2H4c-1.11 0-2 .89-2 2v12a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2"/></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://www.linkedin.com/in/qiangliu15/" target="_blank" rel="noopener" title="www.linkedin.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path fill="currentColor" d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3M135.4 416H69V202.2h66.5V416zM102.2 96a38.5 38.5 0 1 1 0 77 38.5 38.5 0 1 1 0-77m282.1 320h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9z"/></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="weixin://dl/chat?ocat01" target="_blank" rel="noopener" title="dl" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.691 2.188C3.891 2.188 0 5.476 0 9.53c0 2.212 1.17 4.203 3.002 5.55a.59.59 0 0 1 .213.665l-.39 1.48c-.019.07-.048.141-.048.213 0 .163.13.295.29.295a.33.33 0 0 0 .167-.054l1.903-1.114a.86.86 0 0 1 .717-.098 10.2 10.2 0 0 0 2.837.403c.276 0 .543-.027.811-.05-.857-2.578.157-4.972 1.932-6.446 1.703-1.415 3.882-1.98 5.853-1.838-.576-3.583-4.196-6.348-8.596-6.348M5.785 5.991c.642 0 1.162.529 1.162 1.18a1.17 1.17 0 0 1-1.162 1.178A1.17 1.17 0 0 1 4.623 7.17c0-.651.52-1.18 1.162-1.18zm5.813 0c.642 0 1.162.529 1.162 1.18a1.17 1.17 0 0 1-1.162 1.178 1.17 1.17 0 0 1-1.162-1.178c0-.651.52-1.18 1.162-1.18m5.34 2.867c-1.797-.052-3.746.512-5.28 1.786-1.72 1.428-2.687 3.72-1.78 6.22.942 2.453 3.666 4.229 6.884 4.229.826 0 1.622-.12 2.361-.336a.72.72 0 0 1 .598.082l1.584.926a.3.3 0 0 0 .14.047c.134 0 .24-.111.24-.247 0-.06-.023-.12-.038-.177l-.327-1.233a.6.6 0 0 1-.023-.156.49.49 0 0 1 .201-.398C23.024 18.48 24 16.82 24 14.98c0-3.21-2.931-5.837-6.656-6.088V8.89c-.135-.01-.27-.027-.407-.03zm-2.53 3.274c.535 0 .969.44.969.982a.976.976 0 0 1-.969.983.976.976 0 0 1-.969-.983c0-.542.434-.982.97-.982zm4.844 0c.535 0 .969.44.969.982a.976.976 0 0 1-.969.983.976.976 0 0 1-.969-.983c0-.542.434-.982.969-.982"/></svg>
    </a>
  
    
    
    
    
    <a href="Qiang_s_CV.pdf" target="_blank" rel="noopener" title="" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 9h5.5L13 3.5zM6 2h8l6 6v12a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V4c0-1.11.89-2 2-2m8 18v-1c0-1.33-2.67-2-4-2s-4 .67-4 2v1zm-4-8a2 2 0 0 0-2 2 2 2 0 0 0 2 2 2 2 0 0 0 2-2 2 2 0 0 0-2-2"/></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://scholar.google.com/citations?user=fa1uB2sAAAAJ&hl=en" target="_blank" rel="noopener" title="scholar.google.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M5.242 13.769 0 9.5 12 0l12 9.5-5.242 4.269C17.548 11.249 14.978 9.5 12 9.5c-2.977 0-5.548 1.748-6.758 4.269M12 10a7 7 0 1 0 0 14 7 7 0 0 0 0-14"/></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://github.com/cyruscyliu" target="_blank" rel="noopener" title="github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "../../../../..", "features": ["navigation.tracking", "navigation.path", "navigation.top", "navigation.footer", "navigation.indexes", "navigation.expand", "toc.integrate", "footer.prev_next", "revision.date", "revision.history"], "search": "../../../../../assets/javascripts/workers/search.973d3a69.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../../../../assets/javascripts/bundle.92b07e13.min.js"></script>
      
    
  </body>
</html>