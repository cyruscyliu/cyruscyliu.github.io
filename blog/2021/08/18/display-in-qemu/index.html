
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://github.com/cyruscyliu/cyruscyliu.github.io/blog/2021/08/18/display-in-qemu/">
      
      
        <link rel="prev" href="../../../../2020/11/30/clang-wllvm-passes-qemulinux-kernel-for-x86_64/">
      
      
        <link rel="next" href="../../../10/27/introduction-to-bhyve/">
      
      
      <link rel="icon" href="../../../../../logo.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.18">
    
    
      
        <title>Display in QEMU - Qiang Liu - System Security</title>
      
    
    
      <link rel="stylesheet" href="../../../../../assets/stylesheets/main.7e37652d.min.css">
      
        
        <link rel="stylesheet" href="../../../../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../../../../stylesheets/extra.css">
    
    <script>__md_scope=new URL("../../../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      
  


  
  

<script id="__analytics">function __md_analytics(){function e(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],e("js",new Date),e("config","G-KWJ9PWFFMZ"),document.addEventListener("DOMContentLoaded",(function(){document.forms.search&&document.forms.search.query.addEventListener("blur",(function(){this.value&&e("event","search",{search_term:this.value})}));document$.subscribe((function(){var t=document.forms.feedback;if(void 0!==t)for(var a of t.querySelectorAll("[type=submit]"))a.addEventListener("click",(function(a){a.preventDefault();var n=document.location.pathname,d=this.getAttribute("data-md-value");e("event","feedback",{page:n,data:d}),t.firstElementChild.disabled=!0;var r=t.querySelector(".md-feedback__note [data-md-value='"+d+"']");r&&(r.hidden=!1)})),t.hidden=!1})),location$.subscribe((function(t){e("config","G-KWJ9PWFFMZ",{page_path:t.pathname})}))}));var t=document.createElement("script");t.async=!0,t.src="https://www.googletagmanager.com/gtag/js?id=G-KWJ9PWFFMZ",document.getElementById("__analytics").insertAdjacentElement("afterEnd",t)}</script>
  
    <script>"undefined"!=typeof __md_analytics&&__md_analytics()</script>
  

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="white" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#display-in-qemu" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../../../.." title="Qiang Liu - System Security" class="md-header__button md-logo" aria-label="Qiang Liu - System Security" data-md-component="logo">
      
  <img src="../../../../../logo.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Qiang Liu - System Security
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Display in QEMU
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="white" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m17.75 4.09-2.53 1.94.91 3.06-2.63-1.81-2.63 1.81.91-3.06-2.53-1.94L12.44 4l1.06-3 1.06 3zm3.5 6.91-1.64 1.25.59 1.98-1.7-1.17-1.7 1.17.59-1.98L15.75 11l2.06-.05L18.5 9l.69 1.95zm-2.28 4.95c.83-.08 1.72 1.1 1.19 1.85-.32.45-.66.87-1.08 1.27C15.17 23 8.84 23 4.94 19.07c-3.91-3.9-3.91-10.24 0-14.14.4-.4.82-.76 1.27-1.08.75-.53 1.93.36 1.85 1.19-.27 2.86.69 5.83 2.89 8.02a9.96 9.96 0 0 0 8.02 2.89m-1.64 2.02a12.08 12.08 0 0 1-7.8-3.47c-2.17-2.19-3.33-5-3.49-7.82-2.81 3.14-2.7 7.96.31 10.98 3.02 3.01 7.84 3.12 10.98.31"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="black" data-md-color-accent="light-blue"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 7a5 5 0 0 1 5 5 5 5 0 0 1-5 5 5 5 0 0 1-5-5 5 5 0 0 1 5-5m0 2a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3m0-7 2.39 3.42C13.65 5.15 12.84 5 12 5s-1.65.15-2.39.42zM3.34 7l4.16-.35A7.2 7.2 0 0 0 5.94 8.5c-.44.74-.69 1.5-.83 2.29zm.02 10 1.76-3.77a7.131 7.131 0 0 0 2.38 4.14zM20.65 7l-1.77 3.79a7.02 7.02 0 0 0-2.38-4.15zm-.01 10-4.14.36c.59-.51 1.12-1.14 1.54-1.86.42-.73.69-1.5.83-2.29zM12 22l-2.41-3.44c.74.27 1.55.44 2.41.44.82 0 1.63-.17 2.37-.44z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
                
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" hidden>
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



  

<nav class="md-nav md-nav--primary md-nav--integrated" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../../../.." title="Qiang Liu - System Security" class="md-nav__button md-logo" aria-label="Qiang Liu - System Security" data-md-component="logo">
      
  <img src="../../../../../logo.png" alt="logo">

    </a>
    Qiang Liu - System Security
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Home
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../projects/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Projects
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../services/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Services
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" checked>
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../../../" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    Blog
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_4" id="__nav_4_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            Blog
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../tags/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Tags
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_4_3" >
        
          
          <label class="md-nav__link" for="__nav_4_3" id="__nav_4_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Archive
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_3">
            <span class="md-nav__icon md-icon"></span>
            Archive
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../../archive/2025/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    2025
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../../archive/2024/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    2024
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../../archive/2023/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    2023
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../../archive/2022/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    2022
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../../archive/2021/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    2021
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../../archive/2020/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    2020
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../../archive/2019/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    2019
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../../archive/2018/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    2018
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_4_4" >
        
          
          <label class="md-nav__link" for="__nav_4_4" id="__nav_4_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Categories
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_4">
            <span class="md-nav__icon md-icon"></span>
            Categories
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../../category/diary/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    diary
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../../category/how-to-do-research-series/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    how-to-do-research-series
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../../category/tech-notes/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    tech-notes
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          
  <div class="md-content md-content--post" data-md-component="content">
    <div class="md-sidebar md-sidebar--post" data-md-component="sidebar" data-md-type="navigation">
      <div class="md-sidebar__scrollwrap">
        <div class="md-sidebar__inner md-post">
          <nav class="md-nav md-nav--primary">
            <div class="md-post__back">
              <div class="md-nav__title md-nav__container">
                <a href="../../../../" class="md-nav__link">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
                  <span class="md-ellipsis">
                    Back to index
                  </span>
                </a>
              </div>
            </div>
            
            <ul class="md-post__meta md-nav__list">
              <li class="md-nav__item md-nav__item--section">
                <div class="md-post__title">
                  <span class="md-ellipsis">
                    Metadata
                  </span>
                </div>
                <nav class="md-nav">
                  <ul class="md-nav__list">
                    <li class="md-nav__item">
                      <div class="md-nav__link">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 19H5V8h14m-3-7v2H8V1H6v2H5c-1.11 0-2 .89-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V5a2 2 0 0 0-2-2h-1V1m-1 11h-5v5h5z"/></svg>
                        <time datetime="2021-08-18 00:00:00+00:00" class="md-ellipsis">August 18, 2021</time>
                      </div>
                    </li>
                    
                    
                      <li class="md-nav__item">
                        <div class="md-nav__link">
                          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9 3v15h3V3zm3 2 4 13 3-1-4-13zM5 5v13h3V5zM3 19v2h18v-2z"/></svg>
                          <span class="md-ellipsis">
                            in
                            
                              <a href="../../../../category/tech-notes/">tech-notes</a></span>
                        </div>
                      </li>
                    
                    
                      
                      <li class="md-nav__item">
                        <div class="md-nav__link">
                          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 20a8 8 0 0 0 8-8 8 8 0 0 0-8-8 8 8 0 0 0-8 8 8 8 0 0 0 8 8m0-18a10 10 0 0 1 10 10 10 10 0 0 1-10 10C6.47 22 2 17.5 2 12A10 10 0 0 1 12 2m.5 5v5.25l4.5 2.67-.75 1.23L11 13V7z"/></svg>
                          <span class="md-ellipsis">
                            
                              6 min read
                            
                          </span>
                        </div>
                      </li>
                    
                  </ul>
                </nav>
              </li>
            </ul>
            
          </nav>
          
            

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#qemu-displays" class="md-nav__link">
    <span class="md-ellipsis">
      QEMU Displays
    </span>
  </a>
  
    <nav class="md-nav" aria-label="QEMU Displays">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#qemu-display-options" class="md-nav__link">
    <span class="md-ellipsis">
      QEMU Display options
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#in-qemu-the-registration-process-is-in-the-following" class="md-nav__link">
    <span class="md-ellipsis">
      In QEMU, the registration process is in the following.
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#qemu-console" class="md-nav__link">
    <span class="md-ellipsis">
      QEMU Console
    </span>
  </a>
  
    <nav class="md-nav" aria-label="QEMU Console">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#qemu-consoles-are-defined-as-a-list-of-qemuconsole" class="md-nav__link">
    <span class="md-ellipsis">
      QEMU consoles are defined as a list of QemuConsole.
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#qemu-consoles-have-three-types" class="md-nav__link">
    <span class="md-ellipsis">
      QEMU consoles have three types.
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#qemu-consoles-are-initialized-by-new_console" class="md-nav__link">
    <span class="md-ellipsis">
      QEMU consoles are initialized by new_console.
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#qemu-consoles-qemu-video-devices-and-qemu-displays" class="md-nav__link">
    <span class="md-ellipsis">
      QEMU consoles, QEMU video devices and QEMU displays
    </span>
  </a>
  
    <nav class="md-nav" aria-label="QEMU consoles, QEMU video devices and QEMU displays">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#a-typical-example-would-be-graphic_console_init" class="md-nav__link">
    <span class="md-ellipsis">
      A typical example would be graphic_console_init.
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#when-it-comes-to-a-text-console-things-are-similar" class="md-nav__link">
    <span class="md-ellipsis">
      When it comes to a text console, things are similar.
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#interactions-through-qemu-consoles" class="md-nav__link">
    <span class="md-ellipsis">
      Interactions through QEMU consoles
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Interactions through QEMU consoles">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#first-of-all-we-will-figure-out-when-the-hw_ops-are-called" class="md-nav__link">
    <span class="md-ellipsis">
      First of all, we will figure out when the hw_ops are called.
    </span>
  </a>
  
    <nav class="md-nav" aria-label="First of all, we will figure out when the hw_ops are called.">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#group-1-graphic_hw_xxx" class="md-nav__link">
    <span class="md-ellipsis">
      Group 1: graphic_hw_xxx
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#group-2-gui_update-update_interval" class="md-nav__link">
    <span class="md-ellipsis">
      Group 2: gui_update -&gt; update_interval
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#group-3-dpy_compatible_with-and-dpy_set_ui_info_timer" class="md-nav__link">
    <span class="md-ellipsis">
      Group 3: dpy_compatible_with and dpy_set_ui_info_timer
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#second-we-will-figure-out-how-the-display-listener-callbacks-work" class="md-nav__link">
    <span class="md-ellipsis">
      Second, we will figure out how the display listener callbacks work.
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Second, we will figure out how the display listener callbacks work.">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#an-example-of-graphic-qemu-display" class="md-nav__link">
    <span class="md-ellipsis">
      An example of graphic QEMU display
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#what-about-together" class="md-nav__link">
    <span class="md-ellipsis">
      What about together?
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
          
        </div>
      </div>
    </div>
    <article class="md-content__inner md-typeset">
      
        
  




<h1 id="display-in-qemu">Display in QEMU<a class="headerlink" href="#display-in-qemu" title="Do what you think is right">#</a></h1>
<p>Gerd Hoffmann has introduced graphics in QEMU here and there<sup id="fnref:1"><a class="footnote-ref" href="#fn:1">1</a></sup>, and in this
article, I will do some basic introduction about QEMU displays and QEMU consoles
with QEMU code (QEMU 6.1.0-rc3).</p>
<!-- more -->

<h2 id="qemu-displays">QEMU Displays<a class="headerlink" href="#qemu-displays" title="Do what you think is right">#</a></h2>
<p>QEMU displays are a set of display change listeners with the support of text or
graphic tools on the host machine.</p>
<h3 id="qemu-display-options">QEMU Display options<a class="headerlink" href="#qemu-display-options" title="Do what you think is right">#</a></h3>
<p>As claimed <a href="https://wiki.gentoo.org/wiki/QEMU/Options">here</a>, we can send the
QEMU display to sdl/curses/gtk/vnc/spice windows, or just do not display video
output. Only curses supports text mode. "Nothing is displayed when the graphics
device is in graphical mode or if the graphics device does not support a text
mode. Generally, only the VGA device models support text mode."</p>
<p>To talk to the host, each display has a change listener with several callbacks
that would call the relative APIs. For example, <code>curses_update</code> will call
<a href="https://linux.die.net/man/3/pnoutrefresh"><code>pnoutrefresh</code></a>.</p>
<div class="highlight"><pre><span></span><code><span class="k">static</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">DisplayChangeListenerOps</span><span class="w"> </span><span class="n">dcl_ops</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="p">.</span><span class="n">dpy_name</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;curses&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="p">.</span><span class="n">dpy_text_update</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">curses_update</span><span class="p">,</span>
<span class="w">    </span><span class="p">.</span><span class="n">dpy_text_resize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">curses_resize</span><span class="p">,</span>
<span class="w">    </span><span class="p">.</span><span class="n">dpy_refresh</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="n">curses_refresh</span><span class="p">,</span>
<span class="w">    </span><span class="p">.</span><span class="n">dpy_text_cursor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">curses_cursor_position</span><span class="p">,</span>
<span class="p">};</span>
</code></pre></div>
<p>Here are all change listener callbacks.</p>
<div class="highlight"><pre><span></span><code>ui/curses.c:767:static const DisplayChangeListenerOps dcl_ops = {
ui/sdl2.c:761:static const DisplayChangeListenerOps dcl_2d_ops = {
ui/sdl2.c:772:static const DisplayChangeListenerOps dcl_gl_ops = {
ui/spice-display.c:775:static const DisplayChangeListenerOps display_listener_ops = {
ui/spice-display.c:1096:static const DisplayChangeListenerOps display_listener_gl_ops = {
ui/egl-headless.c:154:static const DisplayChangeListenerOps egl_ops = {
ui/cocoa.m:86:static const DisplayChangeListenerOps dcl_ops = {
ui/gtk.c:607:static const DisplayChangeListenerOps dcl_ops = {
ui/gtk.c:635:static const DisplayChangeListenerOps dcl_gl_area_ops = {
ui/gtk.c:656:static const DisplayChangeListenerOps dcl_egl_ops = {
ui/vnc.c:3337:static const DisplayChangeListenerOps dcl_ops = {
</code></pre></div>
<h3 id="in-qemu-the-registration-process-is-in-the-following">In QEMU, the registration process is in the following.<a class="headerlink" href="#in-qemu-the-registration-process-is-in-the-following" title="Do what you think is right">#</a></h3>
<p>First, <code>qemu_display_register</code> will register all <code>QemuDisplay</code> objects to
<code>dpys[DISPLAY_TYPE__MAX]</code>.</p>
<div class="highlight"><pre><span></span><code>static QemuDisplay *dpys[DISPLAY_TYPE__MAX];

void qemu_display_register(QemuDisplay *ui) {
    assert(ui-&gt;type &lt; DISPLAY_TYPE__MAX);
    dpys[ui-&gt;type] = ui; // S3
}

static QemuDisplay qemu_display_curses = {
    .type       = DISPLAY_TYPE_CURSES,
    .init       = curses_display_init,
};

static void register_curses(void) {
    qemu_display_register(&amp;qemu_display_curses); // S2
}

type_init(register_curses); // S1
</code></pre></div>
<p>Second, <code>qemu_init_displays</code> will first initialize a global <code>DisplayState</code> and
initialize all text consoles if available. Then, <code>qemu_init_displays</code> will call
<code>qemu_display_init</code>, and then call all <code>.init</code> registered if <code>-display none</code> is
not set.</p>
<div class="highlight"><pre><span></span><code><span class="k">static</span><span class="w"> </span><span class="n">DisplayState</span><span class="w"> </span><span class="o">*</span><span class="nf">get_alloc_displaystate</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">display_state</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">display_state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">g_new0</span><span class="p">(</span><span class="n">DisplayState</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="w">        </span><span class="n">cursor_timer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">timer_new_ms</span><span class="p">(</span>
<span class="w">            </span><span class="n">QEMU_CLOCK_REALTIME</span><span class="p">,</span><span class="w"> </span><span class="n">text_console_update_cursor</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">display_state</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">DisplayState</span><span class="w"> </span><span class="o">*</span><span class="nf">init_displaystate</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">gchar</span><span class="w"> </span><span class="o">*</span><span class="n">name</span><span class="p">;</span>
<span class="w">    </span><span class="n">QemuConsole</span><span class="w"> </span><span class="o">*</span><span class="n">con</span><span class="p">;</span>

<span class="w">    </span><span class="n">get_alloc_displaystate</span><span class="p">();</span>
<span class="w">    </span><span class="n">QTAILQ_FOREACH</span><span class="p">(</span><span class="n">con</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">consoles</span><span class="p">,</span><span class="w"> </span><span class="n">next</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">console_type</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">GRAPHIC_CONSOLE</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<span class="w">            </span><span class="n">con</span><span class="o">-&gt;</span><span class="n">ds</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">text_console_do_init</span><span class="p">(</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">chr</span><span class="p">,</span><span class="w"> </span><span class="n">display_state</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="p">...</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">display_state</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">qemu_display_init</span><span class="p">(</span><span class="n">DisplayState</span><span class="w"> </span><span class="o">*</span><span class="n">ds</span><span class="p">,</span><span class="w"> </span><span class="n">DisplayOptions</span><span class="w"> </span><span class="o">*</span><span class="n">opts</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">opts</span><span class="o">-&gt;</span><span class="n">type</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DISPLAY_TYPE_NONE</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">assert</span><span class="p">(</span><span class="n">dpys</span><span class="p">[</span><span class="n">opts</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">]</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span>
<span class="w">    </span><span class="n">dpys</span><span class="p">[</span><span class="n">opts</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">init</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span><span class="w"> </span><span class="n">opts</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<h2 id="qemu-console">QEMU Console<a class="headerlink" href="#qemu-console" title="Do what you think is right">#</a></h2>
<p>QEMU consoles are the bridges between video devices and QEMU displays.</p>
<h3 id="qemu-consoles-are-defined-as-a-list-of-qemuconsole">QEMU consoles are defined as a list of <code>QemuConsole</code>.<a class="headerlink" href="#qemu-consoles-are-defined-as-a-list-of-qemuconsole" title="Do what you think is right">#</a></h3>
<div class="highlight"><pre><span></span><code><span class="k">static</span><span class="w"> </span><span class="n">QTAILQ_HEAD</span><span class="p">(,</span><span class="w"> </span><span class="n">QemuConsole</span><span class="p">)</span><span class="w"> </span><span class="n">consoles</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">QTAILQ_HEAD_INITIALIZER</span><span class="p">(</span><span class="n">consoles</span><span class="p">);</span>
</code></pre></div>
<ul>
<li>There is a for-each primitive to traverse each <code>QemuConsole</code>.</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="n">QTAILQ_FOREACH</span><span class="p">(</span><span class="n">con</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">consoles</span><span class="p">,</span><span class="w"> </span><span class="n">next</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">}</span>
</code></pre></div>
<ul>
<li>There are several high-level primitives to access a <code>QemuConsole</code> as well.</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="n">qemu_console_lookup_by_index</span><span class="p">(...</span><span class="w"> </span><span class="n">index</span><span class="p">)</span>
<span class="n">qemu_console_lookup_by_device</span><span class="p">(...</span><span class="w"> </span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="p">...</span><span class="w"> </span><span class="n">head</span><span class="p">)</span>
<span class="n">qemu_console_lookup_by_device_name</span><span class="p">(...</span><span class="w"> </span><span class="n">device_id</span><span class="p">,</span><span class="w"> </span><span class="n">head</span><span class="p">)</span><span class="w"> </span><span class="c1">// device_id -&gt; dev</span>
<span class="n">qemu_console_lookup_unused</span><span class="p">()</span>
</code></pre></div>
<h3 id="qemu-consoles-have-three-types">QEMU consoles have three types.<a class="headerlink" href="#qemu-consoles-have-three-types" title="Do what you think is right">#</a></h3>
<div class="highlight"><pre><span></span><code><span class="k">typedef</span><span class="w"> </span><span class="k">enum</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">GRAPHIC_CONSOLE</span><span class="p">,</span><span class="w"> </span><span class="n">TEXT_CONSOLE</span><span class="p">,</span><span class="w"> </span><span class="n">TEXT_CONSOLE_FIXED_SIZE</span>
<span class="p">}</span><span class="w"> </span><span class="n">console_type_t</span><span class="p">;</span>
</code></pre></div>
<ul>
<li><code>GRAPHIC_CONSOLE</code></li>
</ul>
<div class="highlight"><pre><span></span><code><span class="c1">// e.g., ati-vga</span>
<span class="n">ati_vga_realize</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">graphic_console_init</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">new_console</span><span class="p">(...,</span><span class="w"> </span><span class="n">GRAPHIC_CONSOLE</span><span class="p">,</span><span class="w"> </span><span class="p">...)</span>
</code></pre></div>
<p>Other examples are in the following.</p>
<div class="highlight"><pre><span></span><code>hw/display/pl110.c
hw/display/g364fb.c
hw/display/virtio-gpu-base.c
hw/display/bochs-display.c
hw/display/vga-pci.c
hw/display/vmware_vga.c
hw/display/xlnx_dp.c
hw/display/vga-isa-mm.c
hw/display/cirrus_vga.c
hw/display/ramfb-standalone.c
hw/display/exynos4210_fimd.c
hw/display/macfb.c
hw/display/bcm2835_fb.c
hw/display/cg3.c
hw/display/xenfb.c
hw/display/cirrus_vga_isa.c
hw/display/omap_lcdc.c
hw/display/jazz_led.c
hw/display/tc6393xb.c
hw/display/milkymist-vgafb.c
hw/display/vga-isa.c
hw/display/next-fb.c
hw/display/ssd0323.c
hw/display/ati.c
hw/display/artist.c
hw/display/qxl.c
hw/display/ssd0303.c
hw/display/tcx.c
hw/display/omap_dss.c
hw/display/sm501.c
hw/display/blizzard.c
hw/display/pxa2xx_lcd.c
</code></pre></div>
<ul>
<li><code>TEXT_CONSOLE[_FIXED_SIZE]</code></li>
</ul>
<div class="highlight"><pre><span></span><code><span class="c1">// e.g., chardev-vc</span>
<span class="n">vc_chr_open</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">new_console</span><span class="p">(...,</span><span class="w"> </span><span class="n">TEXT_CONSOLE</span><span class="p">[</span><span class="n">_FIXED_SIZE</span><span class="p">],</span><span class="w"> </span><span class="p">...)</span>
</code></pre></div>
<h3 id="qemu-consoles-are-initialized-by-new_console">QEMU consoles are initialized by <code>new_console</code>.<a class="headerlink" href="#qemu-consoles-are-initialized-by-new_console" title="Do what you think is right">#</a></h3>
<p>First, <code>new_console</code> allocates an object and initializes some fields.</p>
<div class="highlight"><pre><span></span><code><span class="n">obj</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">object_new</span><span class="p">(</span><span class="n">TYPE_QEMU_CONSOLE</span><span class="p">);</span>
<span class="n">s</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">QEMU_CONSOLE</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>
<span class="n">qemu_co_queue_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">dump_queue</span><span class="p">);</span>
<span class="n">s</span><span class="o">-&gt;</span><span class="n">head</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">head</span><span class="p">;</span>
</code></pre></div>
<p>Then, if no console is activated, it will choose the first allocated console.
However, a graphic console can override others.</p>
<div class="highlight"><pre><span></span><code><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">active_console</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">((</span><span class="n">active_console</span><span class="o">-&gt;</span><span class="n">console_type</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">GRAPHIC_CONSOLE</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<span class="w">    </span><span class="p">(</span><span class="n">console_type</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">GRAPHIC_CONSOLE</span><span class="p">)))</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">active_console</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">s</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p>Next, still some fields.</p>
<div class="highlight"><pre><span></span><code><span class="n">s</span><span class="o">-&gt;</span><span class="n">ds</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ds</span><span class="p">;</span><span class="w"> </span><span class="c1">// with display change listeners </span>
<span class="n">s</span><span class="o">-&gt;</span><span class="n">console_type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">console_type</span><span class="p">;</span>
<span class="n">s</span><span class="o">-&gt;</span><span class="n">window_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span>
</code></pre></div>
<p>Last, <code>new_console</code> will insert the allocated object to the list <code>consoles</code>.</p>
<ul>
<li>If the list is empty, insert the object directly and then set the index to 0.</li>
<li>If the object is not a graphic console and QEMU is in the phase
of <code>PHASE_MACHINE_READY</code>, append the object and update its index.</li>
<li>If the object is a graphic console, append the object to the last graphic
console and keep the graphic consoles in front of the text consoles. If in this
situation, the text consoles will be renumbered. </li>
</ul>
<h2 id="qemu-consoles-qemu-video-devices-and-qemu-displays">QEMU consoles, QEMU video devices and QEMU displays<a class="headerlink" href="#qemu-consoles-qemu-video-devices-and-qemu-displays" title="Do what you think is right">#</a></h2>
<h3 id="a-typical-example-would-be-graphic_console_init">A typical example would be <code>graphic_console_init</code>.<a class="headerlink" href="#a-typical-example-would-be-graphic_console_init" title="Do what you think is right">#</a></h3>
<p>First, by calling <code>get_alloc_dispaly</code>, it allocates or gets an allocated
<code>DisplayState</code> that is bonded to a list of display change listeners.</p>
<div class="highlight"><pre><span></span><code><span class="n">ds</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">get_alloc_displaystate</span><span class="p">();</span>
</code></pre></div>
<p>Second, it finds an unused QEMU console by <code>qemu_console_lookup_unused</code>. A QEMU
console is unused when it is at least not linked to a QEMU video device. If
there is no console available, it will call <code>new_console</code> to allocate a graphic
console with the allocated <code>DisplayState</code>.</p>
<div class="highlight"><pre><span></span><code><span class="n">s</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">qemu_console_lookup_unused</span><span class="p">();</span>
<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">surface</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">width</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">surface_width</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">surface</span><span class="p">);</span>
<span class="w">        </span><span class="n">height</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">surface_height</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">surface</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">s</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">new_console</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span><span class="w"> </span><span class="n">GRAPHIC_CONSOLE</span><span class="p">,</span><span class="w"> </span><span class="n">head</span><span class="p">);</span>
<span class="w">    </span><span class="n">s</span><span class="o">-&gt;</span><span class="n">ui_timer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">timer_new_ms</span><span class="p">(</span><span class="n">QEMU_CLOCK_REALTIME</span><span class="p">,</span><span class="w"> </span><span class="n">dpy_set_ui_info_timer</span><span class="p">,</span><span class="w"> </span><span class="n">s</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<p>Third, it links the console to the QEMU video device and registers relative
callbacks.</p>
<div class="highlight"><pre><span></span><code><span class="n">graphic_console_set_hwops</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="n">hw_ops</span><span class="p">,</span><span class="w"> </span><span class="n">opaque</span><span class="p">);</span>
<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">object_property_set_link</span><span class="p">(</span><span class="n">OBJECT</span><span class="p">(</span><span class="n">s</span><span class="p">),</span><span class="w"> </span><span class="s">&quot;device&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">OBJECT</span><span class="p">(</span><span class="n">dev</span><span class="p">),</span><span class="w"> </span><span class="o">&amp;</span><span class="n">error_abort</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<p>Finally, create a surface and notify all QEMU displays through
<code>s-&gt;ds-&gt;listeners</code>.</p>
<div class="highlight"><pre><span></span><code><span class="n">surface</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">qemu_create_placeholder_surface</span><span class="p">(</span><span class="n">width</span><span class="p">,</span><span class="w"> </span><span class="n">height</span><span class="p">,</span><span class="w"> </span><span class="n">noinit</span><span class="p">);</span>
<span class="n">dpy_gfx_replace_surface</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="n">surface</span><span class="p">);</span>
</code></pre></div>
<p>Here is a summary.</p>
<div class="highlight"><pre><span></span><code>+------------------+           +------------+              +-------------+
+QEMU vidio devices+ &lt;-hw_ops- +QEMU console+ -listeners-&gt; +QEMU dispalys+
+------------------+           +------------+              +-------------+
</code></pre></div>
<h3 id="when-it-comes-to-a-text-console-things-are-similar">When it comes to a text console, things are similar.<a class="headerlink" href="#when-it-comes-to-a-text-console-things-are-similar" title="Do what you think is right">#</a></h3>
<p>First, allocate a QEMU console.</p>
<div class="highlight"><pre><span></span><code><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">width</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">height</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">s</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">new_console</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="n">TEXT_CONSOLE</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">s</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">new_console</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="n">TEXT_CONSOLE_FIXED_SIZE</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<span class="w">    </span><span class="n">s</span><span class="o">-&gt;</span><span class="n">surface</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">qemu_create_displaysurface</span><span class="p">(</span><span class="n">width</span><span class="p">,</span><span class="w"> </span><span class="n">height</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<p>Then, link the console with the <code>ChardevVC</code>, <code>DisplayState</code> if available and 
relative hardware operations.</p>
<div class="highlight"><pre><span></span><code><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">text_console_do_init</span><span class="p">(</span><span class="n">Chardev</span><span class="w"> </span><span class="o">*</span><span class="n">chr</span><span class="p">,</span><span class="w"> </span><span class="n">DisplayState</span><span class="w"> </span><span class="o">*</span><span class="n">ds</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">s</span><span class="o">-&gt;</span><span class="n">ds</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ds</span>
<span class="w">    </span><span class="p">...</span>
<span class="w">    </span><span class="n">s</span><span class="o">-&gt;</span><span class="n">hw_ops</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">text_console_ops</span><span class="p">;</span>
<span class="w">    </span><span class="n">s</span><span class="o">-&gt;</span><span class="n">hw</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">s</span><span class="p">;</span>
<span class="w">    </span><span class="p">...</span>
<span class="p">}</span>
</code></pre></div>
<h2 id="interactions-through-qemu-consoles">Interactions through QEMU consoles<a class="headerlink" href="#interactions-through-qemu-consoles" title="Do what you think is right">#</a></h2>
<h3 id="first-of-all-we-will-figure-out-when-the-hw_ops-are-called">First of all, we will figure out when the hw_ops are called.<a class="headerlink" href="#first-of-all-we-will-figure-out-when-the-hw_ops-are-called" title="Do what you think is right">#</a></h3>
<p>All hw_ops are defined in the following.</p>
<div class="highlight"><pre><span></span><code><span class="k">typedef</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">GraphicHwOps</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">get_flags</span><span class="p">)(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">opaque</span><span class="p">);</span><span class="w"> </span><span class="cm">/* optional, default 0 */</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">invalidate</span><span class="p">)(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">opaque</span><span class="p">);</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">gfx_update</span><span class="p">)(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">opaque</span><span class="p">);</span>
<span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="n">gfx_update_async</span><span class="p">;</span><span class="w"> </span><span class="cm">/* if true, calls graphic_hw_update_done() */</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">text_update</span><span class="p">)(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">opaque</span><span class="p">,</span><span class="w"> </span><span class="n">console_ch_t</span><span class="w"> </span><span class="o">*</span><span class="n">text</span><span class="p">);</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">update_interval</span><span class="p">)(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">opaque</span><span class="p">,</span><span class="w"> </span><span class="kt">uint64_t</span><span class="w"> </span><span class="n">interval</span><span class="p">);</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">ui_info</span><span class="p">)(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">opaque</span><span class="p">,</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">head</span><span class="p">,</span><span class="w"> </span><span class="n">QemuUIInfo</span><span class="w"> </span><span class="o">*</span><span class="n">info</span><span class="p">);</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">gl_block</span><span class="p">)(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">opaque</span><span class="p">,</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">block</span><span class="p">);</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">gl_flushed</span><span class="p">)(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">opaque</span><span class="p">);</span>
<span class="p">}</span><span class="w"> </span><span class="n">GraphicHwOps</span><span class="p">;</span>
</code></pre></div>
<p>We can group them according to their usage.</p>
<h4 id="group-1-graphic_hw_xxx">Group 1: graphic_hw_xxx<a class="headerlink" href="#group-1-graphic_hw_xxx" title="Do what you think is right">#</a></h4>
<p>Callbacks in this group will be called by QEMU displays. Graphic displays
usually call <code>graphic_hw_update</code>, while text displays would call
<code>graphic_hw_text_udpate</code>. A virtual device must tell the corresponding QEMU
displays what should do by implementing these callbacks.</p>
<div class="highlight"><pre><span></span><code>graphic_hw_update (gfx_update)
graphic_hw_text_update
graphic_hw_invalidate 
graphic_hw_gl_block
graphic_hw_gl_flushed
</code></pre></div>
<h4 id="group-2-gui_update-update_interval">Group 2: gui_update -&gt; update_interval<a class="headerlink" href="#group-2-gui_update-update_interval" title="Do what you think is right">#</a></h4>
<p>When <code>register_displaychangelistener</code> is called by a QEMU display, it will set a
timer to call <code>phy_refresh</code> periodically. A virtual device can implement
<code>update_interval</code> to synchronize the interval of the timer.</p>
<h4 id="group-3-dpy_compatible_with-and-dpy_set_ui_info_timer">Group 3: dpy_compatible_with and dpy_set_ui_info_timer<a class="headerlink" href="#group-3-dpy_compatible_with-and-dpy_set_ui_info_timer" title="Do what you think is right">#</a></h4>
<p>The former checks whether a video device is compatible with a QEMU display by
calling <code>get_flags</code>. The latter will be triggered when ui info should be told to
the guest.</p>
<h3 id="second-we-will-figure-out-how-the-display-listener-callbacks-work">Second, we will figure out how the display listener callbacks work.<a class="headerlink" href="#second-we-will-figure-out-how-the-display-listener-callbacks-work" title="Do what you think is right">#</a></h3>
<h4 id="an-example-of-graphic-qemu-display">An example of graphic QEMU display<a class="headerlink" href="#an-example-of-graphic-qemu-display" title="Do what you think is right">#</a></h4>
<div class="highlight"><pre><span></span><code><span class="k">static</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">DisplayChangeListenerOps</span><span class="w"> </span><span class="n">dcl_ops</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="p">.</span><span class="n">dpy_name</span><span class="w">             </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;gtk&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="p">.</span><span class="n">dpy_gfx_update</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="n">gd_update</span><span class="p">,</span>
<span class="w">    </span><span class="p">.</span><span class="n">dpy_gfx_switch</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="n">gd_switch</span><span class="p">,</span>
<span class="w">    </span><span class="p">.</span><span class="n">dpy_gfx_check_format</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">qemu_pixman_check_format</span><span class="p">,</span>
<span class="w">    </span><span class="p">.</span><span class="n">dpy_refresh</span><span class="w">          </span><span class="o">=</span><span class="w"> </span><span class="n">gd_refresh</span><span class="p">,</span>
<span class="w">    </span><span class="p">.</span><span class="n">dpy_mouse_set</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="n">gd_mouse_set</span><span class="p">,</span>
<span class="w">    </span><span class="p">.</span><span class="n">dpy_cursor_define</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="n">gd_cursor_define</span><span class="p">,</span>
<span class="p">};</span>
</code></pre></div>
<ul>
<li><code>dpy_gfx_update</code>, <code>dpy_gfx_check_format</code>, <code>dpy_mouse_set</code>, and <code>dpy_cursor_define</code>
will be called from vedio devices.</li>
<li><code>dpy_refresh</code> is illustrated above.</li>
<li><code>gpy_gfx_switch</code> will be called in <code>register_displaychangelistener</code> or will be
called by QEMU displays.</li>
</ul>
<h3 id="what-about-together">What about together?<a class="headerlink" href="#what-about-together" title="Do what you think is right">#</a></h3>
<p>Let's review the history of graphic devices.</p>
<ul>
<li>1st gen VGA Card: output images but leave all calculations to CPU</li>
<li>2nd gen Graphics Card: integrate image output and processing</li>
<li>3rd gen Video Card: take over the video coding-encoding from CPU</li>
<li>4th gen 3D Accelerator Card: take over the 3D Accelerator from a special 3D card</li>
<li>5th gen GPU: integrate more generic calculation tasks</li>
</ul>
<p>Basically, a video device will process and output images.  In QEMU,
periodically, <code>graphic_hw_update</code> will be called switching from QEMU displays to
QEMU video devices. The devices will process the image and then call
<code>dpy_gfx_update</code> to inform the changes to QEMU displays.</p>
<div class="footnote">
<hr />
<ol>
<li id="fn:1">
<p><a href="https://www.kraxel.org/slides/qemu-gfx/">Graphics in QEMU</a>&#160;<a class="footnote-backref" href="#fnref:1" title="Jump back to footnote 1 in the text">&#8617;</a></p>
</li>
</ol>
</div>







  
  



  


  



      
    </article>
  </div>

          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
    
      
        
      
      <nav class="md-footer__inner md-grid" aria-label="Footer" >
        
          
          <a href="../../../../2020/11/30/clang-wllvm-passes-qemulinux-kernel-for-x86_64/" class="md-footer__link md-footer__link--prev" aria-label="Previous: Clang, wllvm, passes, QEMU/Linux kernel for x86_64">
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
            </div>
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Previous
              </span>
              <div class="md-ellipsis">
                Clang, wllvm, passes, QEMU/Linux kernel for x86_64
              </div>
            </div>
          </a>
        
        
          
          <a href="../../../10/27/introduction-to-bhyve/" class="md-footer__link md-footer__link--next" aria-label="Next: Introduction to Bhyve">
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Next
              </span>
              <div class="md-ellipsis">
                Introduction to Bhyve
              </div>
            </div>
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11z"/></svg>
            </div>
          </a>
        
      </nav>
    
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright &copy; 2018 - 2025, Qiang Liu. All rights reserved.
    </div>
  
  
</div>
      
        
<div class="md-social">
  
    
    
    
    
    <a href="/" target="_blank" rel="noopener" title="Home" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg>
    </a>
  
    
    
    
    
    <a href="mailto:cyruscyliu@gmail.com" target="_blank" rel="noopener" title="" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m20 8-8 5-8-5V6l8 5 8-5m0-2H4c-1.11 0-2 .89-2 2v12a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2"/></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://www.linkedin.com/in/qiangliu15/" target="_blank" rel="noopener" title="www.linkedin.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path fill="currentColor" d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3M135.4 416H69V202.2h66.5V416zM102.2 96a38.5 38.5 0 1 1 0 77 38.5 38.5 0 1 1 0-77m282.1 320h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9z"/></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="weixin://dl/chat?ocat01" target="_blank" rel="noopener" title="dl" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.691 2.188C3.891 2.188 0 5.476 0 9.53c0 2.212 1.17 4.203 3.002 5.55a.59.59 0 0 1 .213.665l-.39 1.48c-.019.07-.048.141-.048.213 0 .163.13.295.29.295a.33.33 0 0 0 .167-.054l1.903-1.114a.86.86 0 0 1 .717-.098 10.2 10.2 0 0 0 2.837.403c.276 0 .543-.027.811-.05-.857-2.578.157-4.972 1.932-6.446 1.703-1.415 3.882-1.98 5.853-1.838-.576-3.583-4.196-6.348-8.596-6.348M5.785 5.991c.642 0 1.162.529 1.162 1.18a1.17 1.17 0 0 1-1.162 1.178A1.17 1.17 0 0 1 4.623 7.17c0-.651.52-1.18 1.162-1.18zm5.813 0c.642 0 1.162.529 1.162 1.18a1.17 1.17 0 0 1-1.162 1.178 1.17 1.17 0 0 1-1.162-1.178c0-.651.52-1.18 1.162-1.18m5.34 2.867c-1.797-.052-3.746.512-5.28 1.786-1.72 1.428-2.687 3.72-1.78 6.22.942 2.453 3.666 4.229 6.884 4.229.826 0 1.622-.12 2.361-.336a.72.72 0 0 1 .598.082l1.584.926a.3.3 0 0 0 .14.047c.134 0 .24-.111.24-.247 0-.06-.023-.12-.038-.177l-.327-1.233a.6.6 0 0 1-.023-.156.49.49 0 0 1 .201-.398C23.024 18.48 24 16.82 24 14.98c0-3.21-2.931-5.837-6.656-6.088V8.89c-.135-.01-.27-.027-.407-.03zm-2.53 3.274c.535 0 .969.44.969.982a.976.976 0 0 1-.969.983.976.976 0 0 1-.969-.983c0-.542.434-.982.97-.982zm4.844 0c.535 0 .969.44.969.982a.976.976 0 0 1-.969.983.976.976 0 0 1-.969-.983c0-.542.434-.982.969-.982"/></svg>
    </a>
  
    
    
    
    
    <a href="Qiang_s_CV.pdf" target="_blank" rel="noopener" title="" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 9h5.5L13 3.5zM6 2h8l6 6v12a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V4c0-1.11.89-2 2-2m8 18v-1c0-1.33-2.67-2-4-2s-4 .67-4 2v1zm-4-8a2 2 0 0 0-2 2 2 2 0 0 0 2 2 2 2 0 0 0 2-2 2 2 0 0 0-2-2"/></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://scholar.google.com/citations?user=fa1uB2sAAAAJ&hl=en" target="_blank" rel="noopener" title="scholar.google.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M5.242 13.769 0 9.5 12 0l12 9.5-5.242 4.269C17.548 11.249 14.978 9.5 12 9.5c-2.977 0-5.548 1.748-6.758 4.269M12 10a7 7 0 1 0 0 14 7 7 0 0 0 0-14"/></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://github.com/cyruscyliu" target="_blank" rel="noopener" title="github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "../../../../..", "features": ["navigation.tracking", "navigation.path", "navigation.top", "navigation.footer", "navigation.indexes", "navigation.expand", "toc.integrate", "footer.prev_next", "revision.date", "revision.history"], "search": "../../../../../assets/javascripts/workers/search.973d3a69.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../../../../assets/javascripts/bundle.92b07e13.min.js"></script>
      
    
  </body>
</html>