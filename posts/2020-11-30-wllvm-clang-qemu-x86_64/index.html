<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <meta name="generator" content="mkdocs-1.6.1, mkdocs-terminal-4.7.0">
     
     
    
    <link rel="canonical" href="https://github.com/cyruscyliu/cyruscyliu.github.io/posts/2020-11-30-wllvm-clang-qemu-x86_64/"><link rel="icon" type="image/png" sizes="192x192" href="../../img/android-chrome-192x192.png" />
<link rel="icon" type="image/png" sizes="512x512" href="../../img/android-chrome-512x512.png" />
<link rel="apple-touch-icon" sizes="180x180" href="../../img/apple-touch-icon.png" />
<link rel="shortcut icon" type="image/png" sizes="48x48" href="../../img/favicon.ico" />
<link rel="icon" type="image/png" sizes="16x16" href="../../img/favicon-16x16.png" />
<link rel="icon" type="image/png" sizes="32x32" href="../../img/favicon-32x32.png" />


    
 
<title>Clang, wllvm, passes, QEMU/Linux kernel for x86_64 - Qiang Liu's Homepage</title>


<link href="../../css/fontawesome/css/fontawesome.min.css" rel="stylesheet">
<link href="../../css/fontawesome/css/solid.min.css" rel="stylesheet">
<link href="../../css/normalize.css" rel="stylesheet">
<link href="../../css/terminal.css" rel="stylesheet">
<link href="../../css/theme.css" rel="stylesheet">
<link href="../../css/theme.tile_grid.css" rel="stylesheet">
<link href="../../css/theme.footer.css" rel="stylesheet">
<!-- default color palette -->
<link href="../../css/palettes/default.css" rel="stylesheet">

<!-- page layout -->
<style>
/* initially set page layout to a one column grid */
.terminal-mkdocs-main-grid {
    display: grid;
    grid-column-gap: 1.4em;
    grid-template-columns: auto;
    grid-template-rows: auto;
}

/*  
*   when side navigation is not hidden, use a two column grid.  
*   if the screen is too narrow, fall back to the initial one column grid layout.
*   in this case the main content will be placed under the navigation panel. 
*/
@media only screen and (min-width: 70em) {
    .terminal-mkdocs-main-grid {
        grid-template-columns: 4fr 9fr;
    }
}</style>



     
    
    

    
    <!-- search css support -->
<link href="../../css/search/bootstrap-modal.css" rel="stylesheet">
<!-- search scripts -->
<script>
    var base_url = "../..",
    shortcuts = "{}";
</script>
<script src="../../js/jquery/jquery-1.10.1.min.js" defer></script>
<script src="../../js/bootstrap/bootstrap.min.js" defer></script>
<script src="../../js/mkdocs/base.js" defer></script>
    
    
    
    
    <script src="../../search/main.js"></script>
    

    
</head>

<body class="terminal"><div class="container">
    <div class="terminal-nav">
        <header class="terminal-logo">
            <div id="mkdocs-terminal-site-name" class="logo terminal-prompt"><a href="https://github.com/cyruscyliu/cyruscyliu.github.io/" class="no-style">Qiang Liu's Homepage</a></div>
        </header>
        
        <nav class="terminal-menu">
            
            <ul vocab="https://schema.org/" typeof="BreadcrumbList">
                
                
                <li property="itemListElement" typeof="ListItem">
                    <a href="../.." class="menu-item " property="item" typeof="WebPage">
                        <span property="name">Home</span>
                    </a>
                    <meta property="position" content="0">
                </li>
                
                
                <li property="itemListElement" typeof="ListItem">
                    <a href="../" class="menu-item " property="item" typeof="WebPage">
                        <span property="name">Posts</span>
                    </a>
                    <meta property="position" content="1">
                </li>
                
                    
                    


<li property="itemListElement" typeof="ListItem">
    <a href="#" class="menu-item" data-toggle="modal" data-target="#mkdocs_search_modal" property="item" typeof="SearchAction">
        <i aria-hidden="true" class="fa fa-search"></i> <span property="name">Search</span>
    </a>
    <meta property="position" content="2">
</li>
                    
            </ul>
            
        </nav>
    </div>
</div>
        
    <div class="container">
        <div class="terminal-mkdocs-main-grid"><aside id="terminal-mkdocs-side-panel"><nav>
  
    <ul class="terminal-mkdocs-side-nav-items">
        
          



<li class="terminal-mkdocs-side-nav-li">
    
    
    
        
        
            <a class="

    terminal-mkdocs-side-nav-item" href="../..">Home</a>
        
    
    
    
  </li>
        
          



<li class="terminal-mkdocs-side-nav-li">
    
    
    
        
        
            <a class="

    terminal-mkdocs-side-nav-item" href="../">Posts</a>
        
    
    
    
  </li>
        
    </ul>
  
</nav><hr>
<nav>
    <ul>
        <li><a href="#clang-wllvm-passes-qemulinux-kernel-for-x86_64">Clang, wllvm, passes, QEMU/Linux kernel for x86_64</a></li>
        <li><a href="#build-qemu-with-clang">Build QEMU with Clang</a></li><li><a href="#build-linux-kernel-with-clang">Build Linux kernel with Clang</a></li><li><a href="#build-qemu-with-wllvm">Build QEMU with wllvm</a></li><li><a href="#build-linux-kernel-with-wllvm">Build Linux kernel with wllvm</a></li><li><a href="#run-llvm-passes-with-opt">Run LLVM passes with opt</a></li><li><a href="#debug-llvm-passes">Debug LLVM passes</a></li>
    </ul>
</nav>
</aside>
            <main id="terminal-mkdocs-main-content">
    
    
    
    
    

<section id="mkdocs-terminal-content">
    <h1 id="clang-wllvm-passes-qemulinux-kernel-for-x86_64">Clang, wllvm, passes, QEMU/Linux kernel for x86_64<a class="headerlink" href="#clang-wllvm-passes-qemulinux-kernel-for-x86_64" title="Do what you think is right">#</a></h1>
<p>Building QEMU/Linux kernel with Clang enables running LLVM passes on these code
and performing static analysis. One option is to run the passes during the
compilation, the other is to run the passes (opt) on an generated LLVM bitcode
file (wllvm).</p>
<p>This blog is planning to show both, but with limited time bugdet, I will first
explain how to run the passes on the generated bitcode files.</p>
<h2 id="build-qemu-with-clang">Build QEMU with Clang<a class="headerlink" href="#build-qemu-with-clang" title="Do what you think is right">#</a></h2>
<pre><code class="language-bash">$ clang --version
Ubuntu clang version 14.0.0-1ubuntu1.1
Target: x86_64-pc-linux-gnu
Thread model: posix
InstalledDir: /usr/bin

$ cd qemu
$ cat VERSION
8.2.50
$ ./configure --target-list=x86_64-softmmu --cc=clang
$ make
</code></pre>
<h2 id="build-linux-kernel-with-clang">Build Linux kernel with Clang<a class="headerlink" href="#build-linux-kernel-with-clang" title="Do what you think is right">#</a></h2>
<p><a href="https://docs.kernel.org/kbuild/llvm.html">Offical Documentation</a></p>
<h2 id="build-qemu-with-wllvm">Build QEMU with wllvm<a class="headerlink" href="#build-qemu-with-wllvm" title="Do what you think is right">#</a></h2>
<pre><code>$ pip install wllvm

$ export LLVM_COMPILER=clang
$ # if no clang/clang++/llvm-link/llvm-ar executables
$ # export LLVM_CC_NAME=clang-14
$ # export LLVM_CXX_NAME=clang++-14
$ # export LLVM_LINK_NAME=llvm-link-14
$ # export LLVM_AR_NAME=llvm-ar-14
$ cd qemu-4.0.0
$ ./configure --target-list=x86_64-softmmu --cc=wllvm
$ make
$ extract-bc build/qemu-system-x86_64
$ # You will find the bitcode file build/qemu-system-x86_64.bc
</code></pre>
<p>I met one kind of warnings <code>WARNING:Did not recognize the compiler flag
"-mcx16"</code>, but it seemed harmless. I will update more if any flaw caused by this
warning. I met another error <code>objcopy: src/xxx: failed to find link section for
section xx</code>.  Please update your objcopy to 2.31 or upper.</p>
<h2 id="build-linux-kernel-with-wllvm">Build Linux kernel with wllvm<a class="headerlink" href="#build-linux-kernel-with-wllvm" title="Do what you think is right">#</a></h2>
<pre><code class="language-bash">#!/bin/bash -x

# python3 -m pip install wllvm
# assume clang/llvm 14

LINUX_TAG=$1

if ! test -d linux-$LINUX_TAG ; then
    git clone --depth 1 --branch v$LINUX_TAG \
        git://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git \
        linux-$LINUX_TAG
fi

export LLVM_COMPILER=clang
export LLVM_CC_NAME=clang-14
export LLVM_CXX_NAME=clang-14
export LLVM_LINK_NAME=llvm-link-14
export LLVM_AR_NAME=llvm-ar-14

pushd linux-$LINUX_TAG
make HOSTCC=wllvm CC=wllvm x86_64_defconfig
make HOSTCC=wllvm CC=wllvm -j20
extract-bc vmlinux
popd
</code></pre>
<h2 id="run-llvm-passes-with-opt">Run LLVM passes with opt<a class="headerlink" href="#run-llvm-passes-with-opt" title="Do what you think is right">#</a></h2>
<p>First, try a builtin pass on <code>PLACEHOLDER.bc</code> (either vmlinux.bc or
qemu-system-x86_64.bc). LLVM has a new pass manager but the documentation of opt
is outdated. Please check
<a href="https://llvm.org/docs/NewPassManager.html#invoking-opt">this</a> for more
information.</p>
<pre><code class="language-bash">opt-14 -passes='instcount' PLACEHOLDER.bc -o /dev/null 2&gt;&amp;1 -debug-pass-manager
</code></pre>
<p>Second, develop your own LLVM pass and load it with opt.</p>
<p>I usually use <a href="https://github.com/banach-space/llvm-tutor">llvm-tutor</a> to
quickly develop external LLVM passes.</p>
<pre><code class="language-bash">$ # install llvm-17
$ export LLVM_DIR=/usr/lib/llvm-17
$ mkdir build
$ cd build
$ cmake -DLT_LLVM_INSTALL_DIR=$LLVM_DIR /path/to/llvm-tutor/HelloWorld/
$ make
$ # run this LLVM pass
$ $LLVM_DIR/bin/opt \
    -load-pass-plugin ./libHelloWorld.so -passes=hello-world -disable-output \
    PLACEHOLDER.bc
</code></pre>
<h2 id="debug-llvm-passes">Debug LLVM passes<a class="headerlink" href="#debug-llvm-passes" title="Do what you think is right">#</a></h2>
<p>https://releases.llvm.org/1.5/docs/WritingAnLLVMPass.html#debughints</p>
</section>

<section id="mkdocs-terminal-after-content">
    
</section>
<section id="mkdocs-terminal-revision">
<br>
<aside>
    <p>
        <small>
            <i>Page last updated 2024-08-07. </i>
        </small>
    </p>
</aside>
</section>
            </main>
        </div>
        <hr><footer>
    <div class="terminal-mkdocs-footer-grid">
        <div id="terminal-mkdocs-footer-copyright-info">
             Site built with <a href="http://www.mkdocs.org">MkDocs</a> and <a href="https://github.com/ntno/mkdocs-terminal">Terminal for MkDocs</a>.
        </div>
    </div>
</footer>
    </div>

    
    <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="alertdialog" aria-modal="true" aria-labelledby="searchModalLabel">
    <div class="modal-dialog modal-lg" role="search">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="searchModalLabel">Search</h5>
                <button type="button" class="close btn btn-default btn-ghost" data-dismiss="modal"><span aria-hidden="true">x</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
                <p id="searchInputLabel">Type to start searching</p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" aria-labelledby="searchInputLabel" placeholder="" id="mkdocs-search-query" title="Please enter search terms here">
                    </div>
                </form>
                <div id="mkdocs-search-results" data-no-results-text="No document matches found"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>
    
    
</body>

</html>