<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <meta name="generator" content="mkdocs-1.6.1, mkdocs-terminal-4.7.0">
     
     
    
    <link rel="canonical" href="https://github.com/cyruscyliu/cyruscyliu.github.io/posts/2024-05-27-hypercube/"><link rel="icon" type="image/png" sizes="192x192" href="../../img/android-chrome-192x192.png" />
<link rel="icon" type="image/png" sizes="512x512" href="../../img/android-chrome-512x512.png" />
<link rel="apple-touch-icon" sizes="180x180" href="../../img/apple-touch-icon.png" />
<link rel="shortcut icon" type="image/png" sizes="48x48" href="../../img/favicon.ico" />
<link rel="icon" type="image/png" sizes="16x16" href="../../img/favicon-16x16.png" />
<link rel="icon" type="image/png" sizes="32x32" href="../../img/favicon-32x32.png" />


    
 
<title>Notes about HyperCubeOS for x86_64 - Qiang Liu's Homepage</title>


<link href="../../css/fontawesome/css/fontawesome.min.css" rel="stylesheet">
<link href="../../css/fontawesome/css/solid.min.css" rel="stylesheet">
<link href="../../css/normalize.css" rel="stylesheet">
<link href="../../css/terminal.css" rel="stylesheet">
<link href="../../css/theme.css" rel="stylesheet">
<link href="../../css/theme.tile_grid.css" rel="stylesheet">
<link href="../../css/theme.footer.css" rel="stylesheet">
<!-- pink color palette -->
<link href="../../css/palettes/pink.css" rel="stylesheet">

<!-- page layout -->
<style>
/* initially set page layout to a one column grid */
.terminal-mkdocs-main-grid {
    display: grid;
    grid-column-gap: 1.4em;
    grid-template-columns: auto;
    grid-template-rows: auto;
}

/*  
*   when side navigation is not hidden, use a two column grid.  
*   if the screen is too narrow, fall back to the initial one column grid layout.
*   in this case the main content will be placed under the navigation panel. 
*/
@media only screen and (min-width: 70em) {
    .terminal-mkdocs-main-grid {
        grid-template-columns: 4fr 9fr;
    }
}</style>



     
    
    

    
    <!-- search css support -->
<link href="../../css/search/bootstrap-modal.css" rel="stylesheet">
<!-- search scripts -->
<script>
    var base_url = "../..",
    shortcuts = "{}";
</script>
<script src="../../js/jquery/jquery-1.10.1.min.js" defer></script>
<script src="../../js/bootstrap/bootstrap.min.js" defer></script>
<script src="../../js/mkdocs/base.js" defer></script>
    
    
    
    
    <script src="../../search/main.js"></script>
    

    
</head>

<body class="terminal"><div class="container">
    <div class="terminal-nav">
        <header class="terminal-logo">
            <div id="mkdocs-terminal-site-name" class="logo terminal-prompt"><a href="https://github.com/cyruscyliu/cyruscyliu.github.io/" class="no-style">Qiang Liu's Homepage</a></div>
        </header>
        
        <nav class="terminal-menu">
            
            <ul vocab="https://schema.org/" typeof="BreadcrumbList">
                
                
                <li property="itemListElement" typeof="ListItem">
                    <a href="../.." class="menu-item " property="item" typeof="WebPage">
                        <span property="name">Home</span>
                    </a>
                    <meta property="position" content="0">
                </li>
                
                
                <li property="itemListElement" typeof="ListItem">
                    <a href="../" class="menu-item " property="item" typeof="WebPage">
                        <span property="name">Posts</span>
                    </a>
                    <meta property="position" content="1">
                </li>
                
                
                <li property="itemListElement" typeof="ListItem">
                    <a href="../../community/" class="menu-item " property="item" typeof="WebPage">
                        <span property="name">Community</span>
                    </a>
                    <meta property="position" content="2">
                </li>
                
                    
                    


<li property="itemListElement" typeof="ListItem">
    <a href="#" class="menu-item" data-toggle="modal" data-target="#mkdocs_search_modal" property="item" typeof="SearchAction">
        <i aria-hidden="true" class="fa fa-search"></i> <span property="name">Search</span>
    </a>
    <meta property="position" content="3">
</li>
                    
            </ul>
            
        </nav>
    </div>
</div>
        
    <div class="container">
        <div class="terminal-mkdocs-main-grid"><aside id="terminal-mkdocs-side-panel"><nav>
  
    <ul class="terminal-mkdocs-side-nav-items">
        
          



<li class="terminal-mkdocs-side-nav-li">
    
    
    
        
        
            <a class="

    terminal-mkdocs-side-nav-item" href="../..">Home</a>
        
    
    
    
  </li>
        
          



<li class="terminal-mkdocs-side-nav-li">
    
    
    
        
        
            <a class="

    terminal-mkdocs-side-nav-item" href="../">Posts</a>
        
    
    
    
  </li>
        
          



<li class="terminal-mkdocs-side-nav-li">
    
    
    
        
        
            <a class="

    terminal-mkdocs-side-nav-item" href="../../community/">Community</a>
        
    
    
    
  </li>
        
    </ul>
  
</nav><hr>
<nav>
    <ul>
        <li><a href="#notes-about-hypercubeos-for-x86_64">Notes about HyperCubeOS for x86_64</a></li>
        <li><a href="#boostrapping">Boostrapping</a></li><li><a href="#interrupts">Interrupts</a></li>
    </ul>
</nav>
</aside>
            <main id="terminal-mkdocs-main-content">
    
    
    
    
    

<section id="mkdocs-terminal-content">
    <h1 id="notes-about-hypercubeos-for-x86_64">Notes about HyperCubeOS for x86_64<a class="headerlink" href="#notes-about-hypercubeos-for-x86_64" title="Do what you think is right">#</a></h1>
<p>There are some notes when I update
<a href="https://github.com/RUB-SysSec/Hypercube">HyperCubeOS</a> to support x86_64.</p>
<p>Key conclusion: 1) boot the HyperCubeOS for x86_64 to long mode with Limine, 2)
enable the identity mapped paging, 2) set up exception/interrupt handlers.</p>
<h2 id="boostrapping">Boostrapping<a class="headerlink" href="#boostrapping" title="Do what you think is right">#</a></h2>
<p>Overall, HyperCubeOS (which is in fact an ELF) is bootstrapped by a bootloader
(e.g., <a href="https://www.gnu.org/software/grub/">GRUB2</a>).</p>
<p>Bootstrapping is way too arch-specific. It is just painful to revisit
x86/x86_64's ISAs. Here is a short summary of different CPU modes.</p>
<ul>
<li>System Management Mode -&gt; Real mode -&gt; Protected Mode &lt;-&gt; Virtual 8086 Mode</li>
<li>Protected Mode &lt;-&gt; Long Mode (64-bit Mode &lt;-&gt; Compatibility Mode)</li>
<li>Virtual 8086 Mode is designed to run real mode program</li>
<li>Protected mode cannot support 64-bit OS</li>
<li>Long mode can support both 64-bit (64-bit mode) and 32-bit (compatibility
mode) userspace applications</li>
<li>In the long mode, registers are 64-bit</li>
<li>The long mode has 16 general purpose registers to use (while aarch64 has 31)</li>
</ul>
<table>
<thead>
<tr>
<th align="center">Operating Mode</th>
<th align="center">Shilf-and-add Segmentation</th>
<th align="center">Paging</th>
</tr>
</thead>
<tbody>
<tr>
<td align="center">Real Mode</td>
<td align="center">Enabled</td>
<td align="center">Not existing</td>
</tr>
<tr>
<td align="center">Protected Mode (80286)</td>
<td align="center">Enabled</td>
<td align="center">Optional</td>
</tr>
<tr>
<td align="center">Protected Mode (80386 and above)</td>
<td align="center">Enabled</td>
<td align="center">Optional</td>
</tr>
<tr>
<td align="center">Compatibility Mode</td>
<td align="center">Enabled</td>
<td align="center">Enabled</td>
</tr>
<tr>
<td align="center">64-Bit Mode</td>
<td align="center">Bypassed</td>
<td align="center">Enabled</td>
</tr>
</tbody>
</table>
<p>GRUBT2 boostraps the OS to 32-bit protected mode, but we need the CPU running in
the long mode to support 64-bit mode. Specifically, to run 64-bit programs, we
need to switch the CPU to the long mode with paging enabled manually. Prior to
switching to the long mode, GRUB2 sets up two arguments that matter, 1) $eax
(the magic value "0x36d76289" that indicates that the HyperCubeOS was loaded by
a MultiBoot2-compiant boot loader) and 2) $eax (a 32-bit physical address of the
Multiboot2 information structure defined in <a href="https://www.gnu.org/software/grub/manual/multiboot2/multiboot.html#Boot-information-format">Multiboot2 Specification version
2.0</a>.
I tried to save $eax and $ebx, set up the page table (cr3 -&gt; pml4t -&gt; pdpt -&gt;
pdt -&gt; pt), and set up the GDT
<a href="https://wiki.osdev.org/Setting_Up_Long_Mode#The_Switch_from_Protected_Mode">manually</a>,
but I found it very problematic to use GRUB2 (a discussion is also available
<a href="https://wiki.osdev.org/Creating_a_64-bit_kernel">here</a>). I chose
<a href="https://wiki.osdev.org/Limine">Limine</a> as an alternative.</p>
<p>Luckily, Limine has identity mapped the lower 4G.</p>
<h2 id="interrupts">Interrupts<a class="headerlink" href="#interrupts" title="Do what you think is right">#</a></h2>
<p>Important data structures.</p>
<ul>
<li>ISRs are stored in the Interrupt Descriptor Table (IDT) when you're in
Protected mode, or in the Interrupt Vector Table (IVT) when you're in Real Mode.</li>
<li>IDTR has two fields, limit and base. IDTR.limit constraints the number of IDT
entries and IDTR.base points to the first IDT entry. Each IDT entry has the
interrupt handler address and a few flags. Note that, IDT entry is 16-byte in
x86_64, while it is 8-byte in x86. Note that compilers may have problems with
assembly to write the interrupt handler, so take a two-stage assembly wrapping
(see <a href="https://wiki.osdev.org/ISR">this</a>).</li>
</ul>
</section>

<section id="mkdocs-terminal-after-content">
    
</section>
<section id="mkdocs-terminal-revision">
<br>
<aside>
    <p>
        <small>
            <i>Page last updated 2024-06-08. </i>
        </small>
    </p>
</aside>
</section>
            </main>
        </div>
        <hr><footer>
    <div class="terminal-mkdocs-footer-grid">
        <div id="terminal-mkdocs-footer-copyright-info">
             Site built with <a href="http://www.mkdocs.org">MkDocs</a> and <a href="https://github.com/ntno/mkdocs-terminal">Terminal for MkDocs</a>.
        </div>
    </div>
</footer>
    </div>

    
    <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="alertdialog" aria-modal="true" aria-labelledby="searchModalLabel">
    <div class="modal-dialog modal-lg" role="search">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="searchModalLabel">Search</h5>
                <button type="button" class="close btn btn-default btn-ghost" data-dismiss="modal"><span aria-hidden="true">x</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
                <p id="searchInputLabel">Type to start searching</p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" aria-labelledby="searchInputLabel" placeholder="" id="mkdocs-search-query" title="Please enter search terms here">
                    </div>
                </form>
                <div id="mkdocs-search-results" data-no-results-text="No document matches found"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>
    
    
</body>

</html>