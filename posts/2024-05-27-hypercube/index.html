
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://github.com/cyruscyliu/cyruscyliu.github.io/posts/2024-05-27-hypercube/">
      
      
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.5.3, mkdocs-material-9.5.2">
    
    
      
        <title>HyperCube OS for x86_64 - Qiang Liu's Homepage</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.50c56a3b.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Fira+Code:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Fira Code";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#hypercube-os-for-x86_64" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow md-header--lifted" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="Qiang Liu&#39;s Homepage" class="md-header__button md-logo" aria-label="Qiang Liu's Homepage" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Qiang Liu's Homepage
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              HyperCube OS for x86_64
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var media,input,key,value,palette=__md_get("__palette");if(palette&&palette.color){"(prefers-color-scheme)"===palette.color.media&&(media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']"),palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent"));for([key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
    
      
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../.." class="md-tabs__link">
        
  
    
  
  Home

      </a>
    </li>
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../" class="md-tabs__link">
        
  
    
  
  Posts

      </a>
    </li>
  

      
    </ul>
  </div>
</nav>
    
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Qiang Liu&#39;s Homepage" class="md-nav__button md-logo" aria-label="Qiang Liu's Homepage" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    Qiang Liu's Homepage
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Home
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Posts
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#debug-with-qemu" class="md-nav__link">
    <span class="md-ellipsis">
      Debug with QEMU
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#boostrapping" class="md-nav__link">
    <span class="md-ellipsis">
      Boostrapping
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Boostrapping">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#change-0-arch" class="md-nav__link">
    <span class="md-ellipsis">
      Change 0: ARCH
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#change-1-from-32-bit-to-64-bit" class="md-nav__link">
    <span class="md-ellipsis">
      Change 1, from 32-bit to 64-bit
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#interrupts" class="md-nav__link">
    <span class="md-ellipsis">
      Interrupts
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Interrupts">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#change-3-update-idt" class="md-nav__link">
    <span class="md-ellipsis">
      Change 3, update IDT
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#change-4-update-irss" class="md-nav__link">
    <span class="md-ellipsis">
      Change 4: update IRSs
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#change-5-change-the-pt_regs-according-to-the-stack" class="md-nav__link">
    <span class="md-ellipsis">
      Change 5: change the pt_regs according to the stack
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


<h1 id="hypercube-os-for-x86_64">HyperCube OS for x86_64</h1>
<p>I simply explain how to update
<a href="https://github.com/RUB-SysSec/Hypercube">HyperCubeOS</a> to support x86_64.</p>
<h2 id="debug-with-qemu">Debug with QEMU</h2>
<p>Before the details, let me briefly introduce how to debug HyperCubeOS.</p>
<p>Compile HyperCubeOS.</p>
<pre><code>user$ pushd os &amp;&amp; make &amp;&amp; popd
</code></pre>
<p>Open two shells. Launch HyperCubeOS in shell 1.</p>
<pre><code>user$ qemu-system-x86_64 \
    -cdrom os/iso/hypercube_os_bios.iso \
    -serial mon:stdio -m 100 -net none -S -s
</code></pre>
<p>Attach GDB to QEMU in shell 2.</p>
<pre><code>user$ sudo gdb-multiarch os/isofiles/boot/kernel.bin
 gdb$ b kernel_main
 gdb$ directory os/src/
 gdb$ target remote:1234
 gdb$ c
</code></pre>
<h2 id="boostrapping">Boostrapping</h2>
<p>Overall, HyperCubeOS (which is in fact an ELF) is bootstrapped by a bootloader
(e.g., <a href="https://www.gnu.org/software/grub/">GRUB2</a>). The bootloader and
HyperCubeOS are packed into <code>os/iso/hypercube_os_bios.iso</code>.</p>
<p>Bootstrapping is way too arch-specific. It is just painful to revisit
x86/x86_64's ISAs. Here is a short summary of different CPU modes.</p>
<ul>
<li>System Management Mode -&gt; Real mode -&gt; Protected Mode &lt;-&gt; Virtual 8086 Mode</li>
<li>Protected Mode &lt;-&gt; Long Mode (64-bit Mode &lt;-&gt; Compatibility Mode)</li>
<li>Virtual 8086 Mode is designed to run real mode program</li>
<li>Protected mode cannot support 64-bit OS</li>
<li>Long mode can support both 64-bit (64-bit mode) and 32-bit (compatibility
mode) userspace applications</li>
<li>In the long mode, registers are 64-bit</li>
<li>The long mode has 8 more general purpose registers to use (16 in total, while aarch64 has 31)</li>
</ul>
<table>
<thead>
<tr>
<th style="text-align: center;">Operating Mode</th>
<th style="text-align: center;">Shilf-and-add Segmentation</th>
<th style="text-align: center;">Paging</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;">Real Mode</td>
<td style="text-align: center;">Enabled</td>
<td style="text-align: center;">Not existing</td>
</tr>
<tr>
<td style="text-align: center;">Protected Mode (80286)</td>
<td style="text-align: center;">Enabled</td>
<td style="text-align: center;">Optional</td>
</tr>
<tr>
<td style="text-align: center;">Protected Mode (80386 and above)</td>
<td style="text-align: center;">Enabled</td>
<td style="text-align: center;">Optional</td>
</tr>
<tr>
<td style="text-align: center;">Compatibility Mode</td>
<td style="text-align: center;">Enabled</td>
<td style="text-align: center;">Enabled</td>
</tr>
<tr>
<td style="text-align: center;">64-Bit Mode</td>
<td style="text-align: center;">Bypassed</td>
<td style="text-align: center;">Enabled</td>
</tr>
</tbody>
</table>
<h3 id="change-0-arch">Change 0: ARCH</h3>
<p>I added ARCH (x86, x86_64, and aarch64 (not implemented yet)) to relative
Makefiles and bash scripts. Nothing unexpected.</p>
<h3 id="change-1-from-32-bit-to-64-bit">Change 1, from 32-bit to 64-bit</h3>
<p>We need the CPU running in the long mode to support 64-bit mode.</p>
<p>GRUB2 is so limited. It cannot switch to the long mode by design. After the
bootloader GRUB2 gives the control flow to the kernel, the CPU is in the
protected mode. To run 64-bit programs, we need to switch the CPU to the long
mode with paging enabled manually. Prior to switching to the long mode, GRUB2
sets up two arguments that matter, 1) $eax (the magic value "0x36d76289" that
indicates that the HyperCubeOS was loaded by a MultiBoot2-compiant boot loader)
and 2) $eax (a 32-bit physical address of the Multiboot2 information structure
defined in <a href="https://www.gnu.org/software/grub/manual/multiboot2/multiboot.html#Boot-information-format">Multiboot2 Specification version
2.0</a>.
I tried to save $eax and $ebx, set up the page table (cr3 -&gt; pml4t -&gt; pdpt -&gt;
pdt -&gt; pt), and set up the GDT
<a href="https://wiki.osdev.org/Setting_Up_Long_Mode#The_Switch_from_Protected_Mode">manually</a>,
but I found it very problematic to use GRUB2 (a discussion is also available
<a href="https://wiki.osdev.org/Creating_a_64-bit_kernel">here</a>). I chose
<a href="https://wiki.osdev.org/Limine">Limine</a> as an alternative.</p>
<h2 id="interrupts">Interrupts</h2>
<p>Important data structures.</p>
<ul>
<li>ISRs are stored in the Interrupt Descriptor Table (IDT) when you're in
Protected mode, or in the Interrupt Vector Table (IVT) when you're in Real Mode.</li>
<li>IDTR has two fields, limit and base. IDTR.limit constraints the number of IDT
entries and IDTR.base points to the first IDT entry. Each IDT entry has the
interrupt handler address and a few flags. Note that, IDT entry is 16-byte in
x86_64, while it is 8-byte in x86. Note that compilers may have problems with
assembly to write the interrupt handler, so take a two-stage assembly wrapping
(see <a href="https://wiki.osdev.org/ISR">this</a>).</li>
</ul>
<h3 id="change-3-update-idt">Change 3, update IDT</h3>
<p>I updated the definition of IDT entry and then filled each entry up. Note that
GDT is set up by Limine (but is simply ignored I guess).</p>
<h3 id="change-4-update-irss">Change 4: update IRSs</h3>
<p>If the interrupt is an exception, the CPU will push an error code onto the stack
if any, padded with bytes to form a doubleword (x86) or quadword (x86_64). If
not, we push a fake error code.</p>
<h3 id="change-5-change-the-pt_regs-according-to-the-stack">Change 5: change the pt_regs according to the stack</h3>







  
    
  
  


  <aside class="md-source-file">
    
      
  <span class="md-source-file__fact">
    <span class="md-icon" title="Last update">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M21 13.1c-.1 0-.3.1-.4.2l-1 1 2.1 2.1 1-1c.2-.2.2-.6 0-.8l-1.3-1.3c-.1-.1-.2-.2-.4-.2m-1.9 1.8-6.1 6V23h2.1l6.1-6.1-2.1-2M12.5 7v5.2l4 2.4-1 1L11 13V7h1.5M11 21.9c-5.1-.5-9-4.8-9-9.9C2 6.5 6.5 2 12 2c5.3 0 9.6 4.1 10 9.3-.3-.1-.6-.2-1-.2s-.7.1-1 .2C19.6 7.2 16.2 4 12 4c-4.4 0-8 3.6-8 8 0 4.1 3.1 7.5 7.1 7.9l-.1.2v1.8Z"/></svg>
    </span>
    <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-date">June 3, 2024</span>
  </span>

    
    
    
    
  </aside>





                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../..", "features": ["navigation.tabs", "navigation.tabs.sticky", "navigation.tracking"], "search": "../../assets/javascripts/workers/search.f886a092.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.d7c377c4.min.js"></script>
      
    
  </body>
</html>