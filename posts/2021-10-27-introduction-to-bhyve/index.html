
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://github.com/cyruscyliu/cyruscyliu.github.io/posts/2021-10-27-introduction-to-bhyve/">
      
      
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.5.3, mkdocs-material-9.5.2">
    
    
      
        <title>Introduction to Bhyve - Qiang Liu's Homepage</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.50c56a3b.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Fira+Code:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Fira Code";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#introduction-to-bhyve" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow md-header--lifted" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="Qiang Liu&#39;s Homepage" class="md-header__button md-logo" aria-label="Qiang Liu's Homepage" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Qiang Liu's Homepage
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Introduction to Bhyve
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var media,input,key,value,palette=__md_get("__palette");if(palette&&palette.color){"(prefers-color-scheme)"===palette.color.media&&(media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']"),palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent"));for([key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
    
      
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../.." class="md-tabs__link">
        
  
    
  
  Home

      </a>
    </li>
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../" class="md-tabs__link">
        
  
    
  
  Posts

      </a>
    </li>
  

      
    </ul>
  </div>
</nav>
    
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Qiang Liu&#39;s Homepage" class="md-nav__button md-logo" aria-label="Qiang Liu's Homepage" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    Qiang Liu's Homepage
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Home
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Posts
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#what-is-bhyve123" class="md-nav__link">
    <span class="md-ellipsis">
      What is Bhyve?[^1][^2][^3]
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#components5" class="md-nav__link">
    <span class="md-ellipsis">
      Components[^5]
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#dismistafication" class="md-nav__link">
    <span class="md-ellipsis">
      Dismistafication
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#vmx-vmcs-maintenace-instructions" class="md-nav__link">
    <span class="md-ellipsis">
      VMX (VMCS-maintenace) instructions
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#some-data-structs" class="md-nav__link">
    <span class="md-ellipsis">
      Some data structs
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#bhyve-vmexit-code" class="md-nav__link">
    <span class="md-ellipsis">
      BHyve VMExit code
    </span>
  </a>
  
    <nav class="md-nav" aria-label="BHyve VMExit code">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#example-vmexit_inout" class="md-nav__link">
    <span class="md-ellipsis">
      Example: vmexit_inout
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#some-data-structs_1" class="md-nav__link">
    <span class="md-ellipsis">
      Some data structs
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#virtual-devices-dummy-means-very-low-fidelity-old-bhyve" class="md-nav__link">
    <span class="md-ellipsis">
      Virtual devices (dummy means very low fidelity) (Old BHyve)
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Virtual devices (dummy means very low fidelity) (Old BHyve)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#virtual-device-initialization" class="md-nav__link">
    <span class="md-ellipsis">
      Virtual device initialization
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#extend-btest-like-qtest-to-bhyve" class="md-nav__link">
    <span class="md-ellipsis">
      Extend BTest (like QTest) to BHyve
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


<h1 id="introduction-to-bhyve">Introduction to Bhyve</h1>
<p>In this short article, I'm going to introduce what is Bhyve, how it works, and
how to modify it.</p>
<h2 id="what-is-bhyve123">What is Bhyve?[^1][^2][^3]</h2>
<ul>
<li>Bhyve, pronounced "beehive", is a hypervisor for FreeBSD.</li>
<li>Bhyve runs on x86_64 host and supports i386 and x86_64 guests.</li>
<li>Bhyve requires VT-x/EPT CPU support (core i*).</li>
<li>Bhyve consists of a kernel module: <code>vmm.ko</code>, a library <code>libvmmapi</code>, and some
utilities <code>bhyve</code>, <code>bhyveload</code>, and <code>bhyvectl</code>. Yes, it works as a kernel model
like <code>KVM</code>.</li>
<li>The source code is in the FreeBSD SVN source repository: sys/amd64/vmm/,
usr.sbin/bhyve/, usr.sbin/bhyveload/, usr.sbin/bhyvectl/, and lib/libvmmapi/</li>
<li>Variants: <a href="https://github.com/machyve/xhyve">xhyve</a>[^4], <a href="https://www.pluribusnetworks.com/products/white-box-os/">Pluribus
Netvisor</a>, <a href="https://bhyvecon.org/bhyvecon2018-Gwydir.pdf">bhyve in
Illumos-based distributions</a>.</li>
</ul>
<h2 id="components5">Components[^5]</h2>
<table>
<thead>
<tr>
<th style="text-align: center;">component</th>
<th style="text-align: center;">functionality</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;">vmm.ko</td>
<td style="text-align: center;">VT-x, local APCI, VT-d for PCI pass-thru, guest phymem mgmt, user-space cdev-interface</td>
</tr>
<tr>
<td style="text-align: center;">bhyveload</td>
<td style="text-align: center;">user-space bootloader, userboot lib + bhyve API, creates VM, lays out kernel + metadata, sets up initial VM register state</td>
</tr>
<tr>
<td style="text-align: center;">bhyve</td>
<td style="text-align: center;">user-space run loop, PCI bus/device emulation, device backends, threads for vCPU, i/o devs, kqueue loop</td>
</tr>
<tr>
<td style="text-align: center;">bhyvectl</td>
<td style="text-align: center;">dump/modify VM state, dump VM stats, delete VMs</td>
</tr>
<tr>
<td style="text-align: center;">libvmmapi</td>
<td style="text-align: center;">userland API</td>
</tr>
</tbody>
</table>
<h2 id="dismistafication">Dismistafication</h2>
<ul>
<li>vhyveload only supports FreeBSD, grub2-bhyve can load Linux and OpenBSD</li>
<li>each /dev/vmm/${vmname} contains each VM instance state</li>
<li>VMX-root: hypervisor, VMX-non-root: VM</li>
</ul>
<h2 id="vmx-vmcs-maintenace-instructions">VMX (VMCS-maintenace) instructions</h2>
<ul>
<li>VMPTRLD — It makes the referenced VMCS active and current.</li>
<li>VMPTRST — The current-VMCS pointer is stored into the destination operand.</li>
<li>VMCLEAR — The instruction sets the launch state of the VMCS referenced by the operand to “clear”, renders that VMCS inactive, and ensures that data for
the VMCS have been written to the VMCS-data area in the referenced VMCS region. If the operand is the same as the current-VMCS pointer, that pointer is made invalid.</li>
<li>VMREAD — This instruction reads a component from a VMCS.</li>
<li>VMWRITE — This instruction writes a component to a VMCS.</li>
<li><strong>VMLAUNCH</strong> — This instruction launches a virtual machine managed by the VMCS. A VM entry occurs, transferring control to the VM.</li>
<li><strong>VMRESUME</strong> — This instruction resumes a virtual machine managed by the VMCS. A VM entry occurs, transferring control to the VM.</li>
<li>VMXOFF — This instruction causes the processor to leave VMX operation.</li>
<li>VMXON — It causes a logical processor to enter VMX root operation. (vmm_init -&gt; vm_init -&gt; vm_enable -&gt; vmxon)</li>
<li>INVEPT — This instruction invalidates entries in the TLBs and paging-structure caches that were derived from extended page tables (EPT).</li>
<li>INVVPID — This instruction invalidates entries in the TLBs and paging-structure caches based on a VirtualProcessor Identifier (VPID).</li>
<li><strong>VMCALL</strong> — This instruction allows software in VMX non-root operation to call the VMM for service. A VM exit occurs, transferring control to the VMM.</li>
<li><strong>VMFUNC</strong> — This instruction allows software in VMX non-root operation to invoke a VM function (processor functionality enabled and configured by software in VMX root operation) without a VM exit.</li>
</ul>
<h2 id="some-data-structs">Some data structs</h2>
<pre><code class="language-c">#define VM_MAXCPU   8
struct vm_exit {
    enum vm_exitcode    exitcode;
    int                 inst_length;    /* 0 means unknown */
    uint64_t            rip;
    union {
        struct {} inout; // direction, how many bytes, port number, eax for out
        struct {} paging;
        struct {} vmx;
        struct {} msr;
    } u;
};
struct vm_exit vmexit[VM_MAXCPU];
</code></pre>
<p>The above code defines exit information for each virtual cpu.</p>
<h2 id="bhyve-vmexit-code">BHyve VMExit code</h2>
<table>
<thead>
<tr>
<th style="text-align: center;">code</th>
<th style="text-align: center;">handler</th>
<th style="text-align: center;">description</th>
<th style="text-align: center;">next</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;">VM_EXITCODE_INOUT</td>
<td style="text-align: center;">vmexit_inout</td>
<td style="text-align: center;">in and out instructions</td>
<td style="text-align: center;">VMEXIT_CONTINUE or VMEXIT_ABORT</td>
</tr>
<tr>
<td style="text-align: center;">VM_EXITCODE_VMX</td>
<td style="text-align: center;">vmexit_vmx</td>
<td style="text-align: center;">vm exit</td>
<td style="text-align: center;">VMEXIT_ABORT</td>
</tr>
<tr>
<td style="text-align: center;">VM_EXITCODE_BOGUS</td>
<td style="text-align: center;">vmexit_bogus</td>
<td style="text-align: center;"></td>
<td style="text-align: center;">VMEXIT_RESTART or VMEXIT_SWITCH</td>
</tr>
<tr>
<td style="text-align: center;">VM_EXITCODE_RDMSR</td>
<td style="text-align: center;">vmexit_rdmsr</td>
<td style="text-align: center;">Local APIC</td>
<td style="text-align: center;">VMEXIT_ABORT</td>
</tr>
<tr>
<td style="text-align: center;">VM_EXITCODE_WRMSR</td>
<td style="text-align: center;">vmexit_wrmsr -&gt; emulate_wrmsr</td>
<td style="text-align: center;">Local APIC</td>
<td style="text-align: center;">VMEXIT_CONTINUE or VMEXIT_SWITCH</td>
</tr>
<tr>
<td style="text-align: center;">VM_EXITCODE_MTRAP</td>
<td style="text-align: center;">vmexit_mtrap</td>
<td style="text-align: center;"></td>
<td style="text-align: center;">VMEXIT_RESTART</td>
</tr>
<tr>
<td style="text-align: center;">VM_EXITCODE_PAGING</td>
<td style="text-align: center;">vmexit_paging -&gt; emulate_instruction</td>
<td style="text-align: center;"></td>
<td style="text-align: center;">VMEXIT_CONTINUE or VMEXIT_ABORT</td>
</tr>
</tbody>
</table>
<h3 id="example-vmexit_inout">Example: vmexit_inout</h3>
<pre><code class="language-c">static int
vmexit_inout(struct vmctx *ctx, struct vm_exit *vme, int *pvcpu)
{
    // ignore ins/outs
    if (vme-&gt;u.inout.string || vme-&gt;u.inout.rep)
        return (VMEXIT_ABORT);
    // reset: out 0x64, 0xFE -&gt; vmexit_catch_reset -&gt; VMEXIT_RESET
    if (out &amp;&amp; port == 0x64 &amp;&amp; (uint8_t)eax == 0xFE)
        return (vmexit_catch_reset());
    // host notification: out 0x488, {0, 1, 5} -&gt; VMEXIT_CONTINUE
    if (out &amp;&amp; port == GUEST_NIO_PORT)
            return (vmexit_handle_notify(ctx, vme, pvcpu, eax));
    // handle other in/out
    error = emulate_inout(ctx, vcpu, in, port, bytes, &amp;eax, strictio);
    if (error == 0 &amp;&amp; in)
        error = vm_set_register(ctx, vcpu, VM_REG_GUEST_RAX, eax);
    if (error == 0)
        return (VMEXIT_CONTINUE);
    else {
        return (vmexit_catch_inout()); // VMEXIT_ABORT
    }
}
</code></pre>
<h2 id="some-data-structs_1">Some data structs</h2>
<pre><code class="language-c">#define SET_DECLARE(set, ptype)                 \
    extern ptype *__CONCAT(__start_set_,set);   \
    extern ptype *__CONCAT(__stop_set_,set)
#define SET_BEGIN(set)                          \
    (&amp;__CONCAT(__start_set_,set))
#define SET_LIMIT(set)                          \
    (&amp;__CONCAT(__stop_set_,set))
#define SET_FOREACH(pvar, set)                  \
    for (pvar = SET_BEGIN(set); pvar &lt; SET_LIMIT(set); pvar++)
#define SET_ITEM(set, i)                        \
    ((SET_BEGIN(set))[i])
#define SET_COUNT(set)                          \
    (SET_LIMIT(set) - SET_BEGIN(set))

SET_DECLARE(pci_devemu_set, struct pci_devemu);

struct pci_devemu {
    char      *pe_emu;      /* Name of device emulation */
    /* instance creation */
    int       (*pe_init)(struct vmctx *, struct pci_devinst *, char *opts);
    /* config space read/write callbacks */
    int       (*pe_cfgwrite)(...)
    int       (*pe_cfgread)(...)
    /* I/O space read/write callbacks */
    void      (*pe_iow)(...)
    uint32_t  (*pe_ior)(...)
};

#ifdef __GNUCLIKE___SECTION
#define __MAKE_SET(set, sym)                        \
    __GLOBL(__CONCAT(__start_set_,set));                \
    __GLOBL(__CONCAT(__stop_set_,set));             \
    static void const * const __set_##set##_sym_##sym       \
    __section(&quot;set_&quot; #set) __used = &amp;sym
#else /* !__GNUCLIKE___SECTION */
#ifndef lint
#error this file needs to be ported to your compiler
#endif /* lint */
#define __MAKE_SET(set, sym)    extern void const * const (__set_##set##_sym_##sym)
#endif /* __GNUCLIKE___SECTION */

#define TEXT_SET(set, sym)  __MAKE_SET(set, sym)
#define DATA_SET(set, sym)  __MAKE_SET(set, sym)
#define BSS_SET(set, sym)   __MAKE_SET(set, sym)
#define ABS_SET(set, sym)   __MAKE_SET(set, sym)
#define SET_ENTRY(set, sym) __MAKE_SET(set, sym)

PCI_EMUL_SET(pci_xxx);
</code></pre>
<p>The above code defines name and callbacks of each PCI devices.</p>
<h2 id="virtual-devices-dummy-means-very-low-fidelity-old-bhyve">Virtual devices (dummy means very low fidelity) (Old BHyve)</h2>
<table>
<thead>
<tr>
<th style="text-align: center;">peripheral</th>
<th style="text-align: center;">file</th>
<th style="text-align: center;">description</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;">atpic</td>
<td style="text-align: center;">usr.sbin/bhyve/atpic.c</td>
<td style="text-align: center;">dummy</td>
</tr>
<tr>
<td style="text-align: center;">console</td>
<td style="text-align: center;">usr.sbin/bhyve/consport.c</td>
<td style="text-align: center;">ttyread|ttywrite</td>
</tr>
<tr>
<td style="text-align: center;">gdbport</td>
<td style="text-align: center;">usr.sbin/bhyve/dbgport.c</td>
<td style="text-align: center;">bind, listen, accept, read|write</td>
</tr>
<tr>
<td style="text-align: center;">elcr</td>
<td style="text-align: center;">usr.sbin/bhyve/dbgport.c</td>
<td style="text-align: center;">dummy</td>
</tr>
<tr>
<td style="text-align: center;">pit 8254</td>
<td style="text-align: center;">usr.sbin/bhyve/pit_8254.c</td>
<td style="text-align: center;">pit_8254_handler</td>
</tr>
<tr>
<td style="text-align: center;">post</td>
<td style="text-align: center;">usr.sbin/bhyve/post.c</td>
<td style="text-align: center;">dummy</td>
</tr>
<tr>
<td style="text-align: center;">rtc</td>
<td style="text-align: center;">usr.sbin/bhyve/rtc.c</td>
<td style="text-align: center;">rtc_addr_handler|rtc_data_handler</td>
</tr>
<tr>
<td style="text-align: center;">uart</td>
<td style="text-align: center;">usr.sbin/bhyve/uart.c</td>
<td style="text-align: center;">dummy</td>
</tr>
<tr>
<td style="text-align: center;">pci-dummy</td>
<td style="text-align: center;">usr.sbin/bhyve/pci_emul.c</td>
<td style="text-align: center;">pci_emul_dinit|pci_emul_diow|pci_emul_dior</td>
</tr>
<tr>
<td style="text-align: center;">pci-hostbridge</td>
<td style="text-align: center;">usr.sbin/bhyve/pci_hostbridge.c</td>
<td style="text-align: center;">pci_hostbridge_init</td>
</tr>
<tr>
<td style="text-align: center;">pci-passthru</td>
<td style="text-align: center;">usr.sbin/bhyve/pci_passthru.c</td>
<td style="text-align: center;">/dev/pci, /dev/io</td>
</tr>
<tr>
<td style="text-align: center;">pci-uart</td>
<td style="text-align: center;">usr.sbin/bhyve/pci_uart.c</td>
<td style="text-align: center;">pci_uart_init|pci_uart_write|pci_uart_read</td>
</tr>
<tr>
<td style="text-align: center;">pci-virtio-blk</td>
<td style="text-align: center;">usr.sbin/bhyve/pci_virtio_block.c</td>
<td style="text-align: center;">pci_vtblk_init|pci_vtblk_write|pci_vtblk_read</td>
</tr>
<tr>
<td style="text-align: center;">pci-virtio-net</td>
<td style="text-align: center;">usr.sbin/bhyve/pci_virtio_net.c</td>
<td style="text-align: center;">pci_vtnet_init|pci_vtnet_write|pci_vtnet_read</td>
</tr>
</tbody>
</table>
<h3 id="virtual-device-initialization">Virtual device initialization</h3>
<pre><code class="language-txt">while (c = getopt())
    switch (c)
        case 's':
            pci_parse_slot(optarg, 0); // not legacy
            break;
        case 'S':
            pci_parse_slot(optarg, 1); // legacy
            break;
        // ------------------------------
        // pci_parse_slot
        // ------------------------------
        // snum is from 0 to 31
        // 0,hostbridge
        // 1,virtio-net,tap0
        // pci_slotinfo[snum].si_name = emul; // hostbridge, virtio-net
        // pci_slotinfo[snum].si_param = config; // null, tap0
        // pci_slotinfo[snum].si_legacy = legacy; // 0, 1
init_inout
    install handler for each port: atpic, console, gdbport, elcr, pci_emu, pit 8254, post, rtc, and uart.
init_pci
    // it depends on opts
    pde = pci_emul_finddev(si-&gt;si_name);
    if (pde != NULL) {
        pci_emul_init(ctx, pde, i, si-&gt;si_param); // invoke -&gt;init
</code></pre>
<h2 id="extend-btest-like-qtest-to-bhyve">Extend BTest (like QTest) to BHyve</h2>
<p>The basic idea of BTest is to implement the same primitives as QTest. We can
leverage PCI interfaces to implemented it because we are doing in-memory fuzzing
rather than doing traps.</p>
<p>[^1]: <a href="https://bhyve.org/">Homepage of Bhyve</a> \
[^2]: <a href="https://en.wikipedia.org/wiki/Bhyve">Wikipedia of Bhyve</a> \
[^3]: <a href="https://wiki.freebsd.org/bhyve">Q&amp;A of Byyve</a> \
[^4]: <a href="https://www.vpsee.com/2015/06/mac-os-x-hypervisor-xhyve-based-on-bhyve/">xhyve</a> \
[^5]: <a href="https://people.freebsd.org/~grehan/talks/eurobsdcon_2013_bhyve.pdf">Extending bhyve beyond FreeBD guests</a></p>







  
    
  
  


  <aside class="md-source-file">
    
      
  <span class="md-source-file__fact">
    <span class="md-icon" title="Last update">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M21 13.1c-.1 0-.3.1-.4.2l-1 1 2.1 2.1 1-1c.2-.2.2-.6 0-.8l-1.3-1.3c-.1-.1-.2-.2-.4-.2m-1.9 1.8-6.1 6V23h2.1l6.1-6.1-2.1-2M12.5 7v5.2l4 2.4-1 1L11 13V7h1.5M11 21.9c-5.1-.5-9-4.8-9-9.9C2 6.5 6.5 2 12 2c5.3 0 9.6 4.1 10 9.3-.3-.1-.6-.2-1-.2s-.7.1-1 .2C19.6 7.2 16.2 4 12 4c-4.4 0-8 3.6-8 8 0 4.1 3.1 7.5 7.1 7.9l-.1.2v1.8Z"/></svg>
    </span>
    <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-date">March 6, 2022</span>
  </span>

    
    
    
    
  </aside>





                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../..", "features": ["navigation.tabs", "navigation.tabs.sticky", "navigation.tracking"], "search": "../../assets/javascripts/workers/search.f886a092.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.d7c377c4.min.js"></script>
      
    
  </body>
</html>