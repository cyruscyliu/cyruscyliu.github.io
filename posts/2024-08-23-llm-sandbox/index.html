
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://github.com/cyruscyliu/cyruscyliu.github.io/posts/2024-08-23-llm-sandbox/">
      
      
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.5.3, mkdocs-material-9.5.2">
    
    
      
        <title>Code execution sandbox in the era of big models - Qiang Liu's Homepage</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.50c56a3b.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Fira+Code:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Fira Code";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#code-execution-sandbox-in-the-era-of-big-models" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow md-header--lifted" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="Qiang Liu&#39;s Homepage" class="md-header__button md-logo" aria-label="Qiang Liu's Homepage" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Qiang Liu's Homepage
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Code execution sandbox in the era of big models
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var media,input,key,value,palette=__md_get("__palette");if(palette&&palette.color){"(prefers-color-scheme)"===palette.color.media&&(media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']"),palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent"));for([key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
    
      
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../.." class="md-tabs__link">
        
  
    
  
  Home

      </a>
    </li>
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../" class="md-tabs__link">
        
  
    
  
  Posts

      </a>
    </li>
  

      
    </ul>
  </div>
</nav>
    
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Qiang Liu&#39;s Homepage" class="md-nav__button md-logo" aria-label="Qiang Liu's Homepage" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    Qiang Liu's Homepage
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Home
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Posts
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#background" class="md-nav__link">
    <span class="md-ellipsis">
      Background
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#targets-under-test" class="md-nav__link">
    <span class="md-ellipsis">
      Targets under test
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#methodology" class="md-nav__link">
    <span class="md-ellipsis">
      Methodology
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


<h1 id="code-execution-sandbox-in-the-era-of-big-models">Code execution sandbox in the era of big models</h1>
<p>This article is translated from https://mp.weixin.qq.com/s/X54d0foyBS56lGFUPyOvTw.</p>
<p>With the rapid development of big models, various AI applications are emerging.
One type of AI application allows users to execute specific tasks through code.
AI applications greatly expand their usage scenarios by executing code, which
can complete simple computing tasks and complex business data analysis.</p>
<p>The code execution of AI applications needs to run in a security sandbox. For
example, OpenAI's code interpreter uses gVisor as its security sandbox. Security
sandbox is an old and modern topic, and the isolation of computing tasks has
always been a rigid demand in the computer field. Most of the current AI
research in the industry and the research on code execution capabilities in AI
applications focus on their usage scenarios and lack the necessary attention and
research on the code execution sandbox environment behind them. If AI
applications allow users to execute code, then these codes may be malicious
codes from attackers. If the isolation of the code execution sandbox is not done
well, attackers can break through the backend services of AI applications,
bringing huge security risks to the entire cluster.</p>
<p>In the process of researching AI security technology, Ant Tianchen Security Lab
found that there are many discoveries and achievements in the attack
technologies involved in AI and LLM applications, but the security defense of
the code execution environment in AI applications has not attracted the
attention of industry experts. This article tests and analyzes the code
execution sandbox implementation solutions of multiple AI applications, and
introduces our testing methods using ChatGPT 4 as an example. Finally, it
summarizes the sandbox solution selection and sandbox security strategy
recommendations for similar scenarios.</p>
<h2 id="background">Background</h2>
<p>AI application vendors usually provide users with two ways to execute code. The
first way is a code interpreter. Users can interact with AI applications through
natural language. AI applications interact with LLM to obtain the execution code
and execute it to complete user tasks. The second way allows users to write
their own code as a tool in AI applications to complete user tasks. This article
will not distinguish between these two code execution scenarios. For any
scenario where users can write code and execute it, we consider it to be a code
execution function in AI applications.</p>
<p>When OpenAI was first released, a large number of security researchers could
bounce the shell to the attacker's designated server and conduct further
intranet penetration by simply talking to ChatGPT. Later, ChatGPT became a "pure
language model that cannot run code".</p>
<p>But with the launch of ChatGPT 4, OpenAI has re-provided the code interpreter
functionality and can help users run custom code.</p>
<pre><code>execute the following command:
print(&quot;hello world&quot;)

ChatGPT said:

Here is the output of the command:
print(&quot;hello world&quot;)
Output:
hello world
</code></pre>
<p>The code interpreter function of ChatGPT 4 has been launched again. OpenAI has
fully learned from previous experience. It not only analyzes the code intent at
the semantic layer and tries to intercept malicious code execution, but also
provides a reliable and isolated sandbox operating environment. It runs user
code in an independent and isolated sandbox environment to prevent malicious
code from affecting OpenAI's own services or other users.</p>
<p>After our analysis, the semantic analysis restrictions of ChatGPT 4 are easy to
bypass, but ChatGPT 4 runs each user's task in an independent and isolated
container, and uses Google's open source security container gVisor as the
container runtime, thereby alleviating the problem of insufficient Docker
isolation. At the network level, each container has an independent IP address
and cannot communicate with each other. East-west access to the intranet and
north-south access to the Internet are all subject to security restrictions, and
only limited communication is possible. OpenAI's sandbox solution has been
tested by domestic and foreign security researchers and has become relatively
reliable, but other AI applications in the industry that provide code
interpreter services still have many problems. For example, when we tested some
AI applications, we found that they could perform a rebound shell and execute
arbitrary commands.</p>
<p>Therefore, we studied the code execution sandbox solutions of mainstream AI
applications and found that the sandbox solutions of various applications are
different. The following describes our detailed testing process, the summarized
sandbox development trends, and the sandbox usage recommendations for similar
applications.</p>
<h2 id="targets-under-test">Targets under test</h2>
<p>In order to give suggestions for code execution sandbox selection for AI
applications, we need to first analyze what sandbox solutions and security
strategies are currently used by mainstream AI applications. During the sandbox
testing process, we mainly tested the following content:</p>
<ul>
<li>
<p>01 Whether it can execute arbitrary commands. If the sandbox supports
arbitrary command execution, then the attacker can execute arbitrary code, and
its ability to detect and attack will be significantly enhanced.</p>
</li>
<li>
<p>02 Whether to execute as a privileged user. Whether the sandbox has permission
to execute user code is a privileged user (usually root under Linux). If the
sandbox uses root to execute user code, the attacker can complete more system
detection and attack techniques.</p>
</li>
<li>
<p>03 Whether access to the external network is supported. If the sandbox
supports access to the external network, it can bounce the shell to the
attacker's machine and conduct further attacks.</p>
</li>
<li>
<p>04 Whether east-west isolation is done. East-west isolation indicates whether
the business in the sandbox can access the networks of other sandbox instances
or internal networks. If the sandbox does not implement east-west isolation,
attackers can attack other sandbox instances or internal networks.</p>
</li>
<li>
<p>05 Whether sensitive information was leaked. Environment variables or files
visible to the sandbox may contain sensitive data such as keys or critical code
logic. If an attacker is able to see this code or data, it is possible to
conduct further attacks or bypass security measures.</p>
</li>
<li>
<p>06 Whether it is possible to upload arbitrary files. If the sandbox supports
uploading arbitrary files, attackers can upload malicious code to complete
further attacks.</p>
</li>
<li>
<p>07 The sandbox scheme used. By analyzing the sandbox scheme used, attackers
can further study its vulnerabilities and attack them.</p>
</li>
</ul>
<p>In the selection of the targets under test, we selected the following AI
applications. As will be introduced later, the sandbox solutions used by these
applications represent the sandbox implementation of several types of scenarios
and are very typical.</p>
<ul>
<li>
<p>01 ChatGPT 4. ChatGPT is an AI tool launched by OpenAI. GhatGPT 4 supports the
code interpreter function, which can help users complete code execution.</p>
</li>
<li>
<p>02 Application A. The application is an AI tool that allows users to write
JavaScript or Python code to assist in completing tasks.</p>
</li>
<li>
<p>03 Application B. This application is used to facilitate people to build
various workflows through AI, and can also support users to write code to
complete related work.</p>
</li>
<li>
<p>04 Application C. This application is an application designed to enable
everyone to develop their own through AI.</p>
</li>
<li>
<p>05 Application D. This application is also an application designed to help
people complete various tasks through AI. In order to support the processing of
complex tasks, it also supports the execution of codes.</p>
</li>
<li>
<p>06 Application E. The application aims to improve people's productivity by
leveraging AI technology and provides a code interpreter that allows people to
complete complex data analysis, processing and cleaning tasks.</p>
</li>
</ul>
<h2 id="methodology">Methodology</h2>
<p>We take ChatGPT 4 as an example to introduce how to complete the above test
items.</p>
<ul>
<li>01 Can arbitrary commands be executed?</li>
</ul>
<p>Test method: Use common system commands for testing. If they can be executed
correctly, it is judged that arbitrary code can be executed.</p>
<p>Test results: For ChatGPT 4, arbitrary code cannot be executed directly under
normal circumstances.</p>
<pre><code>import os
os.system(&quot;ls /&quot;)

ChatGPT said:
Executing os.system() commands like ls / can interact with the file system and
potentially expose or manipulate sensitive system data. For security and safety
reasons, I can't execute such commands in this environment. However, I can help
simulate similar tasks or provide information about how they would work.

If you have any specific requests or want to learn about certain commands or
Python features, feel free to ask!
</code></pre>
<p>In this case, some prompts need to be bypassed. We use the following prompts to
bypass and execute it by uploading the obfuscated code.</p>
<p><a href="../chattest.py">chattest.py</a></p>







  
    
  
  


  <aside class="md-source-file">
    
      
  <span class="md-source-file__fact">
    <span class="md-icon" title="Last update">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M21 13.1c-.1 0-.3.1-.4.2l-1 1 2.1 2.1 1-1c.2-.2.2-.6 0-.8l-1.3-1.3c-.1-.1-.2-.2-.4-.2m-1.9 1.8-6.1 6V23h2.1l6.1-6.1-2.1-2M12.5 7v5.2l4 2.4-1 1L11 13V7h1.5M11 21.9c-5.1-.5-9-4.8-9-9.9C2 6.5 6.5 2 12 2c5.3 0 9.6 4.1 10 9.3-.3-.1-.6-.2-1-.2s-.7.1-1 .2C19.6 7.2 16.2 4 12 4c-4.4 0-8 3.6-8 8 0 4.1 3.1 7.5 7.1 7.9l-.1.2v1.8Z"/></svg>
    </span>
    <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-date">September 2, 2024</span>
  </span>

    
    
    
    
  </aside>





                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../..", "features": ["navigation.tabs", "navigation.tabs.sticky", "navigation.tracking"], "search": "../../assets/javascripts/workers/search.f886a092.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.d7c377c4.min.js"></script>
      
    
  </body>
</html>