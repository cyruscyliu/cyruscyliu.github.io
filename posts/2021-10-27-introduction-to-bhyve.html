<!DOCTYPE html>
<html>
<head>
<title>2021-10-27-introduction-to-bhyve.md</title>
<meta http-equiv="Content-type" content="text/html;charset=UTF-8">

<style>
/* https://github.com/microsoft/vscode/blob/master/extensions/markdown-language-features/media/markdown.css */
/*---------------------------------------------------------------------------------------------
 *  Copyright (c) Microsoft Corporation. All rights reserved.
 *  Licensed under the MIT License. See License.txt in the project root for license information.
 *--------------------------------------------------------------------------------------------*/

body {
	font-family: var(--vscode-markdown-font-family, -apple-system, BlinkMacSystemFont, "Segoe WPC", "Segoe UI", "Ubuntu", "Droid Sans", sans-serif);
	font-size: var(--vscode-markdown-font-size, 14px);
	padding: 0 26px;
	line-height: var(--vscode-markdown-line-height, 22px);
	word-wrap: break-word;
}

#code-csp-warning {
	position: fixed;
	top: 0;
	right: 0;
	color: white;
	margin: 16px;
	text-align: center;
	font-size: 12px;
	font-family: sans-serif;
	background-color:#444444;
	cursor: pointer;
	padding: 6px;
	box-shadow: 1px 1px 1px rgba(0,0,0,.25);
}

#code-csp-warning:hover {
	text-decoration: none;
	background-color:#007acc;
	box-shadow: 2px 2px 2px rgba(0,0,0,.25);
}

body.scrollBeyondLastLine {
	margin-bottom: calc(100vh - 22px);
}

body.showEditorSelection .code-line {
	position: relative;
}

body.showEditorSelection .code-active-line:before,
body.showEditorSelection .code-line:hover:before {
	content: "";
	display: block;
	position: absolute;
	top: 0;
	left: -12px;
	height: 100%;
}

body.showEditorSelection li.code-active-line:before,
body.showEditorSelection li.code-line:hover:before {
	left: -30px;
}

.vscode-light.showEditorSelection .code-active-line:before {
	border-left: 3px solid rgba(0, 0, 0, 0.15);
}

.vscode-light.showEditorSelection .code-line:hover:before {
	border-left: 3px solid rgba(0, 0, 0, 0.40);
}

.vscode-light.showEditorSelection .code-line .code-line:hover:before {
	border-left: none;
}

.vscode-dark.showEditorSelection .code-active-line:before {
	border-left: 3px solid rgba(255, 255, 255, 0.4);
}

.vscode-dark.showEditorSelection .code-line:hover:before {
	border-left: 3px solid rgba(255, 255, 255, 0.60);
}

.vscode-dark.showEditorSelection .code-line .code-line:hover:before {
	border-left: none;
}

.vscode-high-contrast.showEditorSelection .code-active-line:before {
	border-left: 3px solid rgba(255, 160, 0, 0.7);
}

.vscode-high-contrast.showEditorSelection .code-line:hover:before {
	border-left: 3px solid rgba(255, 160, 0, 1);
}

.vscode-high-contrast.showEditorSelection .code-line .code-line:hover:before {
	border-left: none;
}

img {
	max-width: 100%;
	max-height: 100%;
}

a {
	text-decoration: none;
}

a:hover {
	text-decoration: underline;
}

a:focus,
input:focus,
select:focus,
textarea:focus {
	outline: 1px solid -webkit-focus-ring-color;
	outline-offset: -1px;
}

hr {
	border: 0;
	height: 2px;
	border-bottom: 2px solid;
}

h1 {
	padding-bottom: 0.3em;
	line-height: 1.2;
	border-bottom-width: 1px;
	border-bottom-style: solid;
}

h1, h2, h3 {
	font-weight: normal;
}

table {
	border-collapse: collapse;
}

table > thead > tr > th {
	text-align: left;
	border-bottom: 1px solid;
}

table > thead > tr > th,
table > thead > tr > td,
table > tbody > tr > th,
table > tbody > tr > td {
	padding: 5px 10px;
}

table > tbody > tr + tr > td {
	border-top: 1px solid;
}

blockquote {
	margin: 0 7px 0 5px;
	padding: 0 16px 0 10px;
	border-left-width: 5px;
	border-left-style: solid;
}

code {
	font-family: Menlo, Monaco, Consolas, "Droid Sans Mono", "Courier New", monospace, "Droid Sans Fallback";
	font-size: 1em;
	line-height: 1.357em;
}

body.wordWrap pre {
	white-space: pre-wrap;
}

pre:not(.hljs),
pre.hljs code > div {
	padding: 16px;
	border-radius: 3px;
	overflow: auto;
}

pre code {
	color: var(--vscode-editor-foreground);
	tab-size: 4;
}

/** Theming */

.vscode-light pre {
	background-color: rgba(220, 220, 220, 0.4);
}

.vscode-dark pre {
	background-color: rgba(10, 10, 10, 0.4);
}

.vscode-high-contrast pre {
	background-color: rgb(0, 0, 0);
}

.vscode-high-contrast h1 {
	border-color: rgb(0, 0, 0);
}

.vscode-light table > thead > tr > th {
	border-color: rgba(0, 0, 0, 0.69);
}

.vscode-dark table > thead > tr > th {
	border-color: rgba(255, 255, 255, 0.69);
}

.vscode-light h1,
.vscode-light hr,
.vscode-light table > tbody > tr + tr > td {
	border-color: rgba(0, 0, 0, 0.18);
}

.vscode-dark h1,
.vscode-dark hr,
.vscode-dark table > tbody > tr + tr > td {
	border-color: rgba(255, 255, 255, 0.18);
}

</style>

<style>
/* Tomorrow Theme */
/* http://jmblog.github.com/color-themes-for-google-code-highlightjs */
/* Original theme - https://github.com/chriskempson/tomorrow-theme */

/* Tomorrow Comment */
.hljs-comment,
.hljs-quote {
	color: #8e908c;
}

/* Tomorrow Red */
.hljs-variable,
.hljs-template-variable,
.hljs-tag,
.hljs-name,
.hljs-selector-id,
.hljs-selector-class,
.hljs-regexp,
.hljs-deletion {
	color: #c82829;
}

/* Tomorrow Orange */
.hljs-number,
.hljs-built_in,
.hljs-builtin-name,
.hljs-literal,
.hljs-type,
.hljs-params,
.hljs-meta,
.hljs-link {
	color: #f5871f;
}

/* Tomorrow Yellow */
.hljs-attribute {
	color: #eab700;
}

/* Tomorrow Green */
.hljs-string,
.hljs-symbol,
.hljs-bullet,
.hljs-addition {
	color: #718c00;
}

/* Tomorrow Blue */
.hljs-title,
.hljs-section {
	color: #4271ae;
}

/* Tomorrow Purple */
.hljs-keyword,
.hljs-selector-tag {
	color: #8959a8;
}

.hljs {
	display: block;
	overflow-x: auto;
	color: #4d4d4c;
	padding: 0.5em;
}

.hljs-emphasis {
	font-style: italic;
}

.hljs-strong {
	font-weight: bold;
}
</style>

<style>
/*
 * Markdown PDF CSS
 */

 body {
	font-family: -apple-system, BlinkMacSystemFont, "Segoe WPC", "Segoe UI", "Ubuntu", "Droid Sans", sans-serif, "Meiryo";
	padding: 0 12px;
}

pre {
	background-color: #f8f8f8;
	border: 1px solid #cccccc;
	border-radius: 3px;
	overflow-x: auto;
	white-space: pre-wrap;
	overflow-wrap: break-word;
}

pre:not(.hljs) {
	padding: 23px;
	line-height: 19px;
}

blockquote {
	background: rgba(127, 127, 127, 0.1);
	border-color: rgba(0, 122, 204, 0.5);
}

.emoji {
	height: 1.4em;
}

code {
	font-size: 14px;
	line-height: 19px;
}

/* for inline code */
:not(pre):not(.hljs) > code {
	color: #C9AE75; /* Change the old color so it seems less like an error */
	font-size: inherit;
}

/* Page Break : use <div class="page"/> to insert page break
-------------------------------------------------------- */
.page {
	page-break-after: always;
}

</style>
<link rel="stylesheet" href="https://cyruscyliu.github.io/styles/light-default.css" type="text/css">
<script src="https://unpkg.com/mermaid/dist/mermaid.min.js"></script>
</head>
<body>
  <script>
    mermaid.initialize({
      startOnLoad: true,
      theme: document.body.classList.contains('vscode-dark') || document.body.classList.contains('vscode-high-contrast')
          ? 'dark'
          : 'default'
    });
  </script>
<h1 id="introduction-to-bhyve">Introduction to Bhyve</h1>
<p>In this short article, I'm going to introduce what is Bhyve, how it works, and
how to modify it.</p>
<h2 id="what-is-bhyve123">What is Bhyve?[^1][^2][^3]</h2>
<ul>
<li>Bhyve, pronounced &quot;beehive&quot;, is a hypervisor for FreeBSD.</li>
<li>Bhyve runs on x86_64 host and supports i386 and x86_64 guests.</li>
<li>Bhyve requires VT-x/EPT CPU support (core i*).</li>
<li>Bhyve consists of a kernel module: <code>vmm.ko</code>, a library <code>libvmmapi</code>, and some
utilities <code>bhyve</code>, <code>bhyveload</code>, and <code>bhyvectl</code>. Yes, it works as a kernel model
like <code>KVM</code>.</li>
<li>The source code is in the FreeBSD SVN source repository: sys/amd64/vmm/,
usr.sbin/bhyve/, usr.sbin/bhyveload/, usr.sbin/bhyvectl/, and lib/libvmmapi/</li>
<li>Variants: <a href="https://github.com/machyve/xhyve">xhyve</a>[^4], <a href="https://www.pluribusnetworks.com/products/white-box-os/">Pluribus
Netvisor</a>, <a href="https://bhyvecon.org/bhyvecon2018-Gwydir.pdf">bhyve in
Illumos-based distributions</a>.</li>
</ul>
<h2 id="components5">Components[^5]</h2>
<table>
<thead>
<tr>
<th style="text-align:center">component</th>
<th style="text-align:center">functionality</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">vmm.ko</td>
<td style="text-align:center">VT-x, local APCI, VT-d for PCI pass-thru, guest phymem mgmt, user-space cdev-interface</td>
</tr>
<tr>
<td style="text-align:center">bhyveload</td>
<td style="text-align:center">user-space bootloader, userboot lib + bhyve API, creates VM, lays out kernel + metadata, sets up initial VM register state</td>
</tr>
<tr>
<td style="text-align:center">bhyve</td>
<td style="text-align:center">user-space run loop, PCI bus/device emulation, device backends, threads for vCPU, i/o devs, kqueue loop</td>
</tr>
<tr>
<td style="text-align:center">bhyvectl</td>
<td style="text-align:center">dump/modify VM state, dump VM stats, delete VMs</td>
</tr>
<tr>
<td style="text-align:center">libvmmapi</td>
<td style="text-align:center">userland API</td>
</tr>
</tbody>
</table>
<h2 id="dismistafication">Dismistafication</h2>
<ul>
<li>vhyveload only supports FreeBSD, grub2-bhyve can load Linux and OpenBSD</li>
<li>each /dev/vmm/${vmname} contains each VM instance state</li>
<li>VMX-root: hypervisor, VMX-non-root: VM</li>
</ul>
<h2 id="vmx-vmcs-maintenace-instructions">VMX (VMCS-maintenace) instructions</h2>
<ul>
<li>VMPTRLD — It makes the referenced VMCS active and current.</li>
<li>VMPTRST — The current-VMCS pointer is stored into the destination operand.</li>
<li>VMCLEAR — The instruction sets the launch state of the VMCS referenced by the operand to “clear”, renders that VMCS inactive, and ensures that data for
the VMCS have been written to the VMCS-data area in the referenced VMCS region. If the operand is the same as the current-VMCS pointer, that pointer is made invalid.</li>
<li>VMREAD — This instruction reads a component from a VMCS.</li>
<li>VMWRITE — This instruction writes a component to a VMCS.</li>
<li><strong>VMLAUNCH</strong> — This instruction launches a virtual machine managed by the VMCS. A VM entry occurs, transferring control to the VM.</li>
<li><strong>VMRESUME</strong> — This instruction resumes a virtual machine managed by the VMCS. A VM entry occurs, transferring control to the VM.</li>
<li>VMXOFF — This instruction causes the processor to leave VMX operation.</li>
<li>VMXON — It causes a logical processor to enter VMX root operation. (vmm_init -&gt; vm_init -&gt; vm_enable -&gt; vmxon)</li>
<li>INVEPT — This instruction invalidates entries in the TLBs and paging-structure caches that were derived from extended page tables (EPT).</li>
<li>INVVPID — This instruction invalidates entries in the TLBs and paging-structure caches based on a VirtualProcessor Identifier (VPID).</li>
<li><strong>VMCALL</strong> — This instruction allows software in VMX non-root operation to call the VMM for service. A VM exit occurs, transferring control to the VMM.</li>
<li><strong>VMFUNC</strong> — This instruction allows software in VMX non-root operation to invoke a VM function (processor functionality enabled and configured by software in VMX root operation) without a VM exit.</li>
</ul>
<h2 id="some-data-structs">Some data structs</h2>
<pre class="hljs"><code><div><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span>	VM_MAXCPU	8</span>
<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">vm_exit</span> {</span>
	<span class="hljs-keyword">enum</span> vm_exitcode	exitcode;
	<span class="hljs-keyword">int</span>			        inst_length;	<span class="hljs-comment">/* 0 means unknown */</span>
	<span class="hljs-keyword">uint64_t</span>		    rip;
	<span class="hljs-keyword">union</span> {
		<span class="hljs-class"><span class="hljs-keyword">struct</span> {</span>} inout; <span class="hljs-comment">// direction, how many bytes, port number, eax for out</span>
		<span class="hljs-class"><span class="hljs-keyword">struct</span> {</span>} paging;
		<span class="hljs-class"><span class="hljs-keyword">struct</span> {</span>} vmx;
		<span class="hljs-class"><span class="hljs-keyword">struct</span> {</span>} msr;
	} u;
};
<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">vm_exit</span> <span class="hljs-title">vmexit</span>[<span class="hljs-title">VM_MAXCPU</span>];</span>
</div></code></pre>
<p>The above code defines exit information for each virtual cpu.</p>
<h2 id="bhyve-vmexit-code">BHyve VMExit code</h2>
<table>
<thead>
<tr>
<th style="text-align:center">code</th>
<th style="text-align:center">handler</th>
<th style="text-align:center">description</th>
<th style="text-align:center">next</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">VM_EXITCODE_INOUT</td>
<td style="text-align:center">vmexit_inout</td>
<td style="text-align:center">in and out instructions</td>
<td style="text-align:center">VMEXIT_CONTINUE or VMEXIT_ABORT</td>
</tr>
<tr>
<td style="text-align:center">VM_EXITCODE_VMX</td>
<td style="text-align:center">vmexit_vmx</td>
<td style="text-align:center">vm exit</td>
<td style="text-align:center">VMEXIT_ABORT</td>
</tr>
<tr>
<td style="text-align:center">VM_EXITCODE_BOGUS</td>
<td style="text-align:center">vmexit_bogus</td>
<td style="text-align:center"></td>
<td style="text-align:center">VMEXIT_RESTART or VMEXIT_SWITCH</td>
</tr>
<tr>
<td style="text-align:center">VM_EXITCODE_RDMSR</td>
<td style="text-align:center">vmexit_rdmsr</td>
<td style="text-align:center">Local APIC</td>
<td style="text-align:center">VMEXIT_ABORT</td>
</tr>
<tr>
<td style="text-align:center">VM_EXITCODE_WRMSR</td>
<td style="text-align:center">vmexit_wrmsr -&gt; emulate_wrmsr</td>
<td style="text-align:center">Local APIC</td>
<td style="text-align:center">VMEXIT_CONTINUE or VMEXIT_SWITCH</td>
</tr>
<tr>
<td style="text-align:center">VM_EXITCODE_MTRAP</td>
<td style="text-align:center">vmexit_mtrap</td>
<td style="text-align:center"></td>
<td style="text-align:center">VMEXIT_RESTART</td>
</tr>
<tr>
<td style="text-align:center">VM_EXITCODE_PAGING</td>
<td style="text-align:center">vmexit_paging -&gt; emulate_instruction</td>
<td style="text-align:center"></td>
<td style="text-align:center">VMEXIT_CONTINUE or VMEXIT_ABORT</td>
</tr>
</tbody>
</table>
<h3 id="example-vmexitinout">Example: vmexit_inout</h3>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span>
<span class="hljs-title">vmexit_inout</span><span class="hljs-params">(struct vmctx *ctx, struct vm_exit *vme, <span class="hljs-keyword">int</span> *pvcpu)</span>
</span>{
    <span class="hljs-comment">// ignore ins/outs</span>
	<span class="hljs-keyword">if</span> (vme-&gt;u.inout.<span class="hljs-built_in">string</span> || vme-&gt;u.inout.rep)
		<span class="hljs-keyword">return</span> (VMEXIT_ABORT);
    <span class="hljs-comment">// reset: out 0x64, 0xFE -&gt; vmexit_catch_reset -&gt; VMEXIT_RESET</span>
	<span class="hljs-keyword">if</span> (out &amp;&amp; port == <span class="hljs-number">0x64</span> &amp;&amp; (<span class="hljs-keyword">uint8_t</span>)eax == <span class="hljs-number">0xFE</span>)
		<span class="hljs-keyword">return</span> (vmexit_catch_reset());
    <span class="hljs-comment">// host notification: out 0x488, {0, 1, 5} -&gt; VMEXIT_CONTINUE</span>
    <span class="hljs-keyword">if</span> (out &amp;&amp; port == GUEST_NIO_PORT)
            <span class="hljs-keyword">return</span> (vmexit_handle_notify(ctx, vme, pvcpu, eax));
    <span class="hljs-comment">// handle other in/out</span>
	error = emulate_inout(ctx, vcpu, in, port, bytes, &amp;eax, strictio);
	<span class="hljs-keyword">if</span> (error == <span class="hljs-number">0</span> &amp;&amp; in)
		error = vm_set_register(ctx, vcpu, VM_REG_GUEST_RAX, eax);
	<span class="hljs-keyword">if</span> (error == <span class="hljs-number">0</span>)
		<span class="hljs-keyword">return</span> (VMEXIT_CONTINUE);
	<span class="hljs-keyword">else</span> {
		<span class="hljs-keyword">return</span> (vmexit_catch_inout()); <span class="hljs-comment">// VMEXIT_ABORT</span>
	}
}
</div></code></pre>
<h2 id="some-data-structs">Some data structs</h2>
<pre class="hljs"><code><div><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> SET_DECLARE(set, ptype)					\
	extern ptype *__CONCAT(__start_set_,set);	\
	extern ptype *__CONCAT(__stop_set_,set)</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> SET_BEGIN(set)							\
	(&amp;__CONCAT(__start_set_,set))</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> SET_LIMIT(set)							\
	(&amp;__CONCAT(__stop_set_,set))</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> SET_FOREACH(pvar, set)					\
	for (pvar = SET_BEGIN(set); pvar &lt; SET_LIMIT(set); pvar++)</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> SET_ITEM(set, i)						\
	((SET_BEGIN(set))[i])</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> SET_COUNT(set)							\
	(SET_LIMIT(set) - SET_BEGIN(set))</span>

SET_DECLARE(pci_devemu_set, struct pci_devemu);

<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pci_devemu</span> {</span>
	<span class="hljs-keyword">char</span>      *pe_emu;		<span class="hljs-comment">/* Name of device emulation */</span>
	<span class="hljs-comment">/* instance creation */</span>
	<span class="hljs-keyword">int</span>       (*pe_init)(struct vmctx *, struct pci_devinst *, <span class="hljs-keyword">char</span> *opts);
	<span class="hljs-comment">/* config space read/write callbacks */</span>
	<span class="hljs-keyword">int</span>		  (*pe_cfgwrite)(...)
	<span class="hljs-keyword">int</span>	      (*pe_cfgread)(...)
	<span class="hljs-comment">/* I/O space read/write callbacks */</span>
	<span class="hljs-keyword">void</span>      (*pe_iow)(...)
	<span class="hljs-keyword">uint32_t</span>  (*pe_ior)(...)
};

<span class="hljs-meta">#<span class="hljs-meta-keyword">ifdef</span> __GNUCLIKE___SECTION</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> __MAKE_SET(set, sym)						\
	__GLOBL(__CONCAT(__start_set_,set));				\
	__GLOBL(__CONCAT(__stop_set_,set));				\
	static void const * const __set_##set##_sym_##sym 		\
	__section(<span class="hljs-meta-string">"set_"</span> #set) __used = &amp;sym</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">else</span> <span class="hljs-comment">/* !__GNUCLIKE___SECTION */</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">ifndef</span> lint</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">error</span> this file needs to be ported to your compiler</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span> <span class="hljs-comment">/* lint */</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> __MAKE_SET(set, sym)	extern void const * const (__set_##set##_sym_##sym)</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span> <span class="hljs-comment">/* __GNUCLIKE___SECTION */</span></span>

<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> TEXT_SET(set, sym)	__MAKE_SET(set, sym)</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> DATA_SET(set, sym)	__MAKE_SET(set, sym)</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> BSS_SET(set, sym)	__MAKE_SET(set, sym)</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> ABS_SET(set, sym)	__MAKE_SET(set, sym)</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> SET_ENTRY(set, sym)	__MAKE_SET(set, sym)</span>

PCI_EMUL_SET(pci_xxx);
</div></code></pre>
<p>The above code defines name and callbacks of each PCI devices.</p>
<h2 id="virtual-devices-dummy-means-very-low-fidelity-old-bhyve">Virtual devices (dummy means very low fidelity) (Old BHyve)</h2>
<table>
<thead>
<tr>
<th style="text-align:center">peripheral</th>
<th style="text-align:center">file</th>
<th style="text-align:center">description</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">atpic</td>
<td style="text-align:center">usr.sbin/bhyve/atpic.c</td>
<td style="text-align:center">dummy</td>
</tr>
<tr>
<td style="text-align:center">console</td>
<td style="text-align:center">usr.sbin/bhyve/consport.c</td>
<td style="text-align:center">ttyread|ttywrite</td>
</tr>
<tr>
<td style="text-align:center">gdbport</td>
<td style="text-align:center">usr.sbin/bhyve/dbgport.c</td>
<td style="text-align:center">bind, listen, accept, read|write</td>
</tr>
<tr>
<td style="text-align:center">elcr</td>
<td style="text-align:center">usr.sbin/bhyve/dbgport.c</td>
<td style="text-align:center">dummy</td>
</tr>
<tr>
<td style="text-align:center">pit 8254</td>
<td style="text-align:center">usr.sbin/bhyve/pit_8254.c</td>
<td style="text-align:center">pit_8254_handler</td>
</tr>
<tr>
<td style="text-align:center">post</td>
<td style="text-align:center">usr.sbin/bhyve/post.c</td>
<td style="text-align:center">dummy</td>
</tr>
<tr>
<td style="text-align:center">rtc</td>
<td style="text-align:center">usr.sbin/bhyve/rtc.c</td>
<td style="text-align:center">rtc_addr_handler|rtc_data_handler</td>
</tr>
<tr>
<td style="text-align:center">uart</td>
<td style="text-align:center">usr.sbin/bhyve/uart.c</td>
<td style="text-align:center">dummy</td>
</tr>
<tr>
<td style="text-align:center">pci-dummy</td>
<td style="text-align:center">usr.sbin/bhyve/pci_emul.c</td>
<td style="text-align:center">pci_emul_dinit|pci_emul_diow|pci_emul_dior</td>
</tr>
<tr>
<td style="text-align:center">pci-hostbridge</td>
<td style="text-align:center">usr.sbin/bhyve/pci_hostbridge.c</td>
<td style="text-align:center">pci_hostbridge_init</td>
</tr>
<tr>
<td style="text-align:center">pci-passthru</td>
<td style="text-align:center">usr.sbin/bhyve/pci_passthru.c</td>
<td style="text-align:center">/dev/pci, /dev/io</td>
</tr>
<tr>
<td style="text-align:center">pci-uart</td>
<td style="text-align:center">usr.sbin/bhyve/pci_uart.c</td>
<td style="text-align:center">pci_uart_init|pci_uart_write|pci_uart_read</td>
</tr>
<tr>
<td style="text-align:center">pci-virtio-blk</td>
<td style="text-align:center">usr.sbin/bhyve/pci_virtio_block.c</td>
<td style="text-align:center">pci_vtblk_init|pci_vtblk_write|pci_vtblk_read</td>
</tr>
<tr>
<td style="text-align:center">pci-virtio-net</td>
<td style="text-align:center">usr.sbin/bhyve/pci_virtio_net.c</td>
<td style="text-align:center">pci_vtnet_init|pci_vtnet_write|pci_vtnet_read</td>
</tr>
</tbody>
</table>
<h3 id="virtual-device-initialization">Virtual device initialization</h3>
<pre class="hljs"><code><div>while (c = getopt())
	switch (c)
		case 's':
			pci_parse_slot(optarg, 0); // not legacy
			break;
		case 'S':
			pci_parse_slot(optarg, 1); // legacy
			break;
		// ------------------------------
		// pci_parse_slot
		// ------------------------------
		// snum is from 0 to 31
		// 0,hostbridge
		// 1,virtio-net,tap0
		// pci_slotinfo[snum].si_name = emul; // hostbridge, virtio-net
		// pci_slotinfo[snum].si_param = config; // null, tap0
		// pci_slotinfo[snum].si_legacy = legacy; // 0, 1
init_inout
	install handler for each port: atpic, console, gdbport, elcr, pci_emu, pit 8254, post, rtc, and uart.
init_pci
	// it depends on opts
	pde = pci_emul_finddev(si-&gt;si_name);
	if (pde != NULL) {
		pci_emul_init(ctx, pde, i, si-&gt;si_param); // invoke -&gt;init
</div></code></pre>
<h2 id="extend-btest-like-qtest-to-bhyve">Extend BTest (like QTest) to BHyve</h2>
<p>The basic idea of BTest is to implement the same primitives as QTest. We can
leverage PCI interfaces to implemented it because we are doing in-memory fuzzing
rather than doing traps.</p>
<p>[^1]: <a href="https://bhyve.org/">Homepage of Bhyve</a> <br>
[^2]: <a href="https://en.wikipedia.org/wiki/Bhyve">Wikipedia of Bhyve</a> <br>
[^3]: <a href="https://wiki.freebsd.org/bhyve">Q&amp;A of Byyve</a> <br>
[^4]: <a href="https://www.vpsee.com/2015/06/mac-os-x-hypervisor-xhyve-based-on-bhyve/">xhyve</a> <br>
[^5]: <a href="https://people.freebsd.org/~grehan/talks/eurobsdcon_2013_bhyve.pdf">Extending bhyve beyond FreeBD guests</a></p>

</body>
</html>
